["```py\n$ cd data\n$ pip install feather-format\n$ python prep-bulldozer.py \nCreated bulldozer-train-all.feather\nCreated bulldozer-train.feather\nCreated bulldozer-valid.feather\nCreated bulldozer-test.feather\n```", "```py\nimport pandas as pd\nimport numpy as np\nfrom sklearn.ensemble import RandomForestRegressor\nfrom rfpimp import *  # feature importance plot\n\n```", "```py\ndf_raw = pd.read_feather(\"data/bulldozer-train.feather\")\ndf = df_raw.copy()\n\n```", "```py\ndef sniff(df):\n    with pd.option_context(\"display.max_colwidth\", 20):\n        info = pd.DataFrame()\n        info['sample'] = df.iloc[0]\n        info['data type'] = df.dtypes\n        info['percent missing'] = df.isnull().sum()*100/len(df)\n        return info.sort_values('data type')\n\n```", "```py\nsniff(df).head(14)\n```", "```py\nprint(df['Tire_Size'].unique())\n```", "```py\nbasefeatures = ['SalesID', 'MachineID', 'ModelID',\n                'datasource', 'YearMade',\n                # some missing values but use anyway:\n                'auctioneerID', 'MachineHoursCurrentMeter']\n\n```", "```py\ndef test(X, y, n_estimators=50):\n    rf = RandomForestRegressor(n_estimators=n_estimators, n_jobs=-1, oob_score=True)\n    rf.fit(X, y)\n    oob = rf.oob_score_\n    n = rfnnodes(rf)\n    h = np.median(rfmaxdepths(rf))\n    print(f\"OOB R^2 {oob:.5f} using {n:,d} tree nodes with {h} median tree height\")\n    return rf, oob\n\n```", "```py\nX, y = df[basefeatures], df['SalePrice']\nX = X.fillna(0) # flip missing numeric values to zeros\nrf, oob_baseline_initial = test(X, y)\n\n```", "```py\ndf = df.iloc[-100_000:] # take only last 100,000 records\n\n```", "```py\nX, y = df[basefeatures], df['SalePrice']\nX = X.fillna(0)\nrf, oob_baseline = test(X, y)\n\n```", "```py\nI = importances(rf, X, y)\nplot_importances(I)\n```", "```py\ndel df['MachineID'] # dataset has inconsistencies\ndel df['SalesID']   # unique sales ID so not generalizer\n\n```", "```py\nprint(df['auctioneerID'].unique())\n```", "```py\ndf['auctioneerID'] = df['auctioneerID'].astype(str)\n\n```", "```py\nprint(df['ProductGroup'].unique())\n```", "```py\nprint(df['Drive_System'].unique())\n```", "```py\nprint(df['Backhoe_Mounting'].unique())\n```", "```py\nfrom pandas.api.types import is_string_dtype, is_object_dtype\ndef df_normalize_strings(df):\n    for col in df.columns:\n        if is_string_dtype(df[col]) or is_object_dtype(df[col]):\n            df[col] = df[col].str.lower()\n            df[col] = df[col].fillna(np.nan) # make None -> np.nan\n            df[col] = df[col].replace('none or unspecified', np.nan)\n            df[col] = df[col].replace('none', np.nan)\n            df[col] = df[col].replace('#name?', np.nan)\n            df[col] = df[col].replace('', np.nan)\n\n```", "```py\ndf_normalize_strings(df)\nprint(df['Drive_System'].unique())\nprint(df['Backhoe_Mounting'].unique())\n\n```", "```py\nprint(df['Tire_Size'].unique())\nprint(df['Undercarriage_Pad_Width'].unique())\n\n```", "```py\ndef extract_sizes(df, colname):\n    df[colname] = df[colname].str.extract(r'([0-9.]*)', expand=True)\n    df[colname] = df[colname].replace('', np.nan)\n    df[colname] = pd.to_numeric(df[colname])\n\n```", "```py\nextract_sizes(df, 'Tire_Size')\nextract_sizes(df, 'Undercarriage_Pad_Width')\nprint(df['Tire_Size'].unique())\nprint(df['Undercarriage_Pad_Width'].unique())\n\n```", "```py\nprint(df['Blade_Width'].unique())\nprint(df['Stick_Length'].unique())\n\n```", "```py\nfrom pandas.api.types import is_categorical_dtype\ndef df_string_to_cat(df):\n    for col in df.columns:\n        if is_string_dtype(df[col]):\n            df[col] = df[col].astype('category').cat.as_ordered()\n\ndef df_cat_to_catcode(df):\n    for col in df.columns:\n        if is_categorical_dtype(df[col]):\n            df[col] = df[col].cat.codes + 1\n\n```", "```py\ndf_toy = pd.DataFrame(data={'Name':['Xue',np.nan,'Tom']})\ndf_toy\n```", "```py\ndf_string_to_cat(df_toy)\ndf_toy['catcodes'] = df_toy['Name'].cat.codes\ndf_toy\n```", "```py\nprint(df_toy.dtypes)\n```", "```py\ndf_cat_to_catcode(df_toy)\ndf_toy\n```", "```py\ndf_string_to_cat(df)\ndf_cat_to_catcode(df)\ndf.head(2).T.head(10)\n```", "```py\ndef fix_missing_num(df, colname):\n    df[colname+'_na'] = pd.isnull(df[colname])\n    df[colname].fillna(df[colname].median(), inplace=True)\n\n```", "```py\ndf_toy = pd.DataFrame(data={'YearMade':[1995,2001,np.nan]})\ndf_toy\n```", "```py\nfix_missing_num(df_toy, 'YearMade')\ndf_toy\n```", "```py\nprint(f\"Values {df['Tire_Size'].unique()}\")\nprint(f\"Median {df['Tire_Size'].median()}\")\n\n```", "```py\ndf[['Tire_Size']].head(6)\n```", "```py\nfix_missing_num(df, 'Tire_Size')\ndf[['Tire_Size']].head(6)\n```", "```py\nfix_missing_num(df, 'Undercarriage_Pad_Width')\n\n```", "```py\ndf_small = df.sample(n=5_000) # don't draw too many dots\ndf_small.plot.scatter('YearMade','SalePrice', alpha=0.02, c=bookcolors['blue'])\n```", "```py\n# There are some unlikely 1919, 1920 values too\n# Assume < 1950 is \"unknown\"\ndf.loc[df.YearMade<1950, 'YearMade'] = np.nan\nfix_missing_num(df, 'YearMade')\n\n```", "```py\ninverted = df.query(\"saledate.dt.year < YearMade\")[['SalePrice','YearMade','saledate']]\ninverted\n```", "```py\ndf.loc[df.eval(\"saledate.dt.year < YearMade\"), 'YearMade'] = df['saledate'].dt.year\n\n```", "```py\ndf.query(\"MachineHoursCurrentMeter==0\")['YearMade'].plot.hist(bins=30)\n```", "```py\ndf.loc[df.eval(\"MachineHoursCurrentMeter==0\"),\n       'MachineHoursCurrentMeter'] = np.nan\nfix_missing_num(df, 'MachineHoursCurrentMeter')\n\n```", "```py\ndf[df.columns[-3:]].head(5)\n```", "```py\nX, y = df.drop(['SalePrice','saledate'], axis=1), df['SalePrice']\nrf, oob_all = test(X, y)\n\n```", "```py\ndf = df.reset_index(drop=True)\ndf.to_feather(\"data/bulldozer-train-clean.feather\")\n\n```"]