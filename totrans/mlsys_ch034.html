<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <title>ch034.xhtml</title>
  <style>
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css" />
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    padding-bottom: 0.5rem;
    margin-bottom: 0;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    /* Figure formatting */
    .quarto-layout-panel>figure>figcaption,
    .quarto-layout-panel>.panel-caption {
      margin-top: 10pt;
    }

    .quarto-layout-row {
      display: flex;
      align-items: flex-start;
    }

    .quarto-layout-valign-top {
      align-items: flex-start;
    }

    .quarto-layout-valign-bottom {
      align-items: flex-end;
    }

    .quarto-layout-valign-center {
      align-items: center;
    }

    .quarto-layout-cell {
      position: relative;
      margin-right: 20px;
    }

    .quarto-layout-cell:last-child {
      margin-right: 0;
    }

    .quarto-layout-cell figure,
    .quarto-layout-cell>p {
      margin: 0.2em;
    }

    .quarto-layout-cell .html-widget {
      width: 100% !important;
    }

    .quarto-layout-cell div figure p {
      margin: 0;
    }

    .quarto-layout-cell figure {
      display: inline-block;
      margin-inline-start: 0;
      margin-inline-end: 0;
    }

    .quarto-layout-cell table {
      display: inline-table;
    }

    .quarto-layout-cell-subref figcaption {
      font-style: italic;
      text-align: center;
    }

    .quarto-figure>figure {
      width: 100%;
    }

    .quarto-figure-left>figure>p {
      text-align: left;
    }

    .quarto-figure-center>figure>p {
      text-align: center;
    }

    .quarto-figure-right>figure>p {
      text-align: right;
    }

    figure>p:empty {
      display: none;
    }

    figure>p:first-child {
      margin-top: 0;
      margin-bottom: 0;
    }

    figure>figcaption {
      margin-top: 0.5em;
    }

    figcaption {
      font-size: 0.8em;
    }

    details {
      margin-bottom: 1em;
    }

    details[show] {
      margin-bottom: 0;
    }

    .quarto-unresolved-ref {
      font-weight: 600;
    }

    .quarto-cover-image {
      float: right;
      margin-left: 30px;
    }

    .cell-output-display {
      overflow-x: scroll;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body epub:type="bodymatter">
<section id="object-detection" class="level1 unnumbered">
<h1 class="unnumbered">Object Detection</h1>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="../media/file412.jpg" alt="" /></p>
<figcaption><em>DALL·E 3 Prompt: Cartoon in the style of the 1940s or 1950s showcasing a spacious industrial warehouse interior. A conveyor belt is prominently featured, carrying a mixture of toy wheels and boxes. The wheels are distinguishable with their bright yellow centers and black tires. The boxes are white cubes painted with alternating black and white patterns. At the end of the moving conveyor stands a retro-styled robot, equipped with tools and sensors, diligently classifying and counting the arriving wheels and boxes. The overall aesthetic is reminiscent of mid-century animation with bold lines and a classic color palette.</em></figcaption>
</figure>
</div>
<section id="sec-object-detection-overview-9d59" class="level2 unnumbered">
<h2 class="unnumbered">Overview</h2>
<p>This continuation of Image Classification on Nicla Vision is now exploring <strong>Object Detection</strong>.</p>
<p> <img src="../media/file413.png" class="quarto-figure quarto-figure-center" style="width:100.0%" alt="" /></p>
<section id="sec-object-detection-object-detection-versus-image-classification-f7ff" class="level3 unnumbered">
<h3 class="unnumbered">Object Detection versus Image Classification</h3>
<p>The main task with Image Classification models is to produce a list of the most probable object categories present on an image, for example, to identify a tabby cat just after his dinner:</p>
<p> <img src="../media/file414.png" class="quarto-figure quarto-figure-center" style="width:45.0%" alt="" /></p>
<p>But what happens when the cat jumps near the wine glass? The model still only recognizes the predominant category on the image, the tabby cat:</p>
<p> <img src="../media/file415.png" class="quarto-figure quarto-figure-center" style="width:45.0%" alt="" /></p>
<p>And what happens if there is not a dominant category on the image?</p>
<p> <img src="../media/file416.png" class="quarto-figure quarto-figure-center" style="width:60.0%" alt="" /></p>
<p>The model identifies the above image utterly wrong as an “ashcan,” possibly due to the color tonalities.</p>
<blockquote>
<p>The model used in all previous examples is MobileNet, which was trained with a large dataset, <em>ImageNet</em>.</p>
</blockquote>
<p>To solve this issue, we need another type of model, where not only <strong>multiple categories</strong> (or labels) can be found but also <strong>where</strong> the objects are located on a given image.</p>
<p>As we can imagine, such models are much more complicated and bigger, for example, the <strong>MobileNetV2 SSD FPN-Lite 320x320, trained with the COCO dataset.</strong> This pre-trained object detection model is designed to locate up to 10 objects within an image, outputting a bounding box for each object detected. The below image is the result of such a model running on a Raspberry Pi:</p>
<p> <img src="../media/file417.png" class="quarto-figure quarto-figure-center" style="width:65.0%" alt="" /></p>
<p>Those models used for object detection (such as the MobileNet SSD or YOLO) usually have several MB in size, which is OK for Raspberry Pi but unsuitable for use with embedded devices, where the RAM is usually lower than 1 Mbyte.</p>
</section>
<section id="sec-object-detection-innovative-solution-object-detection-fomo-7439" class="level3 unnumbered">
<h3 class="unnumbered">An innovative solution for Object Detection: FOMO</h3>
<p><a href="https://docs.edgeimpulse.com/docs/edge-impulse-studio/learning-blocks/object-detection/fomo-object-detection-for-constrained-devices">Edge Impulse launched in 2022, <strong>FOMO</strong> (Faster Objects, More Objects)</a>, a novel solution for performing object detection on embedded devices, not only on the Nicla Vision (Cortex M7) but also on Cortex M4F CPUs (Arduino Nano33 and OpenMV M4 series) and the Espressif ESP32 devices (ESP-CAM and XIAO ESP32S3 Sense).</p>
<p>In this Hands-On lab, we will explore using FOMO with Object Detection, not entering many details about the model itself. To understand more about how the model works, you can go into the <a href="https://www.edgeimpulse.com/blog/announcing-fomo-faster-objects-more-objects">official FOMO announcement</a> by Edge Impulse, where Louis Moreau and Mat Kelcey explain in detail how it works.</p>
</section>
</section>
<section id="sec-object-detection-object-detection-project-goal-c7c4" class="level2 unnumbered">
<h2 class="unnumbered">The Object Detection Project Goal</h2>
<p>All Machine Learning projects need to start with a detailed goal. Let’s assume we are in an industrial facility and must sort and count <strong>wheels</strong> and special <strong>boxes</strong>.</p>
<p> <img src="../media/file418.jpg" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p>In other words, we should perform a multi-label classification, where each image can have three classes:</p>
<ul>
<li><p>Background (No objects)</p></li>
<li><p>Box</p></li>
<li><p>Wheel</p></li>
</ul>
<p>Here are some not labeled image samples that we should use to detect the objects (wheels and boxes):</p>
<p> <img src="../media/file419.jpg" style="width:100.0%" alt="" /></p>
<p>We are interested in which object is in the image, its location (centroid), and how many we can find on it. The object’s size is not detected with FOMO, as with MobileNet SSD or YOLO, where the Bounding Box is one of the model outputs.</p>
<p>We will develop the project using the Nicla Vision for image capture and model inference. The ML project will be developed using the Edge Impulse Studio. But before starting the object detection project in the Studio, let’s create a <em>raw dataset</em> (not labeled) with images that contain the objects to be detected.</p>
</section>
<section id="sec-object-detection-data-collection-1466" class="level2 unnumbered">
<h2 class="unnumbered">Data Collection</h2>
<p>For image capturing, we can use:</p>
<ul>
<li>Web Serial Camera tool,</li>
<li>Edge Impulse Studio,</li>
<li>OpenMV IDE,</li>
<li>A smartphone.</li>
</ul>
<p>Here, we will use the <strong>OpenMV IDE</strong>.</p>
<section id="sec-object-detection-collecting-dataset-openmv-ide-a44e" class="level3 unnumbered">
<h3 class="unnumbered">Collecting Dataset with OpenMV IDE</h3>
<p>First, we create a folder on the computer where the data will be saved, for example, “data.” Next, on the OpenMV IDE, we go to Tools &gt; Dataset Editor and select New Dataset to start the dataset collection:</p>
<p> <img src="../media/file420.jpg" class="quarto-figure quarto-figure-center" style="width:100.0%" alt="" /></p>
<p>Edge impulse suggests that the objects should be similar in size and not overlap for better performance. This is OK in an industrial facility, where the camera should be fixed, keeping the same distance from the objects to be detected. Despite that, we will also try using mixed sizes and positions to see the result.</p>
<blockquote>
<p>We will not create separate folders for our images because each contains multiple labels.</p>
</blockquote>
<p>Connect the Nicla Vision to the OpenMV IDE and run the <code>dataset_capture_script.py</code>. Clicking on the Capture Image button will start capturing images:</p>
<p> <img src="../media/file421.jpg" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p>We suggest using around 50 images to mix the objects and vary the number of each appearing on the scene. Try to capture different angles, backgrounds, and light conditions.</p>
<blockquote>
<p>The stored images use a QVGA frame size <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>320</mn><mo>×</mo><mn>240</mn></mrow><annotation encoding="application/x-tex">320\times 240</annotation></semantics></math> and RGB565 (color pixel format).</p>
</blockquote>
<p>After capturing your dataset, close the Dataset Editor Tool on the <code>Tools &gt; Dataset Editor</code>.</p>
</section>
</section>
<section id="sec-object-detection-edge-impulse-studio-a4c2" class="level2 unnumbered">
<h2 class="unnumbered">Edge Impulse Studio</h2>
<section id="sec-object-detection-setup-project-865c" class="level3 unnumbered">
<h3 class="unnumbered">Setup the project</h3>
<p>Go to <a href="https://www.edgeimpulse.com/">Edge Impulse Studio,</a> enter your credentials at <strong>Login</strong> (or create an account), and start a new project.</p>
<blockquote>
<p>Here, you can clone the project developed for this hands-on: <a href="https://studio.edgeimpulse.com/public/292737/latest">NICLA_Vision_Object_Detection</a>.</p>
</blockquote>
<p>On the Project <code>Dashboard</code>, go to <strong>Project info</strong> and select <strong>Bounding boxes (object detection),</strong> and at the right-top of the page, select <code>Target</code>, <strong>Arduino Nicla Vision (Cortex-M7)</strong>.</p>
<p> <img src="../media/file422.png" class="quarto-figure quarto-figure-center" style="width:95.0%" alt="" /></p>
</section>
<section id="sec-object-detection-uploading-unlabeled-data-0602" class="level3 unnumbered">
<h3 class="unnumbered">Uploading the unlabeled data</h3>
<p>On Studio, go to the <code>Data acquisition</code> tab, and on the <code>UPLOAD DATA</code> section, upload from your computer files captured.</p>
<p> <img src="../media/file423.png" class="quarto-figure quarto-figure-center" style="width:95.0%" alt="" /></p>
<blockquote>
<p>You can leave for the Studio to split your data automatically between Train and Test or do it manually.</p>
</blockquote>
<p> <img src="../media/file424.png" class="quarto-figure quarto-figure-center" style="width:95.0%" alt="" /></p>
<p>All the unlabeled images (51) were uploaded, but they still need to be labeled appropriately before being used as a dataset in the project. The Studio has a tool for that purpose, which you can find in the link <code>Labeling queue (51)</code>.</p>
<p>There are two ways you can use to perform AI-assisted labeling on the Edge Impulse Studio (free version):</p>
<ul>
<li>Using yolov5</li>
<li>Tracking objects between frames</li>
</ul>
<blockquote>
<p>Edge Impulse launched an <a href="https://docs.edgeimpulse.com/docs/edge-impulse-studio/data-acquisition/auto-labeler">auto-labeling feature</a> for Enterprise customers, easing labeling tasks in object detection projects.</p>
</blockquote>
<p>Ordinary objects can quickly be identified and labeled using an existing library of pre-trained object detection models from YOLOv5 (trained with the COCO dataset). But since, in our case, the objects are not part of COCO datasets, we should select the option of <code>tracking objects</code>. With this option, once you draw bounding boxes and label the images in one frame, the objects will be tracked automatically from frame to frame, <em>partially</em> labeling the new ones (not all are correctly labeled).</p>
<blockquote>
<p>If you already have a labeled dataset containing bounding boxes, import your data using the EI uploader.</p>
</blockquote>
</section>
<section id="sec-object-detection-labeling-dataset-f95b" class="level3 unnumbered">
<h3 class="unnumbered">Labeling the Dataset</h3>
<p>Starting with the first image of your unlabeled data, use your mouse to drag a box around an object to add a label. Then click <strong>Save labels</strong> to advance to the next item.</p>
<p> <img src="../media/file425.png" alt="" /></p>
<p>Continue with this process until the queue is empty. At the end, all images should have the objects labeled as those samples below:</p>
<p> <img src="../media/file426.jpg" alt="" /></p>
<p>Next, review the labeled samples on the <code>Data acquisition</code> tab. If one of the labels is wrong, it can be edited using the <em><code>three dots</code></em> menu after the sample name:</p>
<p> <img src="../media/file427.png" alt="" /></p>
<p>We will be guided to replace the wrong label and correct the dataset.</p>
<p> <img src="../media/file428.jpg" alt="" /></p>
</section>
</section>
<section id="sec-object-detection-impulse-design-22bf" class="level2 unnumbered">
<h2 class="unnumbered">The Impulse Design</h2>
<p>In this phase, we should define how to:</p>
<ul>
<li><p><strong>Pre-processing</strong> consists of resizing the individual images from <code>320 x 240</code> to <code>96 x 96</code> and squashing them (squared form, without cropping). Afterward, the images are converted from RGB to Grayscale.</p></li>
<li><p><strong>Design a Model,</strong> in this case, “Object Detection.”</p></li>
</ul>
<p> <img src="../media/file429.png" alt="" /></p>
<section id="sec-object-detection-preprocessing-dataset-e0fc" class="level3 unnumbered">
<h3 class="unnumbered">Preprocessing all dataset</h3>
<p>In this section, select <strong>Color depth</strong> as <code>Grayscale</code>, suitable for use with FOMO models and Save <code>parameters</code>.</p>
<p> <img src="../media/file430.png" alt="" /></p>
<p>The Studio moves automatically to the next section, <code>Generate features</code>, where all samples will be pre-processed, resulting in a dataset with individual <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>96</mn><mo>×</mo><mn>96</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">96\times 96\times 1</annotation></semantics></math> images or 9,216 features.</p>
<p> <img src="../media/file431.png" alt="" /></p>
<p>The feature explorer shows that all samples evidence a good separation after the feature generation.</p>
<blockquote>
<p>One of the samples (46) is apparently in the wrong space, but clicking on it confirms that the labeling is correct.</p>
</blockquote>
</section>
</section>
<section id="sec-object-detection-model-design-training-test-c561" class="level2 unnumbered">
<h2 class="unnumbered">Model Design, Training, and Test</h2>
<p>We will use FOMO, an object detection model based on MobileNetV2 (alpha 0.35) designed to coarsely segment an image into a grid of <strong>background</strong> vs <strong>objects of interest</strong> (here, <em>boxes</em> and <em>wheels</em>).</p>
<p>FOMO is an innovative machine learning model for object detection, which can use up to 30 times less energy and memory than traditional models like Mobilenet SSD and YOLOv5. FOMO can operate on microcontrollers with less than 200 KB of RAM. The main reason this is possible is that while other models calculate the object’s size by drawing a square around it (bounding box), FOMO ignores the size of the image, providing only the information about where the object is located in the image, by means of its centroid coordinates.</p>
<section id="sec-object-detection-fomo-works-155a" class="level3 unnumbered">
<h3 class="unnumbered">How FOMO works?</h3>
<p>FOMO takes the image in grayscale and divides it into blocks of pixels using a factor of 8. For the input of 96x96, the grid would be <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mo>×</mo><mn>12</mn></mrow><annotation encoding="application/x-tex">12\times 12</annotation></semantics></math> <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>96</mn><mi>/</mi><mn>8</mn><mo>=</mo><mn>12</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(96/8=12)</annotation></semantics></math>. Next, FOMO will run a classifier through each pixel block to calculate the probability that there is a box or a wheel in each of them and, subsequently, determine the regions that have the highest probability of containing the object (If a pixel block has no objects, it will be classified as <em>background</em>). From the overlap of the final region, the FOMO provides the coordinates (related to the image dimensions) of the centroid of this region.</p>
<p> <img src="../media/file432.png" alt="" /></p>
<p>For training, we should select a pre-trained model. Let’s use the <strong><code>FOMO (Faster Objects, More Objects) MobileNetV2 0.35</code>.</strong> This model uses around 250 KB of RAM and 80 KB of ROM (Flash), which suits well with our board since it has 1 MB of RAM and ROM.</p>
<p> <img src="../media/file433.png" class="quarto-figure quarto-figure-center" style="width:80.0%" alt="" /></p>
<p>Regarding the training hyper-parameters, the model will be trained with:</p>
<ul>
<li>Epochs: 60,</li>
<li>Batch size: 32</li>
<li>Learning Rate: 0.001.</li>
</ul>
<p>For validation during training, 20% of the dataset (<em>validation_dataset</em>) will be spared. For the remaining 80% (<em>train_dataset</em>), we will apply Data Augmentation, which will randomly flip, change the size and brightness of the image, and crop them, artificially increasing the number of samples on the dataset for training.</p>
<p>As a result, the model ends with an F1 score of around 91% (validation) and 93% (test data).</p>
<blockquote>
<p>Note that FOMO automatically added a 3rd label background to the two previously defined (<em>box</em> and <em>wheel</em>).</p>
</blockquote>
<p> <img src="../media/file434.png" class="quarto-figure quarto-figure-center" style="width:80.0%" alt="" /></p>
<blockquote>
<p>In object detection tasks, accuracy is generally not the primary <a href="https://learnopencv.com/mean-average-precision-map-object-detection-model-evaluation-metric/">evaluation metric</a>. Object detection involves classifying objects and providing bounding boxes around them, making it a more complex problem than simple classification. The issue is that we do not have the bounding box, only the centroids. In short, using accuracy as a metric could be misleading and may not provide a complete understanding of how well the model is performing. Because of that, we will use the F1 score.</p>
</blockquote>
</section>
<section id="sec-object-detection-test-model-live-classification-2f99" class="level3 unnumbered">
<h3 class="unnumbered">Test model with “Live Classification”</h3>
<p>Since Edge Impulse officially supports the Nicla Vision, let’s connect it to the Studio. For that, follow the steps:</p>
<ul>
<li><p>Download the <a href="https://cdn.edgeimpulse.com/firmware/arduino-nicla-vision.zip">last EI Firmware</a> and unzip it.</p></li>
<li><p>Open the zip file on your computer and select the uploader related to your OS</p></li>
<li><p>Put the Nicla-Vision on Boot Mode, pressing the reset button twice.</p></li>
<li><p>Execute the specific batch code for your OS to upload the binary (<code>arduino-nicla-vision.bin</code>) to your board.</p></li>
</ul>
<p>Go to <code>Live classification</code> section at EI Studio, and using <em>webUSB,</em> connect your Nicla Vision:</p>
<p> <img src="../media/file435.png" alt="" /></p>
<p>Once connected, you can use the Nicla to capture actual images to be tested by the trained model on Edge Impulse Studio.</p>
<p> <img src="../media/file436.png" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p>One thing to note is that the model can produce false positives and negatives. This can be minimized by defining a proper <code>Confidence Threshold</code> (use the <code>three dots</code> menu for the setup). Try with 0.8 or more.</p>
</section>
</section>
<section id="sec-object-detection-deploying-model-0320" class="level2 unnumbered">
<h2 class="unnumbered">Deploying the Model</h2>
<p>Select <code>OpenMV Firmware</code> on the Deploy Tab and press <code>[Build]</code>.</p>
<p> <img src="../media/file437.png" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p>When you try to connect the Nicla with the OpenMV IDE again, it will try to update its FW. Choose the option <code>Load a specific firmware</code> instead. Or go to `Tools &gt; Runs Bootloader (Load Firmware).</p>
<p> <img src="../media/file438.png" class="quarto-figure quarto-figure-center" style="width:65.0%" alt="" /></p>
<p>You will find a ZIP file on your computer from the Studio. Open it:</p>
<p> <img src="../media/file439.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>Load the .bin file to your board:</p>
<p> <img src="../media/file440.png" class="quarto-figure quarto-figure-center" style="width:65.0%" alt="" /></p>
<p>After the download is finished, a pop-up message will be displayed. <code>Press OK</code>, and open the script <strong>ei_object_detection.py</strong> downloaded from the Studio.</p>
<blockquote>
<p>Note: If a Pop-up appears saying that the FW is out of date, press <code>[NO]</code>, to upgrade it.</p>
</blockquote>
<p>Before running the script, let’s change a few lines. Note that you can leave the window definition as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>240</mn><mo>×</mo><mn>240</mn></mrow><annotation encoding="application/x-tex">240\times 240</annotation></semantics></math> and the camera capturing images as QVGA/RGB. The captured image will be pre-processed by the FW deployed from Edge Impulse</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> sensor</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> time</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> ml</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">from</span> ml.utils <span class="im">import</span> NMS</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> math</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">import</span> image</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>sensor.reset()  <span class="co"># Reset and initialize the sensor.</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"># Set pixel format (RGB565 or GRAYSCALE)</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>sensor.set_pixformat(sensor.RGB565)</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># Set frame size to QVGA (320x240)</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>sensor.set_framesize(sensor.QVGA)</span>
<span id="cb1-13"><a href="#cb1-13"></a>sensor.skip_frames(time<span class="op">=</span><span class="dv">2000</span>)  <span class="co"># Let the camera adjust.</span></span></code></pre></div>
<p>Redefine the minimum confidence, for example, to 0.8 to minimize false positives and negatives.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>min_confidence <span class="op">=</span> <span class="fl">0.8</span></span></code></pre></div>
<p>Change if necessary, the color of the circles that will be used to display the detected object’s centroid for a better contrast.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>threshold_list <span class="op">=</span> [(math.ceil(min_confidence <span class="op">*</span> <span class="dv">255</span>), <span class="dv">255</span>)]</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># Load built-in model</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>model <span class="op">=</span> ml.Model(<span class="st">&quot;trained&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="bu">print</span>(model)</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># Alternatively, models can be loaded from the</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co"># filesystem storage.</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"># model = ml.Model(</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#     &#39;&lt;object_detection_modelwork&gt;.tflite&#39;,</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">#     load_to_fb=True)</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co"># labels = [line.rstrip(&#39;\n&#39;) for line in open(&quot;labels.txt&quot;)]</span></span>
<span id="cb3-13"><a href="#cb3-13"></a></span>
<span id="cb3-14"><a href="#cb3-14"></a>colors <span class="op">=</span> [ <span class="co"># Add more colors if you are detecting more</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>           <span class="co"># than 7 types of classes at once.</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>    (<span class="dv">255</span>, <span class="dv">255</span>,   <span class="dv">0</span>), <span class="co"># background: yellow (not used)</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>    (  <span class="dv">0</span>, <span class="dv">255</span>,   <span class="dv">0</span>), <span class="co"># cube: green</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>    (<span class="dv">255</span>,   <span class="dv">0</span>,   <span class="dv">0</span>), <span class="co"># wheel: red</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>    (  <span class="dv">0</span>,   <span class="dv">0</span>, <span class="dv">255</span>), <span class="co"># not used</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>    (<span class="dv">255</span>,   <span class="dv">0</span>, <span class="dv">255</span>), <span class="co"># not used</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>    (  <span class="dv">0</span>, <span class="dv">255</span>, <span class="dv">255</span>), <span class="co"># not used</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>    (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>), <span class="co"># not used</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>]</span></code></pre></div>
<p>Keep the remaining code as it is</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># FOMO outputs an image per class where each pixel in the</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># image is the centroid of the trained object. So, we will</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># get those output images and then run find_blobs() on them</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># to extract the centroids. We will also run get_stats() on</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># the detected blobs to determine their score.</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># The Non-Max-Suppression (NMS) object then filters out</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># overlapping detections and maps their position in the</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co"># output image back to the original input image. The</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># function then returns a list per class which each contain</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co"># a list of (rect, score) tuples representing the detected</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co"># objects.</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="kw">def</span> fomo_post_process(model, inputs, outputs):</span>
<span id="cb4-15"><a href="#cb4-15"></a>    n, oh, ow, oc <span class="op">=</span> model.output_shape[<span class="dv">0</span>]</span>
<span id="cb4-16"><a href="#cb4-16"></a>    nms <span class="op">=</span> NMS(ow, oh, inputs[<span class="dv">0</span>].roi)</span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(oc):</span>
<span id="cb4-18"><a href="#cb4-18"></a>        img <span class="op">=</span> image.Image(outputs[<span class="dv">0</span>][<span class="dv">0</span>, :, :, i] <span class="op">*</span> <span class="dv">255</span>)</span>
<span id="cb4-19"><a href="#cb4-19"></a>        blobs <span class="op">=</span> img.find_blobs(</span>
<span id="cb4-20"><a href="#cb4-20"></a>            threshold_list,</span>
<span id="cb4-21"><a href="#cb4-21"></a>            x_stride<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-22"><a href="#cb4-22"></a>            area_threshold<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-23"><a href="#cb4-23"></a>            pixels_threshold<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-24"><a href="#cb4-24"></a>        )</span>
<span id="cb4-25"><a href="#cb4-25"></a>        <span class="cf">for</span> b <span class="kw">in</span> blobs:</span>
<span id="cb4-26"><a href="#cb4-26"></a>            rect <span class="op">=</span> b.rect()</span>
<span id="cb4-27"><a href="#cb4-27"></a>            x, y, w, h <span class="op">=</span> rect</span>
<span id="cb4-28"><a href="#cb4-28"></a>            score <span class="op">=</span> (</span>
<span id="cb4-29"><a href="#cb4-29"></a>                img.get_statistics(</span>
<span id="cb4-30"><a href="#cb4-30"></a>                    thresholds<span class="op">=</span>threshold_list, roi<span class="op">=</span>rect</span>
<span id="cb4-31"><a href="#cb4-31"></a>                ).l_mean()</span>
<span id="cb4-32"><a href="#cb4-32"></a>                <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>            )</span>
<span id="cb4-34"><a href="#cb4-34"></a>            nms.add_bounding_box(x, y, x <span class="op">+</span> w, y <span class="op">+</span> h, score, i)</span>
<span id="cb4-35"><a href="#cb4-35"></a>    <span class="cf">return</span> nms.get_bounding_boxes()</span>
<span id="cb4-36"><a href="#cb4-36"></a></span>
<span id="cb4-37"><a href="#cb4-37"></a></span>
<span id="cb4-38"><a href="#cb4-38"></a>clock <span class="op">=</span> time.clock()</span>
<span id="cb4-39"><a href="#cb4-39"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb4-40"><a href="#cb4-40"></a>    clock.tick()</span>
<span id="cb4-41"><a href="#cb4-41"></a></span>
<span id="cb4-42"><a href="#cb4-42"></a>    img <span class="op">=</span> sensor.snapshot()</span>
<span id="cb4-43"><a href="#cb4-43"></a></span>
<span id="cb4-44"><a href="#cb4-44"></a>    <span class="cf">for</span> i, detection_list <span class="kw">in</span> <span class="bu">enumerate</span>(</span>
<span id="cb4-45"><a href="#cb4-45"></a>        model.predict([img], callback<span class="op">=</span>fomo_post_process)</span>
<span id="cb4-46"><a href="#cb4-46"></a>    ):</span>
<span id="cb4-47"><a href="#cb4-47"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-48"><a href="#cb4-48"></a>            <span class="cf">continue</span>  <span class="co"># background class</span></span>
<span id="cb4-49"><a href="#cb4-49"></a>        <span class="cf">if</span> <span class="bu">len</span>(detection_list) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-50"><a href="#cb4-50"></a>            <span class="cf">continue</span>  <span class="co"># no detections for this class?</span></span>
<span id="cb4-51"><a href="#cb4-51"></a></span>
<span id="cb4-52"><a href="#cb4-52"></a>        <span class="bu">print</span>(<span class="st">&quot;********** </span><span class="sc">%s</span><span class="st"> **********&quot;</span> <span class="op">%</span> model.labels[i])</span>
<span id="cb4-53"><a href="#cb4-53"></a>        <span class="cf">for</span> (x, y, w, h), score <span class="kw">in</span> detection_list:</span>
<span id="cb4-54"><a href="#cb4-54"></a>            center_x <span class="op">=</span> math.floor(x <span class="op">+</span> (w <span class="op">/</span> <span class="dv">2</span>))</span>
<span id="cb4-55"><a href="#cb4-55"></a>            center_y <span class="op">=</span> math.floor(y <span class="op">+</span> (h <span class="op">/</span> <span class="dv">2</span>))</span>
<span id="cb4-56"><a href="#cb4-56"></a>            <span class="bu">print</span>(<span class="ss">f&quot;x </span><span class="sc">{</span>center_x<span class="sc">}</span><span class="ch">\t</span><span class="ss">y </span><span class="sc">{</span>center_y<span class="sc">}</span><span class="ch">\t</span><span class="ss">score </span><span class="sc">{</span>score<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-57"><a href="#cb4-57"></a>            img.draw_circle((center_x, center_y, <span class="dv">12</span>), color<span class="op">=</span>colors[i])</span>
<span id="cb4-58"><a href="#cb4-58"></a></span>
<span id="cb4-59"><a href="#cb4-59"></a>    <span class="bu">print</span>(clock.fps(), <span class="st">&quot;fps&quot;</span>, end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<p>and press the <code>green Play button</code> to run the code:</p>
<p> <img src="../media/file441.png" alt="" /></p>
<p>From the camera’s view, we can see the objects with their centroids marked with 12 pixel-fixed circles (each circle has a distinct color, depending on its class). On the Serial Terminal, the model shows the labels detected and their position on the image window <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>240</mn><mo>×</mo><mn>240</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(240\times 240)</annotation></semantics></math>.</p>
<blockquote>
<p>Be aware that the coordinate origin is in the upper left corner.</p>
</blockquote>
<p> <img src="../media/file442.jpg" class="quarto-figure quarto-figure-center" style="width:75.0%" alt="" /></p>
<p>Note that the frames per second rate is around 8 fps (similar to what we got with the Image Classification project). This happens because FOMO is cleverly built over a CNN model, not with an object detection model like the SSD MobileNet or YOLO. For example, when running a MobileNetV2 SSD FPN-Lite <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>320</mn><mo>×</mo><mn>320</mn></mrow><annotation encoding="application/x-tex">320\times 320</annotation></semantics></math> model on a Raspberry Pi 4, the latency is around 5 times higher (around 1.5 fps)</p>
<p>Here is a short video showing the inference results: <a href="https://youtu.be/JbpoqRp3BbM">https://youtu.be/JbpoqRp3BbM</a></p>
</section>
<section id="sec-object-detection-summary-b971" class="level2 unnumbered">
<h2 class="unnumbered">Summary</h2>
<p>FOMO is a significant leap in the image processing space, as Louis Moreau and Mat Kelcey put it during its launch in 2022:</p>
<blockquote>
<p>FOMO is a ground-breaking algorithm that brings real-time object detection, tracking, and counting to microcontrollers for the first time.</p>
</blockquote>
<p>Multiple possibilities exist for exploring object detection (and, more precisely, counting them) on embedded devices. This can be very useful on projects counting bees, for example.</p>
<p> <img src="../media/file443.jpg" class="quarto-figure quarto-figure-center" style="width:70.0%" alt="" /></p>
</section>
<section id="sec-object-detection-resources-93b2" class="level2 unnumbered">
<h2 class="unnumbered">Resources</h2>
<ul>
<li><a href="https://studio.edgeimpulse.com/public/292737/latest">Edge Impulse Project</a></li>
</ul>
</section>
</section>
</body>
</html>
