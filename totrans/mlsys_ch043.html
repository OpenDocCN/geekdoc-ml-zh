<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <title>ch043.xhtml</title>
  <style>
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css" />
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    padding-bottom: 0.5rem;
    margin-bottom: 0;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    /* Figure formatting */
    .quarto-layout-panel>figure>figcaption,
    .quarto-layout-panel>.panel-caption {
      margin-top: 10pt;
    }

    .quarto-layout-row {
      display: flex;
      align-items: flex-start;
    }

    .quarto-layout-valign-top {
      align-items: flex-start;
    }

    .quarto-layout-valign-bottom {
      align-items: flex-end;
    }

    .quarto-layout-valign-center {
      align-items: center;
    }

    .quarto-layout-cell {
      position: relative;
      margin-right: 20px;
    }

    .quarto-layout-cell:last-child {
      margin-right: 0;
    }

    .quarto-layout-cell figure,
    .quarto-layout-cell>p {
      margin: 0.2em;
    }

    .quarto-layout-cell .html-widget {
      width: 100% !important;
    }

    .quarto-layout-cell div figure p {
      margin: 0;
    }

    .quarto-layout-cell figure {
      display: inline-block;
      margin-inline-start: 0;
      margin-inline-end: 0;
    }

    .quarto-layout-cell table {
      display: inline-table;
    }

    .quarto-layout-cell-subref figcaption {
      font-style: italic;
      text-align: center;
    }

    .quarto-figure>figure {
      width: 100%;
    }

    .quarto-figure-left>figure>p {
      text-align: left;
    }

    .quarto-figure-center>figure>p {
      text-align: center;
    }

    .quarto-figure-right>figure>p {
      text-align: right;
    }

    figure>p:empty {
      display: none;
    }

    figure>p:first-child {
      margin-top: 0;
      margin-bottom: 0;
    }

    figure>figcaption {
      margin-top: 0.5em;
    }

    figcaption {
      font-size: 0.8em;
    }

    details {
      margin-bottom: 1em;
    }

    details[show] {
      margin-bottom: 0;
    }

    .quarto-unresolved-ref {
      font-weight: 600;
    }

    .quarto-cover-image {
      float: right;
      margin-left: 30px;
    }

    .cell-output-display {
      overflow-x: scroll;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body epub:type="bodymatter">
<section id="motion-classification-and-anomaly-detection-1" class="level1 unnumbered">
<h1 class="unnumbered">Motion Classification and Anomaly Detection</h1>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="../media/file664.jpg" alt="" /></p>
<figcaption>DALL·E prompt - 1950s style cartoon illustration set in a vintage audio lab. Scientists, dressed in classic attire with white lab coats, are intently analyzing audio data on large chalkboards. The boards display intricate FFT (Fast Fourier Transform) graphs and time-domain curves. Antique audio equipment is scattered around, but the data representations are clear and detailed, indicating their focus on audio analysis.</figcaption>
</figure>
</div>
<section id="sec-motion-classification-anomaly-detection-overview-cb1f" class="level2 unnumbered">
<h2 class="unnumbered">Overview</h2>
<p>Transportation is the backbone of global commerce. Millions of containers are transported daily via various means, such as ships, trucks, and trains, to destinations worldwide. Ensuring the safe and efficient transit of these containers is a monumental task that requires leveraging modern technology, and TinyML is undoubtedly one of the key solutions.</p>
<p>In this hands-on lab, we will work to solve real-world problems related to transportation. We will develop a Motion Classification and Anomaly Detection system using the XIAOML Kit, the Arduino IDE, and the Edge Impulse Studio. This project will help us understand how containers experience different forces and motions during various phases of transportation, including terrestrial and maritime transit, vertical movement via forklifts, and periods of stationary storage in warehouses.</p>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Learning Objectives</strong></p>
</div>
<div class="callout-content">
<ul>
<li>Setting up the XIAOML Kit</li>
<li>Data Collection and Preprocessing</li>
<li>Building the Motion Classification Model</li>
<li>Implementing Anomaly Detection</li>
<li>Real-world Testing and Analysis</li>
</ul>
</div>
</div>
</div>
<p>By the end of this lab, you’ll have a working prototype that can classify different types of motion and detect anomalies during the transportation of containers. This knowledge can serve as a stepping stone to more advanced projects in the burgeoning field of TinyML, particularly those involving vibration.</p>
</section>
<section id="sec-motion-classification-anomaly-detection-installing-imu-cac2" class="level2 unnumbered">
<h2 class="unnumbered">Installing the IMU</h2>
<p>The XIAOML Kit comes with a built-in LSM6DS3TR-C 6-axis IMU sensor on the expansion board, eliminating the need for external sensor connections. This integrated approach offers a clean and reliable platform for motion-based machine learning applications.</p>
<p>The LSM6DS3TR-C combines a 3-axis accelerometer and 3-axis gyroscope in a single package, connected via I2C to the XIAO ESP32S3 at address 0x6A that provides:</p>
<ul>
<li><strong>Accelerometer ranges</strong>: ±2/±4/±8/±16 g (we’ll use ±2g by default)</li>
<li><strong>Gyroscope ranges</strong>: ±125/±250/±500/±1000/±2000 dps (we’ll use ±250 dps by default)</li>
<li><strong>Resolution</strong>: 16-bit ADC</li>
<li><strong>Communication</strong>: I2C interface at address 0x6A</li>
<li><strong>Power</strong>: Ultra-low power design</li>
</ul>
<p> <img src="../media/file665.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p><strong>Coordinate System:</strong> The sensor operates within a right-handed coordinate system. When looking at the expansion board from the bottom (where you can see the IMU sensor with the point mark):</p>
<ul>
<li><strong>X-axis</strong>: Points to the right</li>
<li><strong>Y-axis</strong>: Points forward (away from you)</li>
<li><strong>Z-axis</strong>: Points upward (out of the board)</li>
</ul>
<section id="sec-motion-classification-anomaly-detection-setting-hardware-66a1" class="level3 unnumbered">
<h3 class="unnumbered">Setting Up the Hardware</h3>
<p>Since the XIAOML Kit comes pre-assembled with the expansion board, no additional hardware connections are required. The LSM6DS3TR-C IMU is already properly connected via I2C.</p>
<p><strong>What’s Already Connected:</strong></p>
<ul>
<li>LSM6DS3TR-C IMU → I2C (SDA/SCL) → XIAO ESP32S3</li>
<li>I2C Address: 0x6A</li>
<li>Power: 3.3V from XIAO ESP32S3</li>
</ul>
<p><strong>Required Library:</strong> You should have the library installed during the Setup. If not, install the Seeed Arduino LSM6DS3 library following the steps:</p>
<ol type="1">
<li>Open Arduino IDE Library Manager</li>
<li>Search for “LSM6DS3”</li>
<li>Install <strong>“Seeed Arduino LSM6DS3”</strong> by Seeed Studio</li>
<li><strong>Important</strong>: Do NOT install “Arduino_LSM6DS3 by Arduino” - that’s for different boards!</li>
</ol>
</section>
<section id="sec-motion-classification-anomaly-detection-testing-imu-sensor-67b3" class="level3 unnumbered">
<h3 class="unnumbered">Testing the IMU Sensor</h3>
<p>Let’s start with a simple test to verify the IMU is working correctly. Upload this code to test the sensor:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">// Create IMU object using I2C interface</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="dt">float</span> accelX<span class="op">,</span> accelY<span class="op">,</span> accelZ<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="dt">float</span> gyroX<span class="op">,</span> gyroY<span class="op">,</span> gyroZ<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="cf">while</span> <span class="op">(!</span>Serial<span class="op">)</span> delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;XIAOML Kit IMU Test&quot;</span><span class="op">);</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;LSM6DS3TR-C 6-Axis IMU&quot;</span><span class="op">);</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;====================&quot;</span><span class="op">);</span></span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a>  <span class="co">// Initialize the IMU</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;ERROR: IMU initialization failed!&quot;</span><span class="op">);</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>      <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;✓ IMU initialized successfully&quot;</span><span class="op">);</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;Data Format: AccelX,AccelY,AccelZ,&quot;</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>                    <span class="st">&quot;GyroX,GyroY,GyroZ&quot;</span><span class="op">);</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;Units: g-force, degrees/second&quot;</span><span class="op">);</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>      Serial<span class="op">.</span>println<span class="op">();</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>  <span class="op">}</span></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="op">}</span></span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>  <span class="co">// Read accelerometer data (in g-force)</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>  accelX <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>  accelY <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>  accelZ <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span>
<span id="cb1-36"><a href="#cb1-36"></a></span>
<span id="cb1-37"><a href="#cb1-37"></a>  <span class="co">// Read gyroscope data (in degrees per second)</span></span>
<span id="cb1-38"><a href="#cb1-38"></a>  gyroX <span class="op">=</span> myIMU<span class="op">.</span>readFloatGyroX<span class="op">();</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>  gyroY <span class="op">=</span> myIMU<span class="op">.</span>readFloatGyroY<span class="op">();</span></span>
<span id="cb1-40"><a href="#cb1-40"></a>  gyroZ <span class="op">=</span> myIMU<span class="op">.</span>readFloatGyroZ<span class="op">();</span></span>
<span id="cb1-41"><a href="#cb1-41"></a></span>
<span id="cb1-42"><a href="#cb1-42"></a>  <span class="co">// Print readable format</span></span>
<span id="cb1-43"><a href="#cb1-43"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot;Accel (g): X=&quot;</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>accelX<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-44"><a href="#cb1-44"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot; Y=&quot;</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>accelY<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-45"><a href="#cb1-45"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot; Z=&quot;</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>accelZ<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot; | Gyro (°/s): X=&quot;</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>gyroX<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot; Y=&quot;</span><span class="op">);</span> Serial<span class="op">.</span>print<span class="op">(</span>gyroY<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>  Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot; Z=&quot;</span><span class="op">);</span> Serial<span class="op">.</span>println<span class="op">(</span>gyroZ<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb1-49"><a href="#cb1-49"></a></span>
<span id="cb1-50"><a href="#cb1-50"></a>  delay<span class="op">(</span><span class="dv">100</span><span class="op">);</span> <span class="co">// 10 Hz update rate</span></span>
<span id="cb1-51"><a href="#cb1-51"></a><span class="op">}</span></span></code></pre></div>
<p>When the kit is resting flat on a table, you should see:</p>
<ul>
<li>Z-axis acceleration around +1.0g (gravity)</li>
<li>X and Y acceleration near 0.0g</li>
<li>All gyroscope values near 0.0°/s</li>
</ul>
<p>Move the kit around to see the values change accordingly.</p>
</section>
</section>
<section id="sec-motion-classification-anomaly-detection-tinyml-motion-classification-project-90f9" class="level2 unnumbered">
<h2 class="unnumbered">The TinyML Motion Classification Project</h2>
<p>We will simulate container (or, more accurately, package) transportation through various scenarios to make this tutorial more relatable and practical.</p>
<p> <img src="../media/file666.jpg" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>Using the accelerometer of the XIAOML Kit, we’ll capture motion data by manually simulating the conditions of:</p>
<ul>
<li><strong>Maritime</strong> (pallets on boats) - Movement in all axes with wave-like patterns</li>
<li><strong>Terrestrial</strong> (pallets on trucks/trains) - Primarily horizontal movement</li>
<li><strong>Lift</strong> (pallets being moved by forklift) - Primarily vertical movement</li>
<li><strong>Idle</strong> (pallets in storage) - Minimal movement</li>
</ul>
<p>From the above image, we can define for our simulation that primarily horizontal movements (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math> or <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math> axis) should be associated with the “Terrestrial class.” Vertical movements (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>z</mi><annotation encoding="application/x-tex">z</annotation></semantics></math>-axis) with the “Lift Class,” no activity with the “Idle class,” and movement on all three axes to <a href="https://www.containerhandbuch.de/chb_e/stra/index.html?/chb_e/stra/stra_02_03_03.htm">Maritime class.</a></p>
<p> <img src="../media/file667.jpg" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
</section>
<section id="sec-motion-classification-anomaly-detection-data-collection-d54c" class="level2 unnumbered">
<h2 class="unnumbered">Data Collection</h2>
<p>For data collection, we have several options available. In a real-world scenario, we can have our device, for example, connected directly to one container, and the collected data stored in a file (for example, CSV) on an SD card. Data can also be sent remotely to a nearby repository, such as a mobile phone, using Wi-Fi or Bluetooth (as demonstrated in this project: <a href="https://www.hackster.io/mjrobot/sensor-datalogger-50e44d">Sensor DataLogger</a>). Once your dataset is collected and stored as a .CSV file, it can be uploaded to the Studio using the <a href="https://docs.edgeimpulse.com/docs/edge-impulse-studio/data-acquisition/csv-wizard">CSV Wizard tool</a>.</p>
<blockquote>
<p>In this <a href="https://youtu.be/2KBPq_826WM">video</a>, you can learn alternative ways to send data to the Edge Impulse Studio.</p>
</blockquote>
<section id="sec-motion-classification-anomaly-detection-preparing-data-collection-code-da6b" class="level3 unnumbered">
<h3 class="unnumbered">Preparing the Data Collection Code</h3>
<p>In this lab, we will connect the Kit directly to the Edge Impulse Studio, which will also be used for data pre-processing, model training, testing, and deployment.</p>
<p>For data collection, we should first connect the Kit to Edge Impulse Studio, which will also be used for data pre-processing, model training, testing, and deployment.</p>
<blockquote>
<p>Follow the instructions <a href="https://docs.edgeimpulse.com/docs/edge-impulse-cli/cli-installation">here</a> to install <a href="https://nodejs.org/en/">Node.js</a> and Edge Impulse CLI on your computer.</p>
</blockquote>
<p>Once the XIAOML Kit is not a fully supported development board by Edge Impulse, we should, for example, use the <a href="https://docs.edgeimpulse.com/docs/edge-impulse-cli/cli-data-forwarder">CLI Data Forwarder</a> to capture data from our sensor and send it to the Studio, as shown in this diagram:</p>
<p> <img src="../media/file668.jpg" class="quarto-figure quarto-figure-center" style="width:75.0%" alt="" /></p>
<p>We’ll modify our test code to output data in a format suitable for Edge Impulse:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="pp">#define FREQUENCY_HZ        </span><span class="dv">50</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="pp">#define INTERVAL_MS         </span><span class="op">(</span><span class="dv">1000</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span><span class="op">(</span>FREQUENCY_HZ<span class="pp"> </span><span class="op">+</span><span class="pp"> </span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="at">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> last_interval_ms <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="cf">while</span> <span class="op">(!</span>Serial<span class="op">)</span> delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;XIAOML Kit - Motion Data Collection&quot;</span><span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;LSM6DS3TR-C IMU Sensor&quot;</span><span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16"></a></span>
<span id="cb2-17"><a href="#cb2-17"></a>  <span class="co">// Initialize IMU</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>  <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>      Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;ERROR: IMU initialization failed!&quot;</span><span class="op">);</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>      <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>  <span class="op">}</span></span>
<span id="cb2-22"><a href="#cb2-22"></a></span>
<span id="cb2-23"><a href="#cb2-23"></a>  delay<span class="op">(</span><span class="dv">2000</span><span class="op">);</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>  Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;Starting data collection in 3 seconds...&quot;</span><span class="op">);</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>  delay<span class="op">(</span><span class="dv">3000</span><span class="op">);</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="op">}</span></span>
<span id="cb2-27"><a href="#cb2-27"></a></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>  <span class="cf">if</span> <span class="op">(</span>millis<span class="op">()</span> <span class="op">&gt;</span> last_interval_ms <span class="op">+</span> INTERVAL_MS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>      last_interval_ms <span class="op">=</span> millis<span class="op">();</span></span>
<span id="cb2-31"><a href="#cb2-31"></a></span>
<span id="cb2-32"><a href="#cb2-32"></a>      <span class="co">// Read accelerometer data</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>      <span class="dt">float</span> ax <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>      <span class="dt">float</span> ay <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>      <span class="dt">float</span> az <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span>
<span id="cb2-36"><a href="#cb2-36"></a></span>
<span id="cb2-37"><a href="#cb2-37"></a>      <span class="co">// Convert to m/s² (multiply by 9.81)</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>      <span class="dt">float</span> ax_ms2 <span class="op">=</span> ax <span class="op">*</span> <span class="fl">9.81</span><span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>      <span class="dt">float</span> ay_ms2 <span class="op">=</span> ay <span class="op">*</span> <span class="fl">9.81</span><span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>      <span class="dt">float</span> az_ms2 <span class="op">=</span> az <span class="op">*</span> <span class="fl">9.81</span><span class="op">;</span></span>
<span id="cb2-41"><a href="#cb2-41"></a></span>
<span id="cb2-42"><a href="#cb2-42"></a>      <span class="co">// Output in Edge Impulse format</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>      Serial<span class="op">.</span>print<span class="op">(</span>ax_ms2<span class="op">);</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>      Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>      Serial<span class="op">.</span>print<span class="op">(</span>ay_ms2<span class="op">);</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>      Serial<span class="op">.</span>print<span class="op">(</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>      Serial<span class="op">.</span>println<span class="op">(</span>az_ms2<span class="op">);</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>  <span class="op">}</span></span>
<span id="cb2-49"><a href="#cb2-49"></a><span class="op">}</span></span></code></pre></div>
<p>Upload the code to the Arduino IDE. We should see the accelerometer values (converted to m/s²) at the Serial Monitor:</p>
<p> <img src="../media/file669.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<blockquote>
<p>Keep the code running, but <strong>turn off the Serial Monitor</strong>. The data generated by the Kit will be sent to the Edge Impulse Studio via Serial Connection.</p>
</blockquote>
</section>
<section id="sec-motion-classification-anomaly-detection-connecting-edge-impulse-data-collection-c41a" class="level3 unnumbered">
<h3 class="unnumbered">Connecting to Edge Impulse for Data Collection</h3>
<p><strong>Create an Edge Impulse Project</strong> - Go to Edge Impulse Studio and create a new project - Choose a descriptive name (keep under 63 characters for Arduino library compatibility)</p>
<p> <img src="../media/file670.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p><strong>Set up CLI Data Forwarder</strong> - Install Edge Impulse CLI on your computer - Confirm that the XIAOML Kit is connected to the computer, <strong>the code is running and the Serial Monitor is OFF</strong>, otherwise we can get an error. - On the Computer Terminal, run: <code>edge-impulse-data-forwarder --clean</code> - Enter your Edge Impulse credentials - Select your project and configure device settings</p>
<p> <img src="../media/file671.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<ul>
<li>Go to the Edge Impulse Studio Project. On the <code>Device</code> section is possible to verify if the kit is correctly connected (the dot should be green).</li>
</ul>
<p> <img src="../media/file672.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
</section>
</section>
<section id="sec-motion-classification-anomaly-detection-data-collection-studio-5ca4" class="level2 unnumbered">
<h2 class="unnumbered">Data Collection at the Studio</h2>
<p>As discussed before, we should capture data from all four <strong>Transportation Classes.</strong> Imagine that you have a container with a built-in accelerometer (In this case, our XIAOML Kit). Now imagine your container is on a boat, facing an angry ocean:</p>
<p> <img src="../media/file673.png" class="quarto-figure quarto-figure-center" style="width:70.0%" alt="" /></p>
<p>Or in a Truck, travelling on a road, or being moved with a forklift, etc.</p>
<section id="sec-motion-classification-anomaly-detection-movement-simulation-2e54" class="level3 unnumbered">
<h3 class="unnumbered">Movement Simulation</h3>
<p><strong>Maritime Class:</strong></p>
<ul>
<li>Hold the kit and simulate boat movement</li>
<li>Move in all three axes with wave-like, undulating motions</li>
<li>Include gentle rolling and pitching movements</li>
</ul>
<p><strong>Terrestrial Class:</strong></p>
<ul>
<li>Move the kit horizontally in straight lines (left to right and vice versa)</li>
<li>Simulate truck/train vibrations with small horizontal shakes</li>
<li>Occasional gentle bumps and turns</li>
</ul>
<p><strong>Lift Class:</strong></p>
<ul>
<li>Move the kit primarily in vertical directions (up and down)</li>
<li>Simulate forklift operations: up, pause, down</li>
<li>Include some short horizontal positioning movements</li>
</ul>
<p><strong>Idle Class:</strong></p>
<ul>
<li>Place the kit on a stable surface</li>
<li>Minimal to no movement</li>
<li>Capture environmental vibrations and sensor noise</li>
</ul>
</section>
<section id="sec-motion-classification-anomaly-detection-data-acquisition-e277" class="level3 unnumbered">
<h3 class="unnumbered">Data Acquisition</h3>
<p>On the <code>Data Acquisition</code> section, you should see that your board <code>[xiaoml-kit]</code> is connected. The sensor is available: <code>[sensor with 3 axes (accX, accY, accZ)]</code> with a sampling frequency of <code>[50 Hz]</code>. The Studio suggests a sample length of <code>[10000]</code> ms (10 s). The last thing left is defining the sample label. Let’s start, for example, with<code>[terrestrial]</code>.</p>
<p>Press <code>[Start Sample]</code>and move your kit horizontally (left to right), keeping it in one direction. After 10 seconds, our data will be uploaded to the Studio.</p>
<p>Below is one sample (raw data) of 10 seconds of collected data. It is notable that the ondulatory movement predominantly occurs along the Y-axis (left-right). The other axes are almost stationary (the X-axis is centered around zero, and the Z-axis is centered around 9.8 ms² due to gravity).</p>
<p> <img src="../media/file674.png" class="quarto-figure quarto-figure-center" style="width:70.0%" alt="" /></p>
<p>You should capture, for example, around 2 minutes (ten to twelve samples of 10 seconds each) for each of the four classes. Using the <code>3 dots</code> after each sample, select two and move them to the <strong>Test set</strong>. Alternatively, you can use the Automatic <code>Train/Test Split</code> tool on the <strong>Danger Zone</strong> of the <code>Dashboard</code> tab. Below, it is possible to see the result datasets:</p>
<p> <img src="../media/file675.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
</section>
</section>
<section id="sec-motion-classification-anomaly-detection-data-preprocessing-2269" class="level2 unnumbered">
<h2 class="unnumbered">Data Pre-Processing</h2>
<p>The raw data type captured by the accelerometer is a “time series” and should be converted to “tabular data”. We can do this conversion using a sliding window over the sample data. For example, in the below figure,</p>
<p> <img src="../media/file676.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>We can see 10 seconds of accelerometer data captured with a sample rate (SR) of 50 Hz. A 2-second window will capture 300 data points (3 axes <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>×</mi><annotation encoding="application/x-tex">\times</annotation></semantics></math> 2 seconds <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>×</mi><annotation encoding="application/x-tex">\times</annotation></semantics></math> 50 samples). We will slide this window every 200ms, creating a larger dataset where each instance has 300 raw features.</p>
<blockquote>
<p>You should use the best SR for your case, considering Nyquist’s theorem, which states that a periodic signal must be sampled at more than twice the signal’s highest frequency component.</p>
</blockquote>
<p>Data preprocessing is a challenging area for embedded machine learning. Still, Edge Impulse helps overcome this with its digital signal processing (DSP) preprocessing step and, more specifically, the Spectral Features.</p>
<p>On the Studio, this dataset will be the input of a Spectral Analysis block, which is excellent for analyzing repetitive motion, such as data from accelerometers. This block will perform a DSP (Digital Signal Processing), extracting features such as “FFT” or “Wavelets”. In the most common case, FFT, the <strong>Time Domain Statistical features</strong> per axis/channel are:</p>
<ul>
<li>RMS</li>
<li>Skewness</li>
<li>Kurtosis</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="../media/file677.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
</figure>
</div>
<p>And the <strong>Frequency Domain Spectral features</strong> per axis/channel are:</p>
<ul>
<li>Spectral Power</li>
<li>Skewness</li>
<li>Kurtosis</li>
</ul>
<p> <img src="../media/file678.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>For example, for an FFT length of 32 points, the Spectral Analysis Block’s resulting output will be 21 features per axis (a total of 63 features).</p>
<p>Those 63 features will serve as the input tensor for a Neural Network Classifier and the Anomaly Detection model (K-Means).</p>
<blockquote>
<p>You can learn more by digging into the lab <a href="ch056.xhtml#sec-dsp-spectral-features-overview-a7be">DSP Spectral Features</a></p>
</blockquote>
</section>
<section id="sec-motion-classification-anomaly-detection-model-design-d2d4" class="level2 unnumbered">
<h2 class="unnumbered">Model Design</h2>
<p>Our classifier will be a Dense Neural Network (DNN) that will have 63 neurons on its input layer, two hidden layers with 20 and 10 neurons, and an output layer with four neurons (one per each class), as shown here:</p>
<p> <img src="../media/file679.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
</section>
<section id="sec-motion-classification-anomaly-detection-impulse-design-18e9" class="level2 unnumbered">
<h2 class="unnumbered">Impulse Design</h2>
<p>An impulse takes raw data, uses signal processing to extract features, and then uses a learning block (<strong>Dense model</strong>) to classify new data.</p>
<p>We also utilize a second model, the <strong>K-means</strong>, which can be used for Anomaly Detection. If we imagine that we could have our known classes as clusters, any sample that cannot fit into one of these clusters could be an outlier, an anomaly (for example, a container rolling out of a ship on the ocean or being upside down on the floor).</p>
<p> <img src="../media/file680.jpg" class="quarto-figure quarto-figure-center" style="width:70.0%" alt="" /></p>
<blockquote>
<p>Imagine our XIAOML Kit rolling or moving upside-down, on a movement complement different from the one trained on.</p>
</blockquote>
<p> <img src="../media/file681.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>Below the final Impulse design:</p>
<p> <img src="../media/file682.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
</section>
<section id="sec-motion-classification-anomaly-detection-generating-features-cf4b" class="level2 unnumbered">
<h2 class="unnumbered">Generating features</h2>
<p>At this point in our project, we have defined the pre-processing method, and the model has been designed. Now, it is time to have the job done. First, let’s convert the raw data (time-series type) into tabular data. Go to the <code>Spectral Features</code> tab and select <code>[Save Parameters]</code>. Alternatively, instead of using the default values, we can select the <code>[Autotune parameters]</code> button. In this case, the Studio will define new hyperparameters, as the filter design and FFT length, based on the raw data.</p>
<p> <img src="../media/file683.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>At the top menu, select the <code>Generate features</code> tab, and there, select the options, <code>Calculate feature importance</code>, <code>Normalize features,</code> and press the <code>[Generate features]</code> button. Each 2-second window of data (300 datapoints) will be converted into a single tabular data point with 63 features.</p>
<blockquote>
<p>The Feature Explorer will display this data in 2D using <a href="https://umap-learn.readthedocs.io/en/latest/">UMAP.</a> Uniform Manifold Approximation and Projection (UMAP) is a dimensionality reduction technique that can be used for visualization, similar to t-SNE, but also for general non-linear dimensionality reduction.</p>
</blockquote>
<p>The visualization enables one to verify that the classes present an excellent separation, indicating that the classifier should perform well.</p>
<p> <img src="../media/file684.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>Optionally, you can analyze the relative importance of each feature for one class compared with other classes.</p>
</section>
<section id="sec-motion-classification-anomaly-detection-training-d832" class="level2 unnumbered">
<h2 class="unnumbered">Training</h2>
<p>Our classifier will be a Dense Neural Network (DNN) that will have 63 neurons on its input layer, two hidden layers with 20 and 10 neurons, and an output layer with four neurons (one per each class), as shown here:</p>
<p> <img src="../media/file685.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>As hyperparameters, we will use a Learning Rate of 0.005 and 20% of the data for validation for 30 epochs. After training, we can see that the accuracy is 100%.</p>
<p> <img src="../media/file686.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>For anomaly detection, we should choose the suggested features that are precisely the most important in feature extraction. The number of clusters will be 32, as suggested by the Studio. After training, we can select some data for testing, such as maritime data. The resulting Anomaly score was <code>min: -0.1642, max: 0.0738, avg: -0.0867</code>.</p>
<p>When changing the data, it is possible to realize that small or negative Anomaly Scores indicate that the data are normal.</p>
<p> <img src="../media/file687.png" class="quarto-figure quarto-figure-center" style="width:70.0%" alt="" /></p>
</section>
<section id="sec-motion-classification-anomaly-detection-testing-c2bb" class="level2 unnumbered">
<h2 class="unnumbered">Testing</h2>
<p>Using 20% of the data left behind during the data capture phase, we can verify how our model will behave with unknown data; if not 100% (what is expected), the result was very good (8%).</p>
<p> <img src="../media/file688.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>You should also use your kit (which is still connected to the Studio) and perform some Live Classification. For example, let’s test some “terrestrial” movement:</p>
<p> <img src="../media/file689.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<blockquote>
<p>Be aware that here, you will capture real data with your device and upload it to the Studio, where an inference will be made using the trained model (note that the model is not on your device).</p>
</blockquote>
</section>
<section id="sec-motion-classification-anomaly-detection-deploy-aa7e" class="level2 unnumbered">
<h2 class="unnumbered">Deploy</h2>
<p>Now it is time for magic! The Studio will package all the needed libraries, preprocessing functions, and trained models, downloading them to your computer. You should select the Arduino Library option, and then, at the bottom, choose Quantized (Int8) and click <code>[Build]</code>. A ZIP file will be created and downloaded to your computer.</p>
<p> <img src="../media/file690.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<p>On your Arduino IDE, go to the Sketch tab, select the option Add.ZIP Library, and Choose the.zip file downloaded by the Studio:</p>
<p> <img src="../media/file691.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
</section>
<section id="sec-motion-classification-anomaly-detection-inference-8351" class="level2 unnumbered">
<h2 class="unnumbered">Inference</h2>
<p>Now, it is time for a real test. We will make inferences that are wholly disconnected from the Studio. Let’s change one of the code examples created when you deploy the Arduino Library.</p>
<p>In your Arduino IDE, go to the <code>File/Examples</code> tab and look for your project, and in examples, select <code>nano_ble_sense_accelerometer</code>:</p>
<p>Of course, this is not your board, but we can have the code working with only a few changes.</p>
<p>For example, at the beginning of the code, you have the library related to Arduino Sense IMU:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">/* Includes -------------------------------------------- */</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="pp">#include </span><span class="im">&lt;XIAOML_Kit_Motion_Class_-_AD_inferencing.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="pp">#include </span><span class="im">&lt;Arduino_LSM9DS1.h&gt;</span></span></code></pre></div>
<p>Change the “includes” portion with the code related to the IMU:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="pp">#include </span><span class="im">&lt;XIAOML_Kit_Motion_Class_-_AD_inferencing.h&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span></code></pre></div>
<p>Change the Constant Defines</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">// IMU setup</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">// Inference settings</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="pp">#define CONVERT_G_TO_MS2    </span><span class="fl">9.81</span><span class="bu">f</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="pp">#define MAX_ACCEPTED_RANGE  </span><span class="fl">2.0</span><span class="bu">f</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>CONVERT_G_TO_MS2</span></code></pre></div>
<p>On the setup function, initiate the IMU:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1"></a>   <span class="co">// Initialize IMU</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>        Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;ERROR: IMU initialization failed!&quot;</span><span class="op">);</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="op">}</span></span></code></pre></div>
<p>At the loop function, the buffers buffer[ix], buffer[ix + 1], and buffer[ix + 2] will receive the 3-axis data captured by the accelerometer. In the original code, you have the line:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1"></a>IMU<span class="op">.</span>readAcceleration<span class="op">(</span>buffer<span class="op">[</span>ix<span class="op">],</span> buffer<span class="op">[</span>ix <span class="op">+</span> <span class="dv">1</span><span class="op">],</span> buffer<span class="op">[</span>ix <span class="op">+</span> <span class="dv">2</span><span class="op">]);</span></span></code></pre></div>
<p>Change it with this block of code:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">// Read IMU data</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="dt">float</span> x <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="dt">float</span> y <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="dt">float</span> z <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span></code></pre></div>
<p>You should reorder the following two blocks of code. First, you make the conversion to raw data to “Meters per squared second (m/s<sup>2</sup>)”, followed by the test regarding the maximum acceptance range (that here is in m/s<sup>2</sup>, but on Arduino, was in Gs):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1"></a>  <span class="co">// Convert to m/s²</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">0</span><span class="op">]</span> <span class="op">=</span> x <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> y <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">=</span> z <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="co">// Apply range limiting</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>      <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">])</span> <span class="op">&gt;</span> MAX_ACCEPTED_RANGE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>          buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">=</span> copysign<span class="op">(</span>MAX_ACCEPTED_RANGE<span class="op">,</span> buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]);</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>      <span class="op">}</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="op">}</span></span></code></pre></div>
<p>And this is enough. We can also adjust how the inference is displayed in the Serial Monitor. You can now upload the complete code below to your device and proceed with the inferences.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource cpp number-lines"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1"></a><span class="co">// Motion Classification with LSM6DS3TR-C IMU</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="pp">#include </span><span class="im">&lt;XIAOML_Kit_Motion_Class_-_AD_inferencing.h&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="pp">#include </span><span class="im">&lt;LSM6DS3.h&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="pp">#include </span><span class="im">&lt;Wire.h&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co">// IMU setup</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>LSM6DS3 myIMU<span class="op">(</span>I2C_MODE<span class="op">,</span> <span class="bn">0x6A</span><span class="op">);</span></span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">// Inference settings</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="pp">#define CONVERT_G_TO_MS2    </span><span class="fl">9.81</span><span class="bu">f</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="pp">#define MAX_ACCEPTED_RANGE  </span><span class="fl">2.0</span><span class="bu">f</span><span class="pp"> </span><span class="op">*</span><span class="pp"> </span>CONVERT_G_TO_MS2</span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="at">static</span> <span class="dt">bool</span> debug_nn <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="at">static</span> <span class="dt">float</span> buffer<span class="op">[</span>EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="at">static</span> <span class="dt">float</span> inference_buffer<span class="op">[</span>EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">];</span></span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="dt">void</span> setup<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>    Serial<span class="op">.</span>begin<span class="op">(</span><span class="dv">115200</span><span class="op">);</span></span>
<span id="cb10-19"><a href="#cb10-19"></a>    <span class="cf">while</span> <span class="op">(!</span>Serial<span class="op">)</span> delay<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb10-20"><a href="#cb10-20"></a></span>
<span id="cb10-21"><a href="#cb10-21"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;XIAOML Kit - Motion Classification&quot;</span><span class="op">);</span></span>
<span id="cb10-22"><a href="#cb10-22"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;LSM6DS3TR-C IMU Inference&quot;</span><span class="op">);</span></span>
<span id="cb10-23"><a href="#cb10-23"></a></span>
<span id="cb10-24"><a href="#cb10-24"></a>    <span class="co">// Initialize IMU</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>    <span class="cf">if</span> <span class="op">(</span>myIMU<span class="op">.</span>begin<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-26"><a href="#cb10-26"></a>        Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;ERROR: IMU initialization failed!&quot;</span><span class="op">);</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-28"><a href="#cb10-28"></a>    <span class="op">}</span></span>
<span id="cb10-29"><a href="#cb10-29"></a></span>
<span id="cb10-30"><a href="#cb10-30"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;✓ IMU initialized&quot;</span><span class="op">);</span></span>
<span id="cb10-31"><a href="#cb10-31"></a></span>
<span id="cb10-32"><a href="#cb10-32"></a>    <span class="cf">if</span> <span class="op">(</span>EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME <span class="op">!=</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-33"><a href="#cb10-33"></a>        Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;ERROR: EI_CLASSIFIER_RAW_SAMPLES_PER_FRAME&quot;</span></span>
<span id="cb10-34"><a href="#cb10-34"></a>                       <span class="st">&quot;should be 3&quot;</span><span class="op">);</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-36"><a href="#cb10-36"></a>    <span class="op">}</span></span>
<span id="cb10-37"><a href="#cb10-37"></a></span>
<span id="cb10-38"><a href="#cb10-38"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;✓ Model loaded&quot;</span><span class="op">);</span></span>
<span id="cb10-39"><a href="#cb10-39"></a>    Serial<span class="op">.</span>println<span class="op">(</span><span class="st">&quot;Starting motion classification...&quot;</span><span class="op">);</span></span>
<span id="cb10-40"><a href="#cb10-40"></a><span class="op">}</span></span>
<span id="cb10-41"><a href="#cb10-41"></a></span>
<span id="cb10-42"><a href="#cb10-42"></a><span class="dt">void</span> loop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-43"><a href="#cb10-43"></a>    ei_printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">Starting inferencing in 2 seconds...</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb10-44"><a href="#cb10-44"></a>    delay<span class="op">(</span><span class="dv">2000</span><span class="op">);</span></span>
<span id="cb10-45"><a href="#cb10-45"></a></span>
<span id="cb10-46"><a href="#cb10-46"></a>    ei_printf<span class="op">(</span><span class="st">&quot;Sampling...</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb10-47"><a href="#cb10-47"></a></span>
<span id="cb10-48"><a href="#cb10-48"></a>    <span class="co">// Clear buffer</span></span>
<span id="cb10-49"><a href="#cb10-49"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-50"><a href="#cb10-50"></a>        buffer<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb10-51"><a href="#cb10-51"></a>    <span class="op">}</span></span>
<span id="cb10-52"><a href="#cb10-52"></a></span>
<span id="cb10-53"><a href="#cb10-53"></a>    <span class="co">// Collect accelerometer data</span></span>
<span id="cb10-54"><a href="#cb10-54"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">;</span> i <span class="op">+=</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-55"><a href="#cb10-55"></a>        <span class="dt">uint64_t</span> next_tick <span class="op">=</span> micros<span class="op">()</span> <span class="op">+</span></span>
<span id="cb10-56"><a href="#cb10-56"></a>          <span class="op">(</span>EI_CLASSIFIER_INTERVAL_MS <span class="op">*</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb10-57"><a href="#cb10-57"></a></span>
<span id="cb10-58"><a href="#cb10-58"></a>        <span class="co">// Read IMU data</span></span>
<span id="cb10-59"><a href="#cb10-59"></a>        <span class="dt">float</span> x <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelX<span class="op">();</span></span>
<span id="cb10-60"><a href="#cb10-60"></a>        <span class="dt">float</span> y <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelY<span class="op">();</span></span>
<span id="cb10-61"><a href="#cb10-61"></a>        <span class="dt">float</span> z <span class="op">=</span> myIMU<span class="op">.</span>readFloatAccelZ<span class="op">();</span></span>
<span id="cb10-62"><a href="#cb10-62"></a></span>
<span id="cb10-63"><a href="#cb10-63"></a>        <span class="co">// Convert to m/s²</span></span>
<span id="cb10-64"><a href="#cb10-64"></a>        buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">0</span><span class="op">]</span> <span class="op">=</span> x <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb10-65"><a href="#cb10-65"></a>        buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> y <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb10-66"><a href="#cb10-66"></a>        buffer<span class="op">[</span>i <span class="op">+</span> <span class="dv">2</span><span class="op">]</span> <span class="op">=</span> z <span class="op">*</span> CONVERT_G_TO_MS2<span class="op">;</span></span>
<span id="cb10-67"><a href="#cb10-67"></a></span>
<span id="cb10-68"><a href="#cb10-68"></a>        <span class="co">// Apply range limiting</span></span>
<span id="cb10-69"><a href="#cb10-69"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-70"><a href="#cb10-70"></a>            <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">])</span> <span class="op">&gt;</span> MAX_ACCEPTED_RANGE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-71"><a href="#cb10-71"></a>                buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]</span> <span class="op">=</span> copysign<span class="op">(</span>MAX_ACCEPTED_RANGE<span class="op">,</span></span>
<span id="cb10-72"><a href="#cb10-72"></a>                                         buffer<span class="op">[</span>i <span class="op">+</span> j<span class="op">]);</span></span>
<span id="cb10-73"><a href="#cb10-73"></a>            <span class="op">}</span></span>
<span id="cb10-74"><a href="#cb10-74"></a>        <span class="op">}</span></span>
<span id="cb10-75"><a href="#cb10-75"></a></span>
<span id="cb10-76"><a href="#cb10-76"></a>        delayMicroseconds<span class="op">(</span>next_tick <span class="op">-</span> micros<span class="op">());</span></span>
<span id="cb10-77"><a href="#cb10-77"></a>    <span class="op">}</span></span>
<span id="cb10-78"><a href="#cb10-78"></a></span>
<span id="cb10-79"><a href="#cb10-79"></a>    <span class="co">// Copy to inference buffer</span></span>
<span id="cb10-80"><a href="#cb10-80"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-81"><a href="#cb10-81"></a>        inference_buffer<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> buffer<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb10-82"><a href="#cb10-82"></a>    <span class="op">}</span></span>
<span id="cb10-83"><a href="#cb10-83"></a></span>
<span id="cb10-84"><a href="#cb10-84"></a>    <span class="co">// Create signal from buffer</span></span>
<span id="cb10-85"><a href="#cb10-85"></a>    <span class="dt">signal_t</span> signal<span class="op">;</span></span>
<span id="cb10-86"><a href="#cb10-86"></a>    <span class="dt">int</span> err <span class="op">=</span> numpy<span class="op">::</span>signal_from_buffer<span class="op">(</span>inference_buffer<span class="op">,</span></span>
<span id="cb10-87"><a href="#cb10-87"></a>              EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE<span class="op">,</span> <span class="op">&amp;</span>signal<span class="op">);</span></span>
<span id="cb10-88"><a href="#cb10-88"></a>    <span class="cf">if</span> <span class="op">(</span>err <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-89"><a href="#cb10-89"></a>        ei_printf<span class="op">(</span><span class="st">&quot;ERROR: Failed to create signal from buffer (</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb10-90"><a href="#cb10-90"></a>                  err<span class="op">);</span></span>
<span id="cb10-91"><a href="#cb10-91"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-92"><a href="#cb10-92"></a>    <span class="op">}</span></span>
<span id="cb10-93"><a href="#cb10-93"></a></span>
<span id="cb10-94"><a href="#cb10-94"></a>    <span class="co">// Run the classifier</span></span>
<span id="cb10-95"><a href="#cb10-95"></a>    <span class="dt">ei_impulse_result_t</span> result <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb10-96"><a href="#cb10-96"></a>    err <span class="op">=</span> run_classifier<span class="op">(&amp;</span>signal<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">,</span> debug_nn<span class="op">);</span></span>
<span id="cb10-97"><a href="#cb10-97"></a>    <span class="cf">if</span> <span class="op">(</span>err <span class="op">!=</span> EI_IMPULSE_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-98"><a href="#cb10-98"></a>        ei_printf<span class="op">(</span><span class="st">&quot;ERROR: Failed to run classifier (</span><span class="sc">%d</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> err<span class="op">);</span></span>
<span id="cb10-99"><a href="#cb10-99"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-100"><a href="#cb10-100"></a>    <span class="op">}</span></span>
<span id="cb10-101"><a href="#cb10-101"></a></span>
<span id="cb10-102"><a href="#cb10-102"></a>    <span class="co">// Print predictions</span></span>
<span id="cb10-103"><a href="#cb10-103"></a>    ei_printf<span class="op">(</span><span class="st">&quot;Predictions (DSP: </span><span class="sc">%d</span><span class="st"> ms, Classification: </span><span class="sc">%d</span><span class="st"> ms, &quot;</span></span>
<span id="cb10-104"><a href="#cb10-104"></a>              <span class="st">&quot;Anomaly: </span><span class="sc">%d</span><span class="st"> ms):</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb10-105"><a href="#cb10-105"></a>        result<span class="op">.</span>timing<span class="op">.</span>dsp<span class="op">,</span> result<span class="op">.</span>timing<span class="op">.</span>classification<span class="op">,</span> result<span class="op">.</span>timing<span class="op">.</span>anomaly<span class="op">);</span></span>
<span id="cb10-106"><a href="#cb10-106"></a></span>
<span id="cb10-107"><a href="#cb10-107"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> EI_CLASSIFIER_LABEL_COUNT<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-108"><a href="#cb10-108"></a>        ei_printf<span class="op">(</span><span class="st">&quot;    </span><span class="sc">%s</span><span class="st">: </span><span class="sc">%.5f\n</span><span class="st">&quot;</span><span class="op">,</span> result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>label<span class="op">,</span></span>
<span id="cb10-109"><a href="#cb10-109"></a>                  result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>value<span class="op">);</span></span>
<span id="cb10-110"><a href="#cb10-110"></a>    <span class="op">}</span></span>
<span id="cb10-111"><a href="#cb10-111"></a></span>
<span id="cb10-112"><a href="#cb10-112"></a>    <span class="co">// Print anomaly score</span></span>
<span id="cb10-113"><a href="#cb10-113"></a><span class="pp">#if EI_CLASSIFIER_HAS_ANOMALY == 1</span></span>
<span id="cb10-114"><a href="#cb10-114"></a>    ei_printf<span class="op">(</span><span class="st">&quot;Anomaly score: </span><span class="sc">%.3f\n</span><span class="st">&quot;</span><span class="op">,</span> result<span class="op">.</span>anomaly<span class="op">);</span></span>
<span id="cb10-115"><a href="#cb10-115"></a><span class="pp">#endif</span></span>
<span id="cb10-116"><a href="#cb10-116"></a></span>
<span id="cb10-117"><a href="#cb10-117"></a>    <span class="co">// Determine prediction</span></span>
<span id="cb10-118"><a href="#cb10-118"></a>    <span class="dt">float</span> max_confidence <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb10-119"><a href="#cb10-119"></a>    String predicted_class <span class="op">=</span> <span class="st">&quot;unknown&quot;</span><span class="op">;</span></span>
<span id="cb10-120"><a href="#cb10-120"></a></span>
<span id="cb10-121"><a href="#cb10-121"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> ix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ix <span class="op">&lt;</span> EI_CLASSIFIER_LABEL_COUNT<span class="op">;</span> ix<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb10-122"><a href="#cb10-122"></a>        <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>value <span class="op">&gt;</span> max_confidence<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-123"><a href="#cb10-123"></a>            max_confidence <span class="op">=</span> result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>value<span class="op">;</span></span>
<span id="cb10-124"><a href="#cb10-124"></a>            predicted_class <span class="op">=</span> String<span class="op">(</span>result<span class="op">.</span>classification<span class="op">[</span>ix<span class="op">].</span>label<span class="op">);</span></span>
<span id="cb10-125"><a href="#cb10-125"></a>        <span class="op">}</span></span>
<span id="cb10-126"><a href="#cb10-126"></a>    <span class="op">}</span></span>
<span id="cb10-127"><a href="#cb10-127"></a></span>
<span id="cb10-128"><a href="#cb10-128"></a>    <span class="co">// Display result with confidence threshold</span></span>
<span id="cb10-129"><a href="#cb10-129"></a>    <span class="cf">if</span> <span class="op">(</span>max_confidence <span class="op">&gt;</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-130"><a href="#cb10-130"></a>        ei_printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">🎯 PREDICTION: </span><span class="sc">%s</span><span class="st"> (</span><span class="sc">%.1f%%</span><span class="st"> confidence)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb10-131"><a href="#cb10-131"></a>                 predicted_class<span class="op">.</span>c_str<span class="op">(),</span> max_confidence <span class="op">*</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb10-132"><a href="#cb10-132"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb10-133"><a href="#cb10-133"></a>        ei_printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">❓ UNCERTAIN: Highest confidence is </span><span class="sc">%s</span><span class="st"> (</span><span class="sc">%.1f%%</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb10-134"><a href="#cb10-134"></a>                 predicted_class<span class="op">.</span>c_str<span class="op">(),</span> max_confidence <span class="op">*</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb10-135"><a href="#cb10-135"></a>    <span class="op">}</span></span>
<span id="cb10-136"><a href="#cb10-136"></a></span>
<span id="cb10-137"><a href="#cb10-137"></a>    <span class="co">// Check for anomaly</span></span>
<span id="cb10-138"><a href="#cb10-138"></a><span class="pp">#if EI_CLASSIFIER_HAS_ANOMALY == 1</span></span>
<span id="cb10-139"><a href="#cb10-139"></a>    <span class="cf">if</span> <span class="op">(</span>result<span class="op">.</span>anomaly <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-140"><a href="#cb10-140"></a>        ei_printf<span class="op">(</span><span class="st">&quot;⚠️ ANOMALY DETECTED! Score: </span><span class="sc">%.3f\n</span><span class="st">&quot;</span><span class="op">,</span> result<span class="op">.</span>anomaly<span class="op">);</span></span>
<span id="cb10-141"><a href="#cb10-141"></a>    <span class="op">}</span></span>
<span id="cb10-142"><a href="#cb10-142"></a><span class="pp">#endif</span></span>
<span id="cb10-143"><a href="#cb10-143"></a></span>
<span id="cb10-144"><a href="#cb10-144"></a>    delay<span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb10-145"><a href="#cb10-145"></a><span class="op">}</span></span>
<span id="cb10-146"><a href="#cb10-146"></a></span>
<span id="cb10-147"><a href="#cb10-147"></a><span class="dt">void</span> ei_printf<span class="op">(</span><span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>format<span class="op">,</span> <span class="op">...)</span> <span class="op">{</span></span>
<span id="cb10-148"><a href="#cb10-148"></a>    <span class="at">static</span> <span class="dt">char</span> print_buf<span class="op">[</span><span class="dv">1024</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb10-149"><a href="#cb10-149"></a>    <span class="dt">va_list</span> args<span class="op">;</span></span>
<span id="cb10-150"><a href="#cb10-150"></a>    va_start<span class="op">(</span>args<span class="op">,</span> format<span class="op">);</span></span>
<span id="cb10-151"><a href="#cb10-151"></a>    <span class="dt">int</span> r <span class="op">=</span> vsnprintf<span class="op">(</span>print_buf<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>print_buf<span class="op">),</span> format<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb10-152"><a href="#cb10-152"></a>    va_end<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb10-153"><a href="#cb10-153"></a>    <span class="cf">if</span> <span class="op">(</span>r <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-154"><a href="#cb10-154"></a>        Serial<span class="op">.</span>write<span class="op">(</span>print_buf<span class="op">);</span></span>
<span id="cb10-155"><a href="#cb10-155"></a>    <span class="op">}</span></span>
<span id="cb10-156"><a href="#cb10-156"></a><span class="op">}</span></span></code></pre></div>
<blockquote>
<p>The complete code is available on the <a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/tree/main/XIAOML_Kit_code/motion_class_ad_inference">Lab’s GitHub</a>.</p>
</blockquote>
<p>Now you should try your movements, seeing the result of the inference of each class on the images:</p>
<p> <img src="../media/file692.png" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p> <img src="../media/file693.png" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p> <img src="../media/file694.png" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p> <img src="../media/file695.png" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
<p>And, of course, some “anomaly”, for example, putting the XIAO upside-down. The anomaly score will be over 0.5:</p>
<p> <img src="../media/file696.png" class="quarto-figure quarto-figure-center" style="width:90.0%" alt="" /></p>
</section>
<section id="sec-motion-classification-anomaly-detection-postprossessing-ef66" class="level2 unnumbered">
<h2 class="unnumbered">Post-Processing</h2>
<p>Now that we know the model is working, we suggest modifying the code to see the result with the Kit completely offline (disconnected from the PC and powered by a battery, a power bank, or an independent 5V power supply).</p>
<p>The idea is that if a specific movement is detected, a corresponding message will appear on the OLED display.</p>
<p><img src="../media/file697.png" alt="" /></p>
<p>The modified inference code to have the OLED display is available on the <a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/tree/main/XIAOML_Kit_code/motion_class_ad_inference_oled">Lab’s GitHub</a>.</p>
</section>
<section id="sec-motion-classification-anomaly-detection-summary-35d1" class="level2 unnumbered">
<h2 class="unnumbered">Summary</h2>
<p>This lab demonstrated how to build a complete motion classification system using the XIAOML Kit’s built-in LSM6DS3TR-C IMU sensor. Key achievements include:</p>
<p><strong>Technical Implementation:</strong></p>
<ul>
<li>Utilized the integrated 6-axis IMU for motion sensing</li>
<li>Collected labeled training data for four transportation scenarios</li>
<li>Implemented spectral feature extraction for time-series analysis</li>
<li>Deployed a neural network classifier optimized for microcontroller inference</li>
<li>Added anomaly detection for identifying unusual movements</li>
</ul>
<p><strong>Machine Learning Pipeline:</strong></p>
<ul>
<li>Data collection directly from embedded sensors</li>
<li>Feature engineering using frequency domain analysis</li>
<li>Model training and optimization in Edge Impulse</li>
<li>Real-time inference on resource-constrained hardware</li>
<li>Performance monitoring and validation</li>
</ul>
<p><strong>Practical Applications:</strong> The techniques learned apply directly to real-world scenarios, including:</p>
<ul>
<li>Asset tracking and logistics monitoring</li>
<li>Predictive maintenance for machinery</li>
<li>Human activity recognition</li>
<li>Vehicle and equipment monitoring</li>
<li>IoT sensor networks for smart cities</li>
</ul>
<p><strong>Key Learnings:</strong></p>
<ul>
<li>Working with IMU coordinate systems and sensor fusion</li>
<li>Balancing model accuracy with inference speed on edge devices</li>
<li>Implementing robust data collection and preprocessing pipelines</li>
<li>Deploying machine learning models to embedded systems</li>
<li>Integrating multiple sensors (IMU + display) for complete solutions</li>
</ul>
<p>The integration of motion classification with the XIAOML Kit demonstrates how modern embedded systems can perform sophisticated AI tasks locally, enabling real-time decision-making without reliance on the cloud. This approach is fundamental to the future of edge AI in industrial IoT, autonomous systems, and smart device applications.</p>
</section>
<section id="sec-motion-classification-anomaly-detection-resources-cd54" class="level2 unnumbered">
<h2 class="unnumbered">Resources</h2>
<ul>
<li><a href="https://github.com/Mjrovai/XIAO-ESP32S3-Sense/tree/main/XIAOML_Kit_code">XIAOML KIT Code</a></li>
<li><a href="ch056.xhtml#sec-dsp-spectral-features-overview-a7be">DSP Spectral Features</a></li>
<li><a href="https://studio.edgeimpulse.com/public/750061/live">Edge Impulse Project</a></li>
<li><a href="https://colab.research.google.com/github/Mjrovai/Arduino_Nicla_Vision/blob/main/Motion_Classification/Edge_Impulse_Spectral_Features_Block.ipynb">Edge Impulse Spectral Features Block Colab Notebook</a></li>
<li><a href="https://docs.edgeimpulse.com/">Edge Impulse Documentation</a></li>
<li><a href="https://docs.edgeimpulse.com/docs/edge-impulse-studio/processing-blocks/spectral-features">Edge Impulse Spectral Features</a></li>
<li><a href="https://github.com/Seeed-Studio/Seeed_Arduino_LSM6DS3">Seeed Studio LSM6DS3 Library</a></li>
</ul>
<!-- This is here to make sure that quizzes are inserted properly before a part begins. -->
<div class="quiz-end">

</div>
<div>

</div>
</section>
</section>
</body>
</html>
