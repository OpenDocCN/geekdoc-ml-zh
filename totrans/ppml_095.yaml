- en: Don't block the runtime
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://rust-exercises.com/100-exercises/08_futures/05_blocking.html](https://rust-exercises.com/100-exercises/08_futures/05_blocking.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Let's circle back to yield points.
  prefs: []
  type: TYPE_NORMAL
- en: Unlike threads, **Rust tasks cannot be preempted**.
  prefs: []
  type: TYPE_NORMAL
- en: '`tokio` cannot, on its own, decide to pause a task and run another one in its
    place. The control goes back to the executor **exclusively** when the task yields—i.e.
    when `Future::poll` returns `Poll::Pending` or, in the case of `async fn`, when
    you `.await` a future.'
  prefs: []
  type: TYPE_NORMAL
- en: 'This exposes the runtime to a risk: if a task never yields, the runtime will
    never be able to run another task. This is called **blocking the runtime**.'
  prefs: []
  type: TYPE_NORMAL
- en: '[What is blocking?](#what-is-blocking)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: How long is too long? How much time can a task spend without yielding before
    it becomes a problem?
  prefs: []
  type: TYPE_NORMAL
- en: It depends on the runtime, the application, the number of in-flight tasks, and
    many other factors. But, as a general rule of thumb, try to spend less than 100
    microseconds between yield points.
  prefs: []
  type: TYPE_NORMAL
- en: '[Consequences](#consequences)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Blocking the runtime can lead to:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Deadlocks**: if the task that''s not yielding is waiting for another task
    to complete, and that task is waiting for the first one to yield, you have a deadlock.
    No progress can be made, unless the runtime is able to schedule the other task
    on a different thread.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Starvation**: other tasks might not be able to run, or might run after a
    long delay, which can lead to poor performances (e.g. high tail latencies).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Blocking is not always obvious](#blocking-is-not-always-obvious)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Some types of operations should generally be avoided in async code, like:'
  prefs: []
  type: TYPE_NORMAL
- en: Synchronous I/O. You can't predict how long it will take, and it's likely to
    be longer than 100 microseconds.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Expensive CPU-bound computations.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The latter category is not always obvious though. For example, sorting a vector
    with a few elements is not a problem; that evaluation changes if the vector has
    billions of entries.
  prefs: []
  type: TYPE_NORMAL
- en: '[How to avoid blocking](#how-to-avoid-blocking)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: OK, so how do you avoid blocking the runtime assuming you *must* perform an
    operation that qualifies or risks qualifying as blocking?
  prefs: []
  type: TYPE_NORMAL
- en: You need to move the work to a different thread. You don't want to use the so-called
    runtime threads, the ones used by `tokio` to run tasks.
  prefs: []
  type: TYPE_NORMAL
- en: '`tokio` provides a dedicated threadpool for this purpose, called the **blocking
    pool**. You can spawn a synchronous operation on the blocking pool using the `tokio::task::spawn_blocking`
    function. `spawn_blocking` returns a future that resolves to the result of the
    operation when it completes.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: The blocking pool is long-lived. `spawn_blocking` should be faster than creating
    a new thread directly via `std::thread::spawn` because the cost of thread initialization
    is amortized over multiple calls.
  prefs: []
  type: TYPE_NORMAL
- en: '[Further reading](#further-reading)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Check out [Alice Ryhl's blog post](https://ryhl.io/blog/async-what-is-blocking/)
    on the topic.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Exercise](#exercise)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The exercise for this section is located in [`08_futures/05_blocking`](https://github.com/mainmatter/100-exercises-to-learn-rust/tree/main/exercises/08_futures/05_blocking)
  prefs: []
  type: TYPE_NORMAL
