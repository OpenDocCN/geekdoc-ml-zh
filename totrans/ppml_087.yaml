- en: Readers and writers
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://rust-exercises.com/100-exercises/07_threads/12_rw_lock.html](https://rust-exercises.com/100-exercises/07_threads/12_rw_lock.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'Our new `TicketStore` works, but its read performance is not great: there can
    only be one client at a time reading a specific ticket, because `Mutex<T>` doesn''t
    distinguish between readers and writers.'
  prefs: []
  type: TYPE_NORMAL
- en: 'We can solve the issue by using a different locking primitive: `RwLock<T>`.'
  prefs: []
  type: TYPE_NORMAL
- en: '`RwLock<T>` stands for **read-write lock**. It allows **multiple readers**
    to access the data simultaneously, but only one writer at a time.'
  prefs: []
  type: TYPE_NORMAL
- en: '`RwLock<T>` has two methods to acquire a lock: `read` and `write`.'
  prefs: []
  type: TYPE_NORMAL
- en: '`read` returns a guard that allows you to read the data, while `write` returns
    a guard that allows you to modify it.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '[Trade-offs](#trade-offs)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'On the surface, `RwLock<T>` seems like a no-brainer: it provides a superset
    of the functionality of `Mutex<T>`. Why would you ever use `Mutex<T>` if you can
    use `RwLock<T>` instead?'
  prefs: []
  type: TYPE_NORMAL
- en: 'There are two key reasons:'
  prefs: []
  type: TYPE_NORMAL
- en: Locking a `RwLock<T>` is more expensive than locking a `Mutex<T>`.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: This is because `RwLock<T>` has to keep track of the number of active readers
    and writers, while `Mutex<T>` only has to keep track of whether the lock is held
    or not. This performance overhead is not an issue if there are more readers than
    writers, but if the workload is write-heavy `Mutex<T>` might be a better choice.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '`RwLock<T>` can cause **writer starvation**.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If there are always readers waiting to acquire the lock, writers might never
    get a chance to run.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '`RwLock<T>` doesn''t provide any guarantees about the order in which readers
    and writers are granted access to the lock. It depends on the policy implemented
    by the underlying OS, which might not be fair to writers.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In our case, we can expect the workload to be read-heavy (since most clients
    will be reading tickets, not modifying them), so `RwLock<T>` is a good choice.
  prefs: []
  type: TYPE_NORMAL
- en: '[Exercise](#exercise)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The exercise for this section is located in [`07_threads/12_rw_lock`](https://github.com/mainmatter/100-exercises-to-learn-rust/tree/main/exercises/07_threads/12_rw_lock)
  prefs: []
  type: TYPE_NORMAL
