<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <title>ch053.xhtml</title>
  <style>
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css" />
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    padding-bottom: 0.5rem;
    margin-bottom: 0;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    /* Figure formatting */
    .quarto-layout-panel>figure>figcaption,
    .quarto-layout-panel>.panel-caption {
      margin-top: 10pt;
    }

    .quarto-layout-row {
      display: flex;
      align-items: flex-start;
    }

    .quarto-layout-valign-top {
      align-items: flex-start;
    }

    .quarto-layout-valign-bottom {
      align-items: flex-end;
    }

    .quarto-layout-valign-center {
      align-items: center;
    }

    .quarto-layout-cell {
      position: relative;
      margin-right: 20px;
    }

    .quarto-layout-cell:last-child {
      margin-right: 0;
    }

    .quarto-layout-cell figure,
    .quarto-layout-cell>p {
      margin: 0.2em;
    }

    .quarto-layout-cell .html-widget {
      width: 100% !important;
    }

    .quarto-layout-cell div figure p {
      margin: 0;
    }

    .quarto-layout-cell figure {
      display: inline-block;
      margin-inline-start: 0;
      margin-inline-end: 0;
    }

    .quarto-layout-cell table {
      display: inline-table;
    }

    .quarto-layout-cell-subref figcaption {
      font-style: italic;
      text-align: center;
    }

    .quarto-figure>figure {
      width: 100%;
    }

    .quarto-figure-left>figure>p {
      text-align: left;
    }

    .quarto-figure-center>figure>p {
      text-align: center;
    }

    .quarto-figure-right>figure>p {
      text-align: right;
    }

    figure>p:empty {
      display: none;
    }

    figure>p:first-child {
      margin-top: 0;
      margin-bottom: 0;
    }

    figure>figcaption {
      margin-top: 0.5em;
    }

    figcaption {
      font-size: 0.8em;
    }

    details {
      margin-bottom: 1em;
    }

    details[show] {
      margin-bottom: 0;
    }

    .quarto-unresolved-ref {
      font-weight: 600;
    }

    .quarto-cover-image {
      float: right;
      margin-left: 30px;
    }

    .cell-output-display {
      overflow-x: scroll;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body epub:type="bodymatter">
<section id="vision-language-models-vlm" class="level1 unnumbered">
<h1 class="unnumbered">Vision-Language Models (VLM)</h1>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="../media/file941.jpg" alt="" /></p>
<figcaption><em>DALL·E prompt - A Raspberry Pi setup featuring vision tasks. The image shows a Raspberry Pi connected to a camera, with various computer vision tasks displayed visually around it, including object detection, image captioning, segmentation, and visual grounding. The Raspberry Pi is placed on a desk, with a display showing bounding boxes and annotations related to these tasks. The background should be a home workspace, with tools and devices typically used by developers and hobbyists.</em></figcaption>
</figure>
</div>
<section id="sec-visionlanguage-models-vlm-introduction-4272" class="level2 unnumbered">
<h2 class="unnumbered">Introduction</h2>
<p>In this hands-on lab, we will continuously explore AI applications at the Edge, from the basic setup of the Florence-2, Microsoft’s state-of-the-art vision foundation model, to advanced implementations on devices like the Raspberry Pi. We will learn to use Vision Language Models (VLMs) for tasks such as captioning, object detection, grounding, segmentation, and OCR on a Raspberry Pi.</p>
<section id="sec-visionlanguage-models-vlm-florence2-edge-0534" class="level3 unnumbered">
<h3 class="unnumbered">Why Florence-2 at the Edge?</h3>
<p><a href="https://arxiv.org/abs/2311.06242">Florence-2</a> is a vision-language model open-sourced by Microsoft under the MIT license, which significantly advances vision-language models by combining a lightweight architecture with robust capabilities. Thanks to its training on the massive FLD-5B dataset, which contains 126 million images and 5.4 billion visual annotations, it achieves performance comparable to larger models. This makes Florence-2 ideal for deployment at the edge, where power and computational resources are limited.</p>
<p>In this tutorial, we will explore how to use Florence-2 for real-time computer vision applications, such as:</p>
<ul>
<li>Image captioning</li>
<li>Object detection</li>
<li>Segmentation</li>
<li>Visual grounding</li>
</ul>
<blockquote>
<p><strong>Visual grounding</strong> involves linking textual descriptions to specific regions within an image. This enables the model to understand where particular objects or entities described in a prompt are in the image. For example, if the prompt is “a red car,” the model will identify and highlight the region where the red car is found in the image. Visual grounding is helpful for applications where precise alignment between text and visual content is needed, such as human-computer interaction, image annotation, and interactive AI systems.</p>
</blockquote>
<p>In the tutorial, we will walk through:</p>
<ul>
<li>Setting up Florence-2 on the Raspberry Pi</li>
<li>Running inference tasks such as object detection and captioning</li>
<li>Optimizing the model to get the best performance from the edge device</li>
<li>Exploring practical, real-world applications with fine-tuning.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-florence2-model-architecture-b695" class="level3 unnumbered">
<h3 class="unnumbered">Florence-2 Model Architecture</h3>
<p>Florence-2 utilizes a unified, prompt-based representation to handle various vision-language tasks. The model architecture consists of two main components: an <strong>image encoder</strong> and a <strong>multi-modal transformer encoder-decoder</strong>.</p>
<img src="../media/file942.svg" alt="" />
<ul>
<li><p><strong>Image Encoder</strong>: The image encoder is based on the <a href="https://arxiv.org/abs/2204.03645">DaViT (Dual Attention Vision Transformers) architecture</a>. It converts input images into a series of visual token embeddings. These embeddings serve as the foundational representations of the visual content, capturing both spatial and contextual information about the image.</p></li>
<li><p><strong>Multi-Modal Transformer Encoder-Decoder</strong>: Florence-2’s core is the multi-modal transformer encoder-decoder, which combines visual token embeddings from the image encoder with textual embeddings generated by a BERT-like model. This combination allows the model to simultaneously process visual and textual inputs, enabling a unified approach to tasks such as image captioning, object detection, and segmentation.</p></li>
</ul>
<p>The model’s training on the extensive FLD-5B dataset ensures it can effectively handle diverse vision tasks without requiring task-specific modifications. Florence-2 uses textual prompts to activate specific tasks, making it highly flexible and capable of zero-shot generalization. For tasks like object detection or visual grounding, the model incorporates additional location tokens to represent regions within the image, ensuring a precise understanding of spatial relationships.</p>
<blockquote>
<p>Florence-2’s compact architecture and innovative training approach allow it to perform computer vision tasks accurately, even on resource-constrained devices like the Raspberry Pi.</p>
</blockquote>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-technical-overview-faee" class="level2 unnumbered">
<h2 class="unnumbered">Technical Overview</h2>
<p>Florence-2 introduces several innovative features that set it apart:</p>
<section id="sec-visionlanguage-models-vlm-architecture-9992" class="level3 unnumbered">
<h3 class="unnumbered">Architecture</h3>
<p> <img src="../media/file943.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<ul>
<li><strong>Lightweight Design</strong>: Two variants available
<ul>
<li>Florence-2-Base: 232 million parameters</li>
<li>Florence-2-Large: 771 million parameters</li>
</ul></li>
<li><strong>Unified Representation</strong>: Handles multiple vision tasks through a single architecture</li>
<li><strong>DaViT Vision Encoder</strong>: Converts images into visual token embeddings</li>
<li><strong>Transformer-based Multi-modal Encoder-Decoder</strong>: Processes combined visual and text embeddings</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-training-dataset-fld5b-2779" class="level3 unnumbered">
<h3 class="unnumbered">Training Dataset (FLD-5B)</h3>
<p> <img src="../media/file944.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<ul>
<li>126 million unique images</li>
<li>5.4 billion comprehensive annotations, including:
<ul>
<li>500M text annotations</li>
<li>1.3B region-text annotations</li>
<li>3.6B text-phrase-region annotations</li>
</ul></li>
<li>Automated annotation pipeline using specialist models</li>
<li>Iterative refinement process for high-quality labels</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-key-capabilities-2707" class="level3 unnumbered">
<h3 class="unnumbered">Key Capabilities</h3>
<p>Florence-2 excels in multiple vision tasks:</p>
<section id="sec-visionlanguage-models-vlm-zeroshot-performance-e3c6" class="level4 unnumbered">
<h4 class="unnumbered">Zero-shot Performance</h4>
<ul>
<li>Image Captioning: Achieves 135.6 CIDEr score on COCO</li>
<li>Visual Grounding: 84.4% recall@1 on Flickr30k</li>
<li>Object Detection: 37.5 mAP on COCO val2017</li>
<li>Referring Expression: 67.0% accuracy on RefCOCO</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-finetuned-performance-119c" class="level4 unnumbered">
<h4 class="unnumbered">Fine-tuned Performance</h4>
<ul>
<li>Competitive with specialist models despite the smaller size</li>
<li>Outperforms larger models in specific benchmarks</li>
<li>Efficient adaptation to new tasks</li>
</ul>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-practical-applications-4b8f" class="level3 unnumbered">
<h3 class="unnumbered">Practical Applications</h3>
<p>Florence-2 can be applied across various domains:</p>
<ol type="1">
<li><strong>Content Understanding</strong>
<ul>
<li>Automated image captioning for accessibility</li>
<li>Visual content moderation</li>
<li>Media asset management</li>
</ul></li>
<li><strong>E-commerce</strong>
<ul>
<li>Product image analysis</li>
<li>Visual search</li>
<li>Automated product tagging</li>
</ul></li>
<li><strong>Healthcare</strong>
<ul>
<li>Medical image analysis</li>
<li>Diagnostic assistance</li>
<li>Research data processing</li>
</ul></li>
<li><strong>Security &amp; Surveillance</strong>
<ul>
<li>Object detection and tracking</li>
<li>Anomaly detection</li>
<li>Scene understanding</li>
</ul></li>
</ol>
</section>
<section id="sec-visionlanguage-models-vlm-comparing-florence2-vlms-b507" class="level3 unnumbered">
<h3 class="unnumbered">Comparing Florence-2 with other VLMs</h3>
<p>Florence-2 stands out from other visual language models due to its impressive zero-shot capabilities. Unlike models like <a href="https://huggingface.co/blog/paligemma">Google PaliGemma</a>, which rely on extensive fine-tuning to adapt to various tasks, Florence-2 works right out of the box, as we will see in this lab. It can also compete with larger models like GPT-4V and Flamingo, which often have many more parameters but only sometimes match Florence-2’s performance. For example, Florence-2 achieves better zero-shot results than Kosmos-2 despite having over twice the parameters.</p>
<p>In benchmark tests, Florence-2 has shown remarkable performance in tasks like COCO captioning and referring expression comprehension. It outperformed models like PolyFormer and UNINEXT in object detection and segmentation tasks on the <a href="https://docs.ultralytics.com/datasets/detect/coco/">COCO dataset</a>. It is a highly competitive choice for real-world applications where both performance and resource efficiency are crucial.</p>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-setup-installation-78de" class="level2 unnumbered">
<h2 class="unnumbered">Setup and Installation</h2>
<p>Our choice of edge device is the Raspberry Pi 5 (Raspi-5). Its robust platform is equipped with the Broadcom BCM2712, a 2.4 GHz quad-core 64-bit Arm Cortex-A76 CPU featuring Cryptographic Extension and enhanced caching capabilities. It boasts a VideoCore VII GPU, dual 4Kp60 HDMI® outputs with HDR, and a 4Kp60 HEVC decoder. Memory options include 4 GB and 8 GB of high-speed LPDDR4X SDRAM, with 8 GB being our choice to run Florence-2. It also features expandable storage via a microSD card slot and a PCIe 2.0 interface for fast peripherals such as M.2 SSDs (Solid State Drives).</p>
<blockquote>
<p>For real applications, SSDs are a better option than SD cards.</p>
</blockquote>
<p>We suggest installing an Active Cooler, a dedicated clip-on cooling solution for Raspberry Pi 5 (Raspi-5), for this lab. It combines an aluminum heat sink with a temperature-controlled blower fan to keep the Raspi-5 operating comfortably under heavy loads, such as running Florense-2.</p>
<p> <img src="../media/file945.jpg" class="quarto-figure quarto-figure-center" style="width:80.0%" alt="" /></p>
<section id="sec-visionlanguage-models-vlm-environment-configuration-0062" class="level3 unnumbered">
<h3 class="unnumbered">Environment configuration</h3>
<p>To run <a href="https://huggingface.co/microsoft/Florence-2-base">Microsoft Florense-2</a> on the Raspberry Pi 5, we’ll need a few libraries:</p>
<ol type="1">
<li><strong><a href="https://huggingface.co/docs/transformers/en/index">Transformers</a></strong>:
<ul>
<li>Florence-2 uses the <code>transformers</code> library from Hugging Face for model loading and inference. This library provides the architecture for working with pre-trained vision-language models, making it easy to perform tasks like image captioning, object detection, and more. Essentially, <code>transformers</code> helps in interacting with the model, processing input prompts, and obtaining outputs.</li>
</ul></li>
<li><strong>PyTorch</strong>:
<ul>
<li>PyTorch is a deep learning framework that provides the infrastructure needed to run the Florence-2 model, which includes tensor operations, GPU acceleration (if a GPU is available), and model training/inference functionalities. The Florence-2 model is trained in PyTorch, and we need it to leverage its functions, layers, and computation capabilities to perform inferences on the Raspberry Pi.</li>
</ul></li>
<li><strong>Timm</strong> (PyTorch Image Models):
<ul>
<li>Florence-2 uses <code>timm</code> to access efficient implementations of vision models and pre-trained weights. Specifically, the <code>timm</code> library is utilized for the <strong>image encoder</strong> part of Florence-2, particularly for managing the DaViT architecture. It provides model definitions and optimized code for common vision tasks and allows the easy integration of different backbones that are lightweight and suitable for edge devices.</li>
</ul></li>
<li><strong>Einops</strong>:
<ul>
<li><code>Einops</code> is a library for flexible and powerful tensor operations. It makes it easy to reshape and manipulate tensor dimensions, which is especially important for the multi-modal processing done in Florence-2. Vision-language models like Florence-2 often need to rearrange image data, text embeddings, and visual embeddings to align correctly for the transformer blocks, and <code>einops</code> simplifies these complex operations, making the code more readable and concise.</li>
</ul></li>
</ol>
<p>In short, these libraries enable different essential components of Florence-2:</p>
<ul>
<li><strong>Transformers</strong> and <strong>PyTorch</strong> are needed to load the model and run the inference.</li>
<li><strong>Timm</strong> is used to access and efficiently implement the vision encoder.</li>
<li><strong>Einops</strong> helps reshape data, facilitating the integration of visual and text features.</li>
</ul>
<p>All these components work together to help Florence-2 run seamlessly on our Raspberry Pi, allowing it to perform complex vision-language tasks relatively quickly.</p>
<p>Considering that the Raspberry Pi already has its OS installed, let’s use <code>SSH</code> to reach it from another computer:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">ssh</span> mjrovai@raspi-5.local</span></code></pre></div>
<p>And check the IP allocated to it:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">hostname</span> <span class="at">-I</span></span></code></pre></div>
<p><code>192.168.4.209</code></p>
<p> <img src="../media/file946.png" alt="" /></p>
<p><strong>Updating the Raspberry Pi</strong></p>
<p>First, ensure your Raspberry Pi is up to date:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">sudo</span> apt upgrade <span class="at">-y</span></span></code></pre></div>
<p><strong>Initial setup for using PIP</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">sudo</span> apt install python3-pip</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">sudo</span> rm /usr/lib/python3.11/EXTERNALLY-MANAGED</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ex">pip3</span> install <span class="at">--upgrade</span> pip</span></code></pre></div>
<p><strong>Install Dependencies</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">sudo</span> apt-get install libjpeg-dev libopenblas-dev libopenmpi-dev <span class="dt">\</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>    libomp-dev</span></code></pre></div>
<p>Let’s set up and activate a <strong>Virtual Environment</strong> for working with Florence-2:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">python3</span> <span class="at">-m</span> venv ~/florence</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="bu">source</span> ~/florence/bin/activate</span></code></pre></div>
<p><strong>Install PyTorch</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">pip3</span> install setuptools numpy Cython</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ex">pip3</span> install requests</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="ex">pip3</span> install torch torchvision <span class="dt">\</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="at">--index-url</span> https://download.pytorch.org/whl/cpu</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="ex">pip3</span> install torchaudio <span class="dt">\</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="at">--index-url</span> https://download.pytorch.org/whl/cpu</span></code></pre></div>
<p>Let’s verify that PyTorch is correctly installed:</p>
<p> <img src="../media/file947.png" alt="" /></p>
<p><strong>Install Transformers, Timm and Einops</strong>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">pip3</span> install transformers</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">pip3</span> install timm einops</span></code></pre></div>
<p><strong>Install the model</strong>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">pip3</span> install autodistill-florence-2</span></code></pre></div>
<p><strong>Jupyter Notebook and Python libraries</strong></p>
<p>Installing a Jupyter Notebook to run and test our Python scripts is possible.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">pip3</span> install jupyter</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ex">pip3</span> install numpy Pillow matplotlib</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="ex">jupyter</span> notebook <span class="at">--generate-config</span></span></code></pre></div>
</section>
<section id="sec-visionlanguage-models-vlm-testing-installation-4988" class="level3 unnumbered">
<h3 class="unnumbered">Testing the installation</h3>
<p>Running the Jupyter Notebook on the remote computer</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">jupyter</span> notebook <span class="at">--ip</span><span class="op">=</span>192.168.4.209 <span class="at">--no-browser</span></span></code></pre></div>
<p>Running the above command on the SSH terminal, we can see the local URL address to open the notebook:</p>
<p> <img src="../media/file948.png" alt="" /></p>
<p>The notebook with the code used on this initial test can be found on the Lab GitHub:</p>
<ul>
<li><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/FLORENCE-2/notebooks/10-florence2_test.ipynb">10-florence2_test.ipynb</a></li>
</ul>
<p>We can access it on the remote computer by entering the Raspberry Pi’s IP address and the provided token in a web browser (copy the entire URL from the terminal).</p>
<p>From the Home page, create a new notebook [<code>Python 3 (ipykernel)</code> ] and copy and paste the <a href="https://huggingface.co/microsoft/Florence-2-base#how-to-get-started-with-the-model">example code</a> from Hugging Face Hub.</p>
<p>The code is designed to run Florence-2 on a given image to perform <strong>object detection</strong>. It loads the model, processes an image and a prompt, and then generates a response to identify and describe the objects in the image.</p>
<ul>
<li>The <strong>processor</strong> helps prepare text and image inputs.</li>
<li>The <strong>model</strong> takes the processed inputs to generate a meaningful response.</li>
<li>The <strong>post-processing</strong> step refines the generated output into a more interpretable form, like bounding boxes for detected objects.</li>
</ul>
<blockquote>
<p>This workflow leverages the versatility of Florence-2 to handle <strong>vision-language tasks</strong> and is implemented efficiently using PyTorch, Transformers, and related image-processing tools.</p>
</blockquote>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="im">import</span> requests</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="im">import</span> torch</span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="im">from</span> transformers <span class="im">import</span> AutoProcessor, AutoModelForCausalLM</span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a>device <span class="op">=</span> <span class="st">&quot;cuda:0&quot;</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">&quot;cpu&quot;</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>torch_dtype <span class="op">=</span> (</span>
<span id="cb12-8"><a href="#cb12-8"></a>    torch.float16 <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> torch.float32</span>
<span id="cb12-9"><a href="#cb12-9"></a>)</span>
<span id="cb12-10"><a href="#cb12-10"></a></span>
<span id="cb12-11"><a href="#cb12-11"></a>model <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb12-12"><a href="#cb12-12"></a>    <span class="st">&quot;microsoft/Florence-2-base&quot;</span>,</span>
<span id="cb12-13"><a href="#cb12-13"></a>    torch_dtype<span class="op">=</span>torch_dtype,</span>
<span id="cb12-14"><a href="#cb12-14"></a>    trust_remote_code<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb12-15"><a href="#cb12-15"></a>).to(device)</span>
<span id="cb12-16"><a href="#cb12-16"></a>processor <span class="op">=</span> AutoProcessor.from_pretrained(</span>
<span id="cb12-17"><a href="#cb12-17"></a>    <span class="st">&quot;microsoft/Florence-2-base&quot;</span>, trust_remote_code<span class="op">=</span><span class="va">True</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>)</span>
<span id="cb12-19"><a href="#cb12-19"></a></span>
<span id="cb12-20"><a href="#cb12-20"></a>prompt <span class="op">=</span> <span class="st">&quot;&lt;OD&gt;&quot;</span></span>
<span id="cb12-21"><a href="#cb12-21"></a></span>
<span id="cb12-22"><a href="#cb12-22"></a>url <span class="op">=</span> (</span>
<span id="cb12-23"><a href="#cb12-23"></a>    <span class="st">&quot;https://huggingface.co/datasets/huggingface/&quot;</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>    <span class="st">&quot;documentation-images/resolve/main/transformers/&quot;</span></span>
<span id="cb12-25"><a href="#cb12-25"></a>    <span class="st">&quot;tasks/car.jpg?download=true&quot;</span></span>
<span id="cb12-26"><a href="#cb12-26"></a>)</span>
<span id="cb12-27"><a href="#cb12-27"></a>image <span class="op">=</span> Image.<span class="bu">open</span>(requests.get(url, stream<span class="op">=</span><span class="va">True</span>).raw)</span>
<span id="cb12-28"><a href="#cb12-28"></a></span>
<span id="cb12-29"><a href="#cb12-29"></a>inputs <span class="op">=</span> processor(text<span class="op">=</span>prompt, images<span class="op">=</span>image, return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span>).to(</span>
<span id="cb12-30"><a href="#cb12-30"></a>    device, torch_dtype</span>
<span id="cb12-31"><a href="#cb12-31"></a>)</span>
<span id="cb12-32"><a href="#cb12-32"></a></span>
<span id="cb12-33"><a href="#cb12-33"></a>generated_ids <span class="op">=</span> model.generate(</span>
<span id="cb12-34"><a href="#cb12-34"></a>    input_ids<span class="op">=</span>inputs[<span class="st">&quot;input_ids&quot;</span>],</span>
<span id="cb12-35"><a href="#cb12-35"></a>    pixel_values<span class="op">=</span>inputs[<span class="st">&quot;pixel_values&quot;</span>],</span>
<span id="cb12-36"><a href="#cb12-36"></a>    max_new_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb12-37"><a href="#cb12-37"></a>    do_sample<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb12-38"><a href="#cb12-38"></a>    num_beams<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb12-39"><a href="#cb12-39"></a>)</span>
<span id="cb12-40"><a href="#cb12-40"></a>generated_text <span class="op">=</span> processor.batch_decode(</span>
<span id="cb12-41"><a href="#cb12-41"></a>    generated_ids, skip_special_tokens<span class="op">=</span><span class="va">False</span></span>
<span id="cb12-42"><a href="#cb12-42"></a>)[<span class="dv">0</span>]</span>
<span id="cb12-43"><a href="#cb12-43"></a></span>
<span id="cb12-44"><a href="#cb12-44"></a>parsed_answer <span class="op">=</span> processor.post_process_generation(</span>
<span id="cb12-45"><a href="#cb12-45"></a>    generated_text,</span>
<span id="cb12-46"><a href="#cb12-46"></a>    task<span class="op">=</span><span class="st">&quot;&lt;OD&gt;&quot;</span>,</span>
<span id="cb12-47"><a href="#cb12-47"></a>    image_size<span class="op">=</span>(image.width, image.height),</span>
<span id="cb12-48"><a href="#cb12-48"></a>)</span>
<span id="cb12-49"><a href="#cb12-49"></a></span>
<span id="cb12-50"><a href="#cb12-50"></a><span class="bu">print</span>(parsed_answer)</span></code></pre></div>
<p>Let’s break down the provided code step by step:</p>
<section id="sec-visionlanguage-models-vlm-importing-required-libraries-1ee5" class="level4 unnumbered">
<h4 class="unnumbered">Importing Required Libraries</h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="im">import</span> requests</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="im">import</span> torch</span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="im">from</span> transformers <span class="im">import</span> AutoProcessor, AutoModelForCausalLM</span></code></pre></div>
<ul>
<li><strong>requests</strong>: Used to make HTTP requests. In this case, it downloads an image from a URL.</li>
<li><strong>PIL (Pillow)</strong>: Provides tools for manipulating images. Here, it’s used to open the downloaded image.</li>
<li><strong>torch</strong>: PyTorch is imported to handle tensor operations and determine the hardware availability (CPU or GPU).</li>
<li><strong>transformers</strong>: This module provides easy access to Florence-2 by using <code>AutoProcessor</code> and <code>AutoModelForCausalLM</code> to load pre-trained models and process inputs.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-determining-device-data-type-4011" class="level4 unnumbered">
<h4 class="unnumbered">Determining the Device and Data Type</h4>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>device <span class="op">=</span> <span class="st">&quot;cuda:0&quot;</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">&quot;cpu&quot;</span></span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a>torch_dtype <span class="op">=</span> (</span>
<span id="cb14-4"><a href="#cb14-4"></a>    torch.float16 <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> torch.float32</span>
<span id="cb14-5"><a href="#cb14-5"></a>)</span></code></pre></div>
<ul>
<li><strong>Device Setup</strong>: The code checks if a CUDA-enabled GPU is available (<code>torch.cuda.is_available()</code>). The device is set to “cuda:0” if a GPU is available. Otherwise, it defaults to <code>"cpu"</code> (our case here).</li>
<li><strong>Data Type Setup</strong>: If a GPU is available, <code>torch.float16</code> is chosen, which uses half-precision floats to speed up processing and reduce memory usage. On the CPU, it defaults to <code>torch.float32</code> to maintain compatibility.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-loading-model-processor-fb73" class="level4 unnumbered">
<h4 class="unnumbered">Loading the Model and Processor</h4>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>model <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb15-2"><a href="#cb15-2"></a>    <span class="st">&quot;microsoft/Florence-2-base&quot;</span>,</span>
<span id="cb15-3"><a href="#cb15-3"></a>    torch_dtype<span class="op">=</span>torch_dtype,</span>
<span id="cb15-4"><a href="#cb15-4"></a>    trust_remote_code<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-5"><a href="#cb15-5"></a>).to(device)</span>
<span id="cb15-6"><a href="#cb15-6"></a></span>
<span id="cb15-7"><a href="#cb15-7"></a>processor <span class="op">=</span> AutoProcessor.from_pretrained(</span>
<span id="cb15-8"><a href="#cb15-8"></a>    <span class="st">&quot;microsoft/Florence-2-base&quot;</span>, trust_remote_code<span class="op">=</span><span class="va">True</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>)</span></code></pre></div>
<ul>
<li><strong>Model Initialization</strong>:
<ul>
<li><strong><code>AutoModelForCausalLM.from_pretrained()</code></strong> loads the pre-trained Florence-2 model from Microsoft’s repository on Hugging Face. The <code>torch_dtype</code> is set according to the available hardware (GPU/CPU), and <code>trust_remote_code=True</code> allows the use of any custom code that might be provided with the model.</li>
<li><strong><code>.to(device)</code></strong> moves the model to the appropriate device (either CPU or GPU). In our case, it will be set to <code>CPU</code>.</li>
</ul></li>
<li><strong>Processor Initialization</strong>:
<ul>
<li><strong><code>AutoProcessor.from_pretrained()</code></strong> loads the processor for Florence-2. The processor is responsible for transforming text and image inputs into a format the model can work with (e.g., encoding text, normalizing images, etc.).</li>
</ul></li>
</ul>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-defining-prompt-2cd2" class="level3 unnumbered">
<h3 class="unnumbered">Defining the Prompt</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>prompt <span class="op">=</span> <span class="st">&quot;&lt;OD&gt;&quot;</span></span></code></pre></div>
<ul>
<li><strong>Prompt Definition</strong>: The string <code>"&lt;OD&gt;"</code> is used as a prompt. This refers to “Object Detection”, instructing the model to detect objects on the image.</li>
</ul>
<section id="sec-visionlanguage-models-vlm-downloading-loading-image-e518" class="level4 unnumbered">
<h4 class="unnumbered">Downloading and Loading the Image</h4>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>url <span class="op">=</span> <span class="st">&quot;https://huggingface.co/datasets/huggingface/&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>      <span class="co">&quot;documentation-images/resolve/main/transformers/&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>      <span class="co">&quot;tasks/car.jpg?download=true&quot;</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>image <span class="op">=</span> Image.<span class="bu">open</span>(requests.get(url, stream<span class="op">=</span><span class="va">True</span>).raw)</span></code></pre></div>
<ul>
<li><strong>Downloading the Image</strong>: The <strong><code>requests.get()</code></strong> function fetches the image from the specified URL. The <code>stream=True</code> parameter ensures the image is streamed rather than downloaded completely at once.</li>
<li><strong>Opening the Image</strong>: <strong><code>Image.open()</code></strong> opens the image so the model can process it.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-processing-inputs-14e0" class="level4 unnumbered">
<h4 class="unnumbered">Processing Inputs</h4>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>inputs <span class="op">=</span> processor(text<span class="op">=</span>prompt, images<span class="op">=</span>image, return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span>).to(</span>
<span id="cb18-2"><a href="#cb18-2"></a>    device, torch_dtype</span>
<span id="cb18-3"><a href="#cb18-3"></a>)</span></code></pre></div>
<ul>
<li><strong>Processing Input Data</strong>: The <strong><code>processor()</code></strong> function processes the text (<code>prompt</code>) and the image (<code>image</code>). The <code>return_tensors="pt"</code> argument converts the processed data into PyTorch tensors, which are necessary for inputting data into the model.</li>
<li><strong>Moving Inputs to Device</strong>: <strong><code>.to(device, torch_dtype)</code></strong> moves the inputs to the correct device (CPU or GPU) and assigns the appropriate data type.</li>
</ul>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-generating-output-6e10" class="level3 unnumbered">
<h3 class="unnumbered">Generating the Output</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>generated_ids <span class="op">=</span> model.generate(</span>
<span id="cb19-2"><a href="#cb19-2"></a>    input_ids<span class="op">=</span>inputs[<span class="st">&quot;input_ids&quot;</span>],</span>
<span id="cb19-3"><a href="#cb19-3"></a>    pixel_values<span class="op">=</span>inputs[<span class="st">&quot;pixel_values&quot;</span>],</span>
<span id="cb19-4"><a href="#cb19-4"></a>    max_new_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb19-5"><a href="#cb19-5"></a>    do_sample<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb19-6"><a href="#cb19-6"></a>    num_beams<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb19-7"><a href="#cb19-7"></a>)</span></code></pre></div>
<ul>
<li><strong>Model Generation</strong>: <strong><code>model.generate()</code></strong> is used to generate the output based on the input data.
<ul>
<li><strong><code>input_ids</code></strong>: Represents the tokenized form of the prompt.</li>
<li><strong><code>pixel_values</code></strong>: Contains the processed image data.</li>
<li><strong><code>max_new_tokens=1024</code></strong>: Specifies the maximum number of new tokens to be generated in the response. This limits the response length.</li>
<li><strong><code>do_sample=False</code></strong>: Disables sampling; instead, the generation uses deterministic methods (beam search).</li>
<li><strong><code>num_beams=3</code></strong>: Enables beam search with three beams, which improves output quality by considering multiple possibilities during generation.</li>
</ul></li>
</ul>
<section id="sec-visionlanguage-models-vlm-decoding-generated-text-70e0" class="level4 unnumbered">
<h4 class="unnumbered">Decoding the Generated Text</h4>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>generated_text <span class="op">=</span> processor.batch_decode(</span>
<span id="cb20-2"><a href="#cb20-2"></a>    generated_ids, skip_special_tokens<span class="op">=</span><span class="va">False</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>)[<span class="dv">0</span>]</span></code></pre></div>
<ul>
<li><strong>Batch Decode</strong>: <strong><code>processor.batch_decode()</code></strong> decodes the generated IDs (tokens) into readable text. The <code>skip_special_tokens=False</code> parameter means that the output will include any special tokens that may be part of the response.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-postprocessing-generation-6592" class="level4 unnumbered">
<h4 class="unnumbered">Post-processing the Generation</h4>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>parsed_answer <span class="op">=</span> processor.post_process_generation(</span>
<span id="cb21-2"><a href="#cb21-2"></a>    generated_text,</span>
<span id="cb21-3"><a href="#cb21-3"></a>    task<span class="op">=</span><span class="st">&quot;&lt;OD&gt;&quot;</span>,</span>
<span id="cb21-4"><a href="#cb21-4"></a>    image_size<span class="op">=</span>(image.width, image.height),</span>
<span id="cb21-5"><a href="#cb21-5"></a>)</span></code></pre></div>
<ul>
<li><strong>Post-Processing</strong>: <strong><code>processor.post_process_generation()</code></strong> is called to process the generated text further, interpreting it based on the task (<code>"&lt;OD&gt;"</code> for object detection) and the size of the image.</li>
<li>This function extracts specific information from the generated text, such as bounding boxes for detected objects, making the output more useful for visual tasks.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-printing-output-8a57" class="level4 unnumbered">
<h4 class="unnumbered">Printing the Output</h4>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a><span class="bu">print</span>(parsed_answer)</span></code></pre></div>
<ul>
<li>Finally, <strong><code>print(parsed_answer)</code></strong> displays the output, which could include object detection results, such as bounding box coordinates and labels for the detected objects in the image.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-result-0a91" class="level4 unnumbered">
<h4 class="unnumbered">Result</h4>
<p>Running the code, we get as the Parsed Answer:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="ex">[{</span><span class="st">&#39;&lt;OD&gt;&#39;</span><span class="ex">:</span> {</span>
<span id="cb23-2"><a href="#cb23-2"></a>   <span class="st">&#39;bboxes&#39;</span><span class="ex">:</span> [</span>
<span id="cb23-3"><a href="#cb23-3"></a>     <span class="ex">[34.23999786376953,</span> 160.0800018310547, 597.4400024414062],</span>
<span id="cb23-4"><a href="#cb23-4"></a>     <span class="ex">[371.7599792480469,</span> 272.32000732421875, 241.67999267578125],</span>
<span id="cb23-5"><a href="#cb23-5"></a>     <span class="ex">[303.67999267578125,</span> 247.4399871826172, 454.0799865722656],</span>
<span id="cb23-6"><a href="#cb23-6"></a>     <span class="ex">[276.7200012207031,</span> 553.9199829101562, 370.79998779296875],</span>
<span id="cb23-7"><a href="#cb23-7"></a>     <span class="ex">[96.31999969482422,</span> 280.55999755859375, 198.0800018310547],</span>
<span id="cb23-8"><a href="#cb23-8"></a>     <span class="ex">[371.2799987792969]</span></span>
<span id="cb23-9"><a href="#cb23-9"></a>    <span class="ex">],</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>    <span class="st">&#39;labels&#39;</span><span class="ex">:</span> [<span class="st">&#39;car&#39;</span>, <span class="st">&#39;door handle&#39;</span>, <span class="st">&#39;wheel&#39;</span>, <span class="st">&#39;wheel&#39;</span>]</span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="er">}}</span><span class="ex">]</span></span></code></pre></div>
<p>First, let’s inspect the image:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb24-4"><a href="#cb24-4"></a>plt.imshow(image)</span>
<span id="cb24-5"><a href="#cb24-5"></a>plt.axis(<span class="st">&quot;off&quot;</span>)</span>
<span id="cb24-6"><a href="#cb24-6"></a>plt.show()</span></code></pre></div>
<p> <img src="../media/file949.png" class="quarto-figure quarto-figure-center" style="width:80.0%" alt="" /></p>
<p>By the Object Detection result, we can see that:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="st">&#39;labels&#39;</span><span class="ex">:</span> [<span class="st">&#39;car&#39;</span>, <span class="st">&#39;door handle&#39;</span>, <span class="st">&#39;wheel&#39;</span>, <span class="st">&#39;wheel&#39;</span>]</span></code></pre></div>
<p>It seems that at least a few objects were detected. We can also implement a code to draw the bounding boxes in the find objects:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">def</span> plot_bbox(image, data):</span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="co"># Create a figure and axes</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>    fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb26-4"><a href="#cb26-4"></a></span>
<span id="cb26-5"><a href="#cb26-5"></a>    <span class="co"># Display the image</span></span>
<span id="cb26-6"><a href="#cb26-6"></a>    ax.imshow(image)</span>
<span id="cb26-7"><a href="#cb26-7"></a></span>
<span id="cb26-8"><a href="#cb26-8"></a>    <span class="co"># Plot each bounding box</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>    <span class="cf">for</span> bbox, label <span class="kw">in</span> <span class="bu">zip</span>(data[<span class="st">&quot;bboxes&quot;</span>], data[<span class="st">&quot;labels&quot;</span>]):</span>
<span id="cb26-10"><a href="#cb26-10"></a>        <span class="co"># Unpack the bounding box coordinates</span></span>
<span id="cb26-11"><a href="#cb26-11"></a>        x1, y1, x2, y2 <span class="op">=</span> bbox</span>
<span id="cb26-12"><a href="#cb26-12"></a>        <span class="co"># Create a Rectangle patch</span></span>
<span id="cb26-13"><a href="#cb26-13"></a>        rect <span class="op">=</span> patches.Rectangle(</span>
<span id="cb26-14"><a href="#cb26-14"></a>            (x1, y1),</span>
<span id="cb26-15"><a href="#cb26-15"></a>            x2 <span class="op">-</span> x1,</span>
<span id="cb26-16"><a href="#cb26-16"></a>            y2 <span class="op">-</span> y1,</span>
<span id="cb26-17"><a href="#cb26-17"></a>            linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb26-18"><a href="#cb26-18"></a>            edgecolor<span class="op">=</span><span class="st">&quot;r&quot;</span>,</span>
<span id="cb26-19"><a href="#cb26-19"></a>            facecolor<span class="op">=</span><span class="st">&quot;none&quot;</span>,</span>
<span id="cb26-20"><a href="#cb26-20"></a>        )</span>
<span id="cb26-21"><a href="#cb26-21"></a>        <span class="co"># Add the rectangle to the Axes</span></span>
<span id="cb26-22"><a href="#cb26-22"></a>        ax.add_patch(rect)</span>
<span id="cb26-23"><a href="#cb26-23"></a>        <span class="co"># Annotate the label</span></span>
<span id="cb26-24"><a href="#cb26-24"></a>        plt.text(</span>
<span id="cb26-25"><a href="#cb26-25"></a>            x1,</span>
<span id="cb26-26"><a href="#cb26-26"></a>            y1,</span>
<span id="cb26-27"><a href="#cb26-27"></a>            label,</span>
<span id="cb26-28"><a href="#cb26-28"></a>            color<span class="op">=</span><span class="st">&quot;white&quot;</span>,</span>
<span id="cb26-29"><a href="#cb26-29"></a>            fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb26-30"><a href="#cb26-30"></a>            bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">&quot;red&quot;</span>, alpha<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb26-31"><a href="#cb26-31"></a>        )</span>
<span id="cb26-32"><a href="#cb26-32"></a></span>
<span id="cb26-33"><a href="#cb26-33"></a>    <span class="co"># Remove the axis ticks and labels</span></span>
<span id="cb26-34"><a href="#cb26-34"></a>    ax.axis(<span class="st">&quot;off&quot;</span>)</span>
<span id="cb26-35"><a href="#cb26-35"></a></span>
<span id="cb26-36"><a href="#cb26-36"></a>    <span class="co"># Show the plot</span></span>
<span id="cb26-37"><a href="#cb26-37"></a>    plt.show()</span></code></pre></div>
<blockquote>
<p><strong>Box (x0, y0, x1, y1)</strong>: Location tokens correspond to the top-left and bottom-right corners of a box.</p>
</blockquote>
<p>And running</p>
<pre><code>plot_bbox(image, parsed_answer[&#39;&lt;OD&gt;&#39;])</code></pre>
<p>We get:</p>
<p> <img src="../media/file950.png" class="quarto-figure quarto-figure-center" style="width:80.0%" alt="" /></p>
</section>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-florence2-tasks-bcbb" class="level2 unnumbered">
<h2 class="unnumbered">Florence-2 Tasks</h2>
<p>Florence-2 is designed to perform a variety of computer vision and vision-language tasks through <code>prompts</code>. These tasks can be activated by providing a specific textual prompt to the model, as we saw with <code>&lt;OD&gt;</code> (Object Detection).</p>
<p>Florence-2’s versatility comes from combining these prompts, allowing us to guide the model’s behavior to perform specific vision tasks. Changing the prompt allows us to adapt Florence-2 to different tasks without needing task-specific modifications in the architecture. This capability directly results from Florence-2’s unified model architecture and large-scale multi-task training on the FLD-5B dataset.</p>
<p>Here are some of the key tasks that Florence-2 can perform, along with example prompts:</p>
<section id="sec-visionlanguage-models-vlm-object-detection-od-ef58" class="level3 unnumbered">
<h3 class="unnumbered">Object Detection (OD)</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;OD&gt;"</code></li>
<li><strong>Description</strong>: Identifies objects in an image and provides bounding boxes for each detected object. This task is helpful for applications like visual inspection, surveillance, and general object recognition.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-image-captioning-c35d" class="level3 unnumbered">
<h3 class="unnumbered">Image Captioning</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;CAPTION&gt;"</code></li>
<li><strong>Description</strong>: Generates a textual description for an input image. This task helps the model describe what is happening in the image, providing a human-readable caption for content understanding.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-detailed-captioning-7819" class="level3 unnumbered">
<h3 class="unnumbered">Detailed Captioning</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;DETAILED_CAPTION&gt;"</code></li>
<li><strong>Description</strong>: Generates a more detailed caption with more nuanced information about the scene, such as the objects present and their relationships.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-visual-grounding-7e4d" class="level3 unnumbered">
<h3 class="unnumbered">Visual Grounding</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;CAPTION_TO_PHRASE_GROUNDING&gt;"</code></li>
<li><strong>Description</strong>: Links a textual description to specific regions in an image. For example, given a prompt like “a green car,” the model highlights where the green car is in the image. This is useful for human-computer interaction, where you must find specific objects based on text.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-segmentation-e618" class="level3 unnumbered">
<h3 class="unnumbered">Segmentation</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;REFERRING_EXPRESSION_SEGMENTATION&gt;"</code></li>
<li><strong>Description</strong>: Performs segmentation based on a referring expression, such as “the blue cup.” The model identifies and segments the specific region containing the object mentioned in the prompt (all related pixels).</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-dense-region-captioning-ed94" class="level3 unnumbered">
<h3 class="unnumbered">Dense Region Captioning</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;DENSE_REGION_CAPTION&gt;"</code></li>
<li><strong>Description</strong>: Provides captions for multiple regions within an image, offering a detailed breakdown of all visible areas, including different objects and their relationships.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-ocr-region-75f2" class="level3 unnumbered">
<h3 class="unnumbered">OCR with Region</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;OCR_WITH_REGION&gt;"</code></li>
<li><strong>Description</strong>: Performs Optical Character Recognition (OCR) on an image and provides bounding boxes for the detected text. This is useful for extracting and locating textual information in images, such as reading signs, labels, or other forms of text in images.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-phrase-grounding-specific-expressions-0d0c" class="level3 unnumbered">
<h3 class="unnumbered">Phrase Grounding for Specific Expressions</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;CAPTION_TO_PHRASE_GROUNDING&gt;"</code> along with a specific expression, such as <code>"a wine glass"</code>.</li>
<li><strong>Description</strong>: Locates the area in the image that corresponds to a specific textual phrase. This task allows for identifying particular objects or elements when prompted with a word or keyword.</li>
</ul>
</section>
<section id="sec-visionlanguage-models-vlm-open-vocabulary-object-detection-3811" class="level3 unnumbered">
<h3 class="unnumbered">Open Vocabulary Object Detection</h3>
<ul>
<li><strong>Prompt</strong>: <code>"&lt;OPEN_VOCABULARY_OD&gt;"</code></li>
<li><strong>Description</strong>: The model can detect objects without being restricted to a predefined list of classes, making it helpful in recognizing a broader range of items based on general visual understanding.</li>
</ul>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-exploring-computer-vision-visionlanguage-tasks-5c1d" class="level2 unnumbered">
<h2 class="unnumbered">Exploring computer vision and vision-language tasks</h2>
<p>For exploration, all codes can be found on the GitHub:</p>
<ul>
<li><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/FLORENCE-2/notebooks/20-florence_2.ipynb">20-florence_2.ipynb</a></li>
</ul>
<p>Let’s use a couple of images created by Dall-E and upload them to the Rasp-5 (FileZilla can be used for that). The images will be saved on a sub-folder named <code>images</code> :</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a>dogs_cats <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">&quot;./images/dogs-cats.jpg&quot;</span>)</span>
<span id="cb28-2"><a href="#cb28-2"></a>table <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">&quot;./images/table.jpg&quot;</span>)</span></code></pre></div>
<p> <img src="../media/file951.png" alt="" /></p>
<p>Let’s create a function to facilitate our exploration and to keep track of the latency of the model for different tasks:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">def</span> run_example(task_prompt, text_input<span class="op">=</span><span class="va">None</span>, image<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb29-2"><a href="#cb29-2"></a>    start_time <span class="op">=</span> time.perf_counter()  <span class="co"># Start timing</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>    <span class="cf">if</span> text_input <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb29-4"><a href="#cb29-4"></a>        prompt <span class="op">=</span> task_prompt</span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="cf">else</span>:</span>
<span id="cb29-6"><a href="#cb29-6"></a>        prompt <span class="op">=</span> task_prompt <span class="op">+</span> text_input</span>
<span id="cb29-7"><a href="#cb29-7"></a>    inputs <span class="op">=</span> processor(</span>
<span id="cb29-8"><a href="#cb29-8"></a>        text<span class="op">=</span>prompt, images<span class="op">=</span>image, return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span></span>
<span id="cb29-9"><a href="#cb29-9"></a>    ).to(device)</span>
<span id="cb29-10"><a href="#cb29-10"></a>    generated_ids <span class="op">=</span> model.generate(</span>
<span id="cb29-11"><a href="#cb29-11"></a>        input_ids<span class="op">=</span>inputs[<span class="st">&quot;input_ids&quot;</span>],</span>
<span id="cb29-12"><a href="#cb29-12"></a>        pixel_values<span class="op">=</span>inputs[<span class="st">&quot;pixel_values&quot;</span>],</span>
<span id="cb29-13"><a href="#cb29-13"></a>        max_new_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb29-14"><a href="#cb29-14"></a>        early_stopping<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb29-15"><a href="#cb29-15"></a>        do_sample<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb29-16"><a href="#cb29-16"></a>        num_beams<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb29-17"><a href="#cb29-17"></a>    )</span>
<span id="cb29-18"><a href="#cb29-18"></a>    generated_text <span class="op">=</span> processor.batch_decode(</span>
<span id="cb29-19"><a href="#cb29-19"></a>        generated_ids, skip_special_tokens<span class="op">=</span><span class="va">False</span></span>
<span id="cb29-20"><a href="#cb29-20"></a>    )[<span class="dv">0</span>]</span>
<span id="cb29-21"><a href="#cb29-21"></a>    parsed_answer <span class="op">=</span> processor.post_process_generation(</span>
<span id="cb29-22"><a href="#cb29-22"></a>        generated_text,</span>
<span id="cb29-23"><a href="#cb29-23"></a>        task<span class="op">=</span>task_prompt,</span>
<span id="cb29-24"><a href="#cb29-24"></a>        image_size<span class="op">=</span>(image.width, image.height),</span>
<span id="cb29-25"><a href="#cb29-25"></a>    )</span>
<span id="cb29-26"><a href="#cb29-26"></a></span>
<span id="cb29-27"><a href="#cb29-27"></a>    end_time <span class="op">=</span> time.perf_counter()  <span class="co"># End timing</span></span>
<span id="cb29-28"><a href="#cb29-28"></a>    elapsed_time <span class="op">=</span> end_time <span class="op">-</span> start_time  <span class="co"># Calculate elapsed time</span></span>
<span id="cb29-29"><a href="#cb29-29"></a>    <span class="bu">print</span>(</span>
<span id="cb29-30"><a href="#cb29-30"></a>        <span class="ss">f&quot; </span><span class="ch">\n</span><span class="ss">[INFO] ==&gt; Florence-2-base (</span><span class="sc">{</span>task_prompt<span class="sc">}</span><span class="ss">), </span><span class="op">\</span></span>
<span id="cb29-31"><a href="#cb29-31"></a><span class="ss">          took </span><span class="sc">{</span>elapsed_time<span class="sc">:.1f}</span><span class="ss"> seconds to execute.</span><span class="ch">\n</span><span class="ss">&quot;</span></span>
<span id="cb29-32"><a href="#cb29-32"></a>    )</span>
<span id="cb29-33"><a href="#cb29-33"></a></span>
<span id="cb29-34"><a href="#cb29-34"></a>    <span class="cf">return</span> parsed_answer</span></code></pre></div>
<section id="sec-visionlanguage-models-vlm-caption-a1d1" class="level3 unnumbered">
<h3 class="unnumbered">Caption</h3>
<p><strong>1. Dogs and Cats</strong></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>run_example(task_prompt<span class="op">=</span><span class="st">&quot;&lt;CAPTION&gt;&quot;</span>, image<span class="op">=</span>dogs_cats)</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>CAPTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>took 16.1 seconds to execute.</span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="ex">{</span><span class="st">&#39;&lt;CAPTION&gt;&#39;</span><span class="ex">:</span> <span class="st">&#39;A group of dogs and cats sitting in a garden.&#39;</span>}</span></code></pre></div>
<p><strong>2. Table</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a>run_example(task_prompt<span class="op">=</span><span class="st">&quot;&lt;CAPTION&gt;&quot;</span>, image<span class="op">=</span>table)</span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>CAPTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>took 16.5 seconds to execute.</span>
<span id="cb33-3"><a href="#cb33-3"></a></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="ex">{</span><span class="st">&#39;&lt;CAPTION&gt;&#39;</span><span class="ex">:</span> <span class="st">&#39;A wooden table topped with a plate of fruit \</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="st">and a glass of wine.&#39;</span>}</span></code></pre></div>
</section>
<section id="sec-visionlanguage-models-vlm-detailed-caption-4b44" class="level3 unnumbered">
<h3 class="unnumbered">Detailed Caption</h3>
<p><strong>1. Dogs and Cats</strong></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a>run_example(task_prompt<span class="op">=</span><span class="st">&quot;&lt;DETAILED_CAPTION&gt;&quot;</span>, image<span class="op">=</span>dogs_cats)</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>DETAILED_CAPTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>took 25.5 seconds to execute.</span>
<span id="cb35-3"><a href="#cb35-3"></a></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="ex">{</span><span class="st">&#39;&lt;DETAILED_CAPTION&gt;&#39;</span><span class="ex">:</span> <span class="st">&#39;The image shows a group of cats and \</span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="st">dogs sitting on top of a lush green field, surrounded by plants \</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="st">with flowers, trees, and a house in the background. The sky is \</span></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="st">visible above them, creating a peaceful atmosphere.&#39;</span>}</span></code></pre></div>
<p><strong>2. Table</strong></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1"></a>run_example(task_prompt<span class="op">=</span><span class="st">&quot;&lt;DETAILED_CAPTION&gt;&quot;</span>, image<span class="op">=</span>table)</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>DETAILED_CAPTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>took 26.8 seconds to execute.</span>
<span id="cb37-3"><a href="#cb37-3"></a></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="ex">{</span><span class="st">&#39;&lt;DETAILED_CAPTION&gt;&#39;</span><span class="ex">:</span> <span class="st">&#39;The image shows a wooden table with \</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="st">a bottle of wine and a glass of wine on it, surrounded by \</span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="st">a variety of fruits such as apples, oranges, and grapes. \</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="st">In the background, there are chairs, plants, trees, and \</span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="st">a house, all slightly blurred.&#39;</span>}</span></code></pre></div>
</section>
<section id="sec-visionlanguage-models-vlm-detailed-caption-f936" class="level3 unnumbered">
<h3 class="unnumbered">More Detailed Caption</h3>
<p><strong>1. Dogs and Cats</strong></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a>run_example(task_prompt<span class="op">=</span><span class="st">&quot;&lt;MORE_DETAILED_CAPTION&gt;&quot;</span>, image<span class="op">=</span>dogs_cats)</span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>MORE_DETAILED_CAPTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>took 49.8 seconds to execute.</span>
<span id="cb39-3"><a href="#cb39-3"></a></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="ex">{</span><span class="st">&#39;&lt;MORE_DETAILED_CAPTION&gt;&#39;</span><span class="ex">:</span> <span class="st">&#39;The image shows a group of four \</span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="st">cats and a dog in a garden. The garden is filled with colorful \</span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="st">flowers and plants, and there is a pathway leading up to \</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="st">a house in the background. The main focus of the image is \</span></span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="st">a large German Shepherd dog standing on the left side of \</span></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="st">the garden, with its tongue hanging out and its mouth open, \</span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="st">as if it is panting. On the right side, there are \</span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="st">two smaller cats, one orange and one gray, sitting on the \</span></span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="st">grass. In the background, there is another golden retriever \</span></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="st">dog sitting and looking at the camera. The sky is blue and \</span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="st">the sun is shining, creating a warm and inviting atmosphere.&#39;</span>}</span></code></pre></div>
<p><strong>2. Table</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1"></a>run_example(task_prompt<span class="op">=</span><span class="st">&quot;&lt; MORE_DETAILED_CAPTION&gt;&quot;</span>, image<span class="op">=</span>table)</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1"></a><span class="ex">INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>MORE_DETAILED_CAPTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>took 32.4 seconds to execute.</span>
<span id="cb41-3"><a href="#cb41-3"></a></span>
<span id="cb41-4"><a href="#cb41-4"></a><span class="ex">{</span><span class="st">&#39;&lt;MORE_DETAILED_CAPTION&gt;&#39;</span><span class="ex">:</span> <span class="st">&#39;The image shows a wooden table \</span></span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="st">with a wooden tray on it. On the tray, there are various \</span></span>
<span id="cb41-6"><a href="#cb41-6"></a><span class="st">fruits such as grapes, oranges, apples, and grapes. There \</span></span>
<span id="cb41-7"><a href="#cb41-7"></a><span class="st">is also a bottle of red wine on the table. The background \</span></span>
<span id="cb41-8"><a href="#cb41-8"></a><span class="st">shows a garden with trees and a house. The overall mood \</span></span>
<span id="cb41-9"><a href="#cb41-9"></a><span class="st">of the image is peaceful and serene.&#39;</span>}</span></code></pre></div>
<blockquote>
<p>We can note that the more detailed the caption task, the longer the latency and the possibility of mistakes (like “The image shows a group of four cats and a dog in a garden”, instead of two dogs and three cats).</p>
</blockquote>
</section>
<section id="sec-visionlanguage-models-vlm-object-detection-dd2b" class="level3 unnumbered">
<h3 class="unnumbered">Object Detection</h3>
<p>We can run the same previous function for object detection using the prompt <code>&lt;OD&gt;</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;OD&gt;&quot;</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>results <span class="op">=</span> run_example(task_prompt, image<span class="op">=</span>dogs_cats)</span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="bu">print</span>(results)</span></code></pre></div>
<p>Let’s see the result:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>OD<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> took 20.9 seconds to execute.</span>
<span id="cb43-2"><a href="#cb43-2"></a></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="ex">{</span><span class="st">&#39;&lt;OD&gt;&#39;</span><span class="ex">:</span> {<span class="st">&#39;bboxes&#39;</span>: [</span>
<span id="cb43-4"><a href="#cb43-4"></a>  <span class="ex">[737.79,</span> 571.90, 1022.46, 980.48],</span>
<span id="cb43-5"><a href="#cb43-5"></a>  <span class="ex">[0.51,</span> 593.40, 211.45, 991.74],</span>
<span id="cb43-6"><a href="#cb43-6"></a>  <span class="ex">[445.95,</span> 721.40, 680.44, 850.43],</span>
<span id="cb43-7"><a href="#cb43-7"></a>  <span class="ex">[39.42,</span> 91.64, 491.00, 933.37],</span>
<span id="cb43-8"><a href="#cb43-8"></a>  <span class="ex">[570.88,</span> 184.83, 974.33, 782.84]</span>
<span id="cb43-9"><a href="#cb43-9"></a>  <span class="ex">],</span></span>
<span id="cb43-10"><a href="#cb43-10"></a>  <span class="st">&#39;labels&#39;</span><span class="ex">:</span> [<span class="st">&#39;cat&#39;</span>, <span class="st">&#39;cat&#39;</span>, <span class="st">&#39;cat&#39;</span>, <span class="st">&#39;dog&#39;</span>, <span class="st">&#39;dog&#39;</span>]</span>
<span id="cb43-11"><a href="#cb43-11"></a><span class="er">}}</span></span></code></pre></div>
<p>Only by the labels <code>['cat,' 'cat,' 'cat,' 'dog,' 'dog']</code> is it possible to see that the main objects in the image were captured. Let’s apply the function used before to draw the bounding boxes:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a>plot_bbox(dogs_cats, results[<span class="st">&quot;&lt;OD&gt;&quot;</span>])</span></code></pre></div>
<p> <img src="../media/file952.png" class="quarto-figure quarto-figure-center" style="width:65.0%" alt="" /></p>
<p>Let’s also do it with the Table image:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;OD&gt;&quot;</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>results <span class="op">=</span> run_example(task_prompt, image<span class="op">=</span>table)</span>
<span id="cb45-3"><a href="#cb45-3"></a>plot_bbox(table, results[<span class="st">&quot;&lt;OD&gt;&quot;</span>])</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode numberSource ba number-lines"><code class="sourceCode"><span id="cb46-1"><a href="#cb46-1"></a>[INFO] ==&gt; Florence-2-base (&lt;OD&gt;), took 40.8 seconds to execute.</span></code></pre></div>
<p> <img src="../media/file953.png" class="quarto-figure quarto-figure-center" style="width:75.0%" alt="" /></p>
</section>
<section id="sec-visionlanguage-models-vlm-dense-region-caption-fd99" class="level3 unnumbered">
<h3 class="unnumbered">Dense Region Caption</h3>
<p>It is possible to mix the classic Object Detection with the Caption task in specific sub-regions of the image:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;DENSE_REGION_CAPTION&gt;&quot;</span></span>
<span id="cb47-2"><a href="#cb47-2"></a></span>
<span id="cb47-3"><a href="#cb47-3"></a>results <span class="op">=</span> run_example(task_prompt, image<span class="op">=</span>dogs_cats)</span>
<span id="cb47-4"><a href="#cb47-4"></a>plot_bbox(dogs_cats, results[<span class="st">&quot;&lt;DENSE_REGION_CAPTION&gt;&quot;</span>])</span>
<span id="cb47-5"><a href="#cb47-5"></a></span>
<span id="cb47-6"><a href="#cb47-6"></a>results <span class="op">=</span> run_example(task_prompt, image<span class="op">=</span>table)</span>
<span id="cb47-7"><a href="#cb47-7"></a>plot_bbox(table, results[<span class="st">&quot;&lt;DENSE_REGION_CAPTION&gt;&quot;</span>])</span></code></pre></div>
<p> <img src="../media/file954.png" alt="" /></p>
</section>
<section id="sec-visionlanguage-models-vlm-caption-phrase-grounding-a092" class="level3 unnumbered">
<h3 class="unnumbered">Caption to Phrase Grounding</h3>
<p>With this task, we can enter with a caption, such as “a wine glass”, “a wine bottle,” or “a half orange,” and Florence-2 will localize the object in the image:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&quot;</span></span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a>results <span class="op">=</span> run_example(</span>
<span id="cb48-4"><a href="#cb48-4"></a>    task_prompt, text_input<span class="op">=</span><span class="st">&quot;a wine bottle&quot;</span>, image<span class="op">=</span>table</span>
<span id="cb48-5"><a href="#cb48-5"></a>)</span>
<span id="cb48-6"><a href="#cb48-6"></a>plot_bbox(table, results[<span class="st">&quot;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&quot;</span>])</span>
<span id="cb48-7"><a href="#cb48-7"></a></span>
<span id="cb48-8"><a href="#cb48-8"></a>results <span class="op">=</span> run_example(</span>
<span id="cb48-9"><a href="#cb48-9"></a>    task_prompt, text_input<span class="op">=</span><span class="st">&quot;a wine glass&quot;</span>, image<span class="op">=</span>table</span>
<span id="cb48-10"><a href="#cb48-10"></a>)</span>
<span id="cb48-11"><a href="#cb48-11"></a>plot_bbox(table, results[<span class="st">&quot;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&quot;</span>])</span>
<span id="cb48-12"><a href="#cb48-12"></a></span>
<span id="cb48-13"><a href="#cb48-13"></a>results <span class="op">=</span> run_example(</span>
<span id="cb48-14"><a href="#cb48-14"></a>    task_prompt, text_input<span class="op">=</span><span class="st">&quot;a half orange&quot;</span>, image<span class="op">=</span>table</span>
<span id="cb48-15"><a href="#cb48-15"></a>)</span>
<span id="cb48-16"><a href="#cb48-16"></a>plot_bbox(table, results[<span class="st">&quot;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&quot;</span>])</span></code></pre></div>
<p> <img src="../media/file955.png" alt="" /></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>CAPTION_TO_PHRASE_GROUNDING<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>took 15.7 seconds to execute</span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="ex">each</span> task.</span></code></pre></div>
</section>
<section id="sec-visionlanguage-models-vlm-cascade-tasks-8b5e" class="level3 unnumbered">
<h3 class="unnumbered">Cascade Tasks</h3>
<p>We can also enter the image caption as the input text to push Florence-2 to find more objects:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;CAPTION&gt;&quot;</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>results <span class="op">=</span> run_example(task_prompt, image<span class="op">=</span>dogs_cats)</span>
<span id="cb50-3"><a href="#cb50-3"></a>text_input <span class="op">=</span> results[task_prompt]</span>
<span id="cb50-4"><a href="#cb50-4"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&quot;</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>results <span class="op">=</span> run_example(task_prompt, text_input, image<span class="op">=</span>dogs_cats)</span>
<span id="cb50-6"><a href="#cb50-6"></a>plot_bbox(dogs_cats, results[<span class="st">&quot;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&quot;</span>])</span></code></pre></div>
<p>Changing the task_prompt among <code>&lt;CAPTION,&gt;</code> <code>&lt;DETAILED_CAPTION&gt;</code> and <code>&lt;MORE_DETAILED_CAPTION&gt;</code>, we will get more objects in the image.</p>
<p> <img src="../media/file956.png" alt="" /></p>
</section>
<section id="sec-visionlanguage-models-vlm-open-vocabulary-detection-be66" class="level3 unnumbered">
<h3 class="unnumbered">Open Vocabulary Detection</h3>
<p><code>&lt;OPEN_VOCABULARY_DETECTION&gt;</code> allows Florence-2 to detect recognizable objects in an image without relying on a predefined list of categories, making it a versatile tool for identifying various items that may not have been explicitly labeled during training. Unlike <code>&lt;CAPTION_TO_PHRASE_GROUNDING&gt;</code>, which requires a specific text phrase to locate and highlight a particular object in an image, <code>&lt;OPEN_VOCABULARY_DETECTION&gt;</code> performs a broad scan to find and classify all objects present.</p>
<p>This makes <code>&lt;OPEN_VOCABULARY_DETECTION&gt;</code> particularly useful for applications where you need a comprehensive overview of everything in an image without prior knowledge of what to expect. Enter with a text describing specific objects not previously detected, resulting in their detection. For example:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;OPEN_VOCABULARY_DETECTION&gt;&quot;</span></span>
<span id="cb51-2"><a href="#cb51-2"></a></span>
<span id="cb51-3"><a href="#cb51-3"></a>text <span class="op">=</span> [</span>
<span id="cb51-4"><a href="#cb51-4"></a>    <span class="st">&quot;a house&quot;</span>,</span>
<span id="cb51-5"><a href="#cb51-5"></a>    <span class="st">&quot;a tree&quot;</span>,</span>
<span id="cb51-6"><a href="#cb51-6"></a>    <span class="st">&quot;a standing cat at the left&quot;</span>,</span>
<span id="cb51-7"><a href="#cb51-7"></a>    <span class="st">&quot;a sleeping cat on the ground&quot;</span>,</span>
<span id="cb51-8"><a href="#cb51-8"></a>    <span class="st">&quot;a standing cat at the right&quot;</span>,</span>
<span id="cb51-9"><a href="#cb51-9"></a>    <span class="st">&quot;a yellow cat&quot;</span>,</span>
<span id="cb51-10"><a href="#cb51-10"></a>]</span>
<span id="cb51-11"><a href="#cb51-11"></a></span>
<span id="cb51-12"><a href="#cb51-12"></a><span class="cf">for</span> txt <span class="kw">in</span> text:</span>
<span id="cb51-13"><a href="#cb51-13"></a>    results <span class="op">=</span> run_example(</span>
<span id="cb51-14"><a href="#cb51-14"></a>        task_prompt, text_input<span class="op">=</span>txt, image<span class="op">=</span>dogs_cats</span>
<span id="cb51-15"><a href="#cb51-15"></a>    )</span>
<span id="cb51-16"><a href="#cb51-16"></a></span>
<span id="cb51-17"><a href="#cb51-17"></a>    bbox_results <span class="op">=</span> convert_to_od_format(</span>
<span id="cb51-18"><a href="#cb51-18"></a>        results[<span class="st">&quot;&lt;OPEN_VOCABULARY_DETECTION&gt;&quot;</span>]</span>
<span id="cb51-19"><a href="#cb51-19"></a>    )</span>
<span id="cb51-20"><a href="#cb51-20"></a></span>
<span id="cb51-21"><a href="#cb51-21"></a>    plot_bbox(dogs_cats, bbox_results)</span></code></pre></div>
<p> <img src="../media/file957.png" class="quarto-figure quarto-figure-center" style="width:85.0%" alt="" /></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>OPEN_VOCABULARY_DETECTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>took 15.1 seconds to execute</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="ex">each</span> task.</span></code></pre></div>
<blockquote>
<p>Note: Trying to use Florence-2 to find objects that were not found can leads to mistakes (see examples on the Notebook).</p>
</blockquote>
</section>
<section id="sec-visionlanguage-models-vlm-referring-expression-segmentation-de08" class="level3 unnumbered">
<h3 class="unnumbered">Referring expression segmentation</h3>
<p>We can also segment a specific object in the image and give its description (caption), such as “a wine bottle” on the table image or “a German Sheppard” on the dogs_cats.</p>
<p>Referring expression segmentation results format: <code>{'&lt;REFERRING_EXPRESSION_SEGMENTATION&gt;': {'Polygons': [[[polygon]], ...], 'labels': ['', '', ...]}}</code>, one object is represented by a list of polygons. each polygon is <code>[x1, y1, x2, y2, ..., xn, yn]</code>.</p>
<blockquote>
<p><strong>Polygon (x1, y1, …, xn, yn)</strong>: Location tokens represent the vertices of a polygon in clockwise order.</p>
</blockquote>
<p>So, let’s first create a function to plot the segmentation:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageDraw, ImageFont</span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="im">import</span> copy</span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="im">import</span> random</span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb53-5"><a href="#cb53-5"></a></span>
<span id="cb53-6"><a href="#cb53-6"></a>colormap <span class="op">=</span> [</span>
<span id="cb53-7"><a href="#cb53-7"></a>    <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb53-8"><a href="#cb53-8"></a>    <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb53-9"><a href="#cb53-9"></a>    <span class="st">&quot;green&quot;</span>,</span>
<span id="cb53-10"><a href="#cb53-10"></a>    <span class="st">&quot;purple&quot;</span>,</span>
<span id="cb53-11"><a href="#cb53-11"></a>    <span class="st">&quot;brown&quot;</span>,</span>
<span id="cb53-12"><a href="#cb53-12"></a>    <span class="st">&quot;pink&quot;</span>,</span>
<span id="cb53-13"><a href="#cb53-13"></a>    <span class="st">&quot;gray&quot;</span>,</span>
<span id="cb53-14"><a href="#cb53-14"></a>    <span class="st">&quot;olive&quot;</span>,</span>
<span id="cb53-15"><a href="#cb53-15"></a>    <span class="st">&quot;cyan&quot;</span>,</span>
<span id="cb53-16"><a href="#cb53-16"></a>    <span class="st">&quot;red&quot;</span>,</span>
<span id="cb53-17"><a href="#cb53-17"></a>    <span class="st">&quot;lime&quot;</span>,</span>
<span id="cb53-18"><a href="#cb53-18"></a>    <span class="st">&quot;indigo&quot;</span>,</span>
<span id="cb53-19"><a href="#cb53-19"></a>    <span class="st">&quot;violet&quot;</span>,</span>
<span id="cb53-20"><a href="#cb53-20"></a>    <span class="st">&quot;aqua&quot;</span>,</span>
<span id="cb53-21"><a href="#cb53-21"></a>    <span class="st">&quot;magenta&quot;</span>,</span>
<span id="cb53-22"><a href="#cb53-22"></a>    <span class="st">&quot;coral&quot;</span>,</span>
<span id="cb53-23"><a href="#cb53-23"></a>    <span class="st">&quot;gold&quot;</span>,</span>
<span id="cb53-24"><a href="#cb53-24"></a>    <span class="st">&quot;tan&quot;</span>,</span>
<span id="cb53-25"><a href="#cb53-25"></a>    <span class="st">&quot;skyblue&quot;</span>,</span>
<span id="cb53-26"><a href="#cb53-26"></a>]</span>
<span id="cb53-27"><a href="#cb53-27"></a></span>
<span id="cb53-28"><a href="#cb53-28"></a></span>
<span id="cb53-29"><a href="#cb53-29"></a><span class="kw">def</span> draw_polygons(image, prediction, fill_mask<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb53-30"><a href="#cb53-30"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb53-31"><a href="#cb53-31"></a><span class="co">        Draws segmentation masks with polygons on an image.</span></span>
<span id="cb53-32"><a href="#cb53-32"></a></span>
<span id="cb53-33"><a href="#cb53-33"></a><span class="co">        Parameters:</span></span>
<span id="cb53-34"><a href="#cb53-34"></a><span class="co">          - image_path: Path to the image file.</span></span>
<span id="cb53-35"><a href="#cb53-35"></a><span class="co">          - prediction: Dictionary containing &#39;polygons&#39; and &#39;labels&#39;</span></span>
<span id="cb53-36"><a href="#cb53-36"></a><span class="co">                  keys. &#39;polygons&#39; is a list of lists, each</span></span>
<span id="cb53-37"><a href="#cb53-37"></a><span class="co">                  containing vertices of a polygon. &#39;labels&#39; is</span></span>
<span id="cb53-38"><a href="#cb53-38"></a><span class="co">                  a list of labels corresponding to each polygon.</span></span>
<span id="cb53-39"><a href="#cb53-39"></a><span class="co">    - fill_mask: Boolean indicating whether to fill the polygons</span></span>
<span id="cb53-40"><a href="#cb53-40"></a><span class="co">                 with color.</span></span>
<span id="cb53-41"><a href="#cb53-41"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb53-42"><a href="#cb53-42"></a>    <span class="co"># Load the image</span></span>
<span id="cb53-43"><a href="#cb53-43"></a></span>
<span id="cb53-44"><a href="#cb53-44"></a>    draw <span class="op">=</span> ImageDraw.Draw(image)</span>
<span id="cb53-45"><a href="#cb53-45"></a></span>
<span id="cb53-46"><a href="#cb53-46"></a>    <span class="co"># Set up scale factor if needed (use 1 if not scaling)</span></span>
<span id="cb53-47"><a href="#cb53-47"></a>    scale <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb53-48"><a href="#cb53-48"></a></span>
<span id="cb53-49"><a href="#cb53-49"></a>    <span class="co"># Iterate over polygons and labels</span></span>
<span id="cb53-50"><a href="#cb53-50"></a>    <span class="cf">for</span> polygons, label <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb53-51"><a href="#cb53-51"></a>        prediction[<span class="st">&quot;polygons&quot;</span>], prediction[<span class="st">&quot;labels&quot;</span>]</span>
<span id="cb53-52"><a href="#cb53-52"></a>    ):</span>
<span id="cb53-53"><a href="#cb53-53"></a>        color <span class="op">=</span> random.choice(colormap)</span>
<span id="cb53-54"><a href="#cb53-54"></a>        fill_color <span class="op">=</span> random.choice(colormap) <span class="cf">if</span> fill_mask <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb53-55"><a href="#cb53-55"></a></span>
<span id="cb53-56"><a href="#cb53-56"></a>        <span class="cf">for</span> _polygon <span class="kw">in</span> polygons:</span>
<span id="cb53-57"><a href="#cb53-57"></a>            _polygon <span class="op">=</span> np.array(_polygon).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb53-58"><a href="#cb53-58"></a>            <span class="cf">if</span> <span class="bu">len</span>(_polygon) <span class="op">&lt;</span> <span class="dv">3</span>:</span>
<span id="cb53-59"><a href="#cb53-59"></a>                <span class="bu">print</span>(<span class="st">&quot;Invalid polygon:&quot;</span>, _polygon)</span>
<span id="cb53-60"><a href="#cb53-60"></a>                <span class="cf">continue</span></span>
<span id="cb53-61"><a href="#cb53-61"></a></span>
<span id="cb53-62"><a href="#cb53-62"></a>            _polygon <span class="op">=</span> (_polygon <span class="op">*</span> scale).reshape(<span class="op">-</span><span class="dv">1</span>).tolist()</span>
<span id="cb53-63"><a href="#cb53-63"></a></span>
<span id="cb53-64"><a href="#cb53-64"></a>            <span class="co"># Draw the polygon</span></span>
<span id="cb53-65"><a href="#cb53-65"></a>            <span class="cf">if</span> fill_mask:</span>
<span id="cb53-66"><a href="#cb53-66"></a>                draw.polygon(_polygon, outline<span class="op">=</span>color, fill<span class="op">=</span>fill_color)</span>
<span id="cb53-67"><a href="#cb53-67"></a>            <span class="cf">else</span>:</span>
<span id="cb53-68"><a href="#cb53-68"></a>                draw.polygon(_polygon, outline<span class="op">=</span>color)</span>
<span id="cb53-69"><a href="#cb53-69"></a></span>
<span id="cb53-70"><a href="#cb53-70"></a>            <span class="co"># Draw the label text</span></span>
<span id="cb53-71"><a href="#cb53-71"></a>            draw.text(</span>
<span id="cb53-72"><a href="#cb53-72"></a>                (_polygon[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">8</span>, _polygon[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">2</span>), label, fill<span class="op">=</span>color</span>
<span id="cb53-73"><a href="#cb53-73"></a>            )</span>
<span id="cb53-74"><a href="#cb53-74"></a></span>
<span id="cb53-75"><a href="#cb53-75"></a>    <span class="co"># Save or display the image</span></span>
<span id="cb53-76"><a href="#cb53-76"></a>    <span class="co"># image.show()  # Display the image</span></span>
<span id="cb53-77"><a href="#cb53-77"></a>    display(image)</span></code></pre></div>
<p>Now we can run the functions:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;REFERRING_EXPRESSION_SEGMENTATION&gt;&quot;</span></span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a>results <span class="op">=</span> run_example(</span>
<span id="cb54-4"><a href="#cb54-4"></a>    task_prompt, text_input<span class="op">=</span><span class="st">&quot;a wine bottle&quot;</span>, image<span class="op">=</span>table</span>
<span id="cb54-5"><a href="#cb54-5"></a>)</span>
<span id="cb54-6"><a href="#cb54-6"></a>output_image <span class="op">=</span> copy.deepcopy(table)</span>
<span id="cb54-7"><a href="#cb54-7"></a>draw_polygons(</span>
<span id="cb54-8"><a href="#cb54-8"></a>    output_image,</span>
<span id="cb54-9"><a href="#cb54-9"></a>    results[<span class="st">&quot;&lt;REFERRING_EXPRESSION_SEGMENTATION&gt;&quot;</span>],</span>
<span id="cb54-10"><a href="#cb54-10"></a>    fill_mask<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb54-11"><a href="#cb54-11"></a>)</span>
<span id="cb54-12"><a href="#cb54-12"></a></span>
<span id="cb54-13"><a href="#cb54-13"></a>results <span class="op">=</span> run_example(</span>
<span id="cb54-14"><a href="#cb54-14"></a>    task_prompt, text_input<span class="op">=</span><span class="st">&quot;a german sheppard&quot;</span>, image<span class="op">=</span>dogs_cats</span>
<span id="cb54-15"><a href="#cb54-15"></a>)</span>
<span id="cb54-16"><a href="#cb54-16"></a>output_image <span class="op">=</span> copy.deepcopy(dogs_cats)</span>
<span id="cb54-17"><a href="#cb54-17"></a>draw_polygons(</span>
<span id="cb54-18"><a href="#cb54-18"></a>    output_image,</span>
<span id="cb54-19"><a href="#cb54-19"></a>    results[<span class="st">&quot;&lt;REFERRING_EXPRESSION_SEGMENTATION&gt;&quot;</span>],</span>
<span id="cb54-20"><a href="#cb54-20"></a>    fill_mask<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb54-21"><a href="#cb54-21"></a>)</span></code></pre></div>
<p> <img src="../media/file958.png" class="quarto-figure quarto-figure-center" style="width:75.0%" alt="" /></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base</span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="kw">(</span><span class="op">&lt;</span>REFERRING_EXPRESSION_SEGMENTATION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> took 207.0 seconds</span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="ex">to</span> execute each task.</span></code></pre></div>
</section>
<section id="sec-visionlanguage-models-vlm-region-segmentation-1899" class="level3 unnumbered">
<h3 class="unnumbered">Region to Segmentation</h3>
<p>With this task, it is also possible to give the object coordinates in the image to segment it. The input format is <code>'&lt;loc_x1&gt;&lt;loc_y1&gt;&lt;loc_x2&gt;&lt;loc_y2&gt;', [x1, y1, x2, y2]</code> , which is the quantized coordinates in [0, 999].</p>
<p>For example, when running the code:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&quot;</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>results <span class="op">=</span> run_example(</span>
<span id="cb56-3"><a href="#cb56-3"></a>    task_prompt, text_input<span class="op">=</span><span class="st">&quot;a half orange&quot;</span>, image<span class="op">=</span>table</span>
<span id="cb56-4"><a href="#cb56-4"></a>)</span>
<span id="cb56-5"><a href="#cb56-5"></a>results</span></code></pre></div>
<p>The results were:</p>
<pre><code>{&#39;&lt;CAPTION_TO_PHRASE_GROUNDING&gt;&#39;: {&#39;bboxes&#39;: [[343.552001953125,
    689.6640625,
    530.9440307617188,
    873.9840698242188]],
  &#39;labels&#39;: [&#39;a half&#39;]}}</code></pre>
<p>Using the bboxes rounded coordinates:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;REGION_TO_SEGMENTATION&gt;&quot;</span></span>
<span id="cb58-2"><a href="#cb58-2"></a>results <span class="op">=</span> run_example(</span>
<span id="cb58-3"><a href="#cb58-3"></a>    task_prompt,</span>
<span id="cb58-4"><a href="#cb58-4"></a>    text_input<span class="op">=</span>(<span class="st">&quot;&lt;loc_343&gt;&lt;loc_690&gt;&quot;</span> <span class="st">&quot;&lt;loc_531&gt;&lt;loc_874&gt;&quot;</span>),</span>
<span id="cb58-5"><a href="#cb58-5"></a>    image<span class="op">=</span>table,</span>
<span id="cb58-6"><a href="#cb58-6"></a>)</span>
<span id="cb58-7"><a href="#cb58-7"></a>output_image <span class="op">=</span> copy.deepcopy(table)</span>
<span id="cb58-8"><a href="#cb58-8"></a>draw_polygons(</span>
<span id="cb58-9"><a href="#cb58-9"></a>    output_image, results[<span class="st">&quot;&lt;REGION_TO_SEGMENTATION&gt;&quot;</span>], fill_mask<span class="op">=</span><span class="va">True</span></span>
<span id="cb58-10"><a href="#cb58-10"></a>)</span></code></pre></div>
<p>We got the segmentation of the object on those coordinates (Latency: 83 seconds):</p>
<p> <img src="../media/file959.png" class="quarto-figure quarto-figure-center" style="width:65.0%" alt="" /></p>
</section>
<section id="sec-visionlanguage-models-vlm-region-texts-d085" class="level3 unnumbered">
<h3 class="unnumbered">Region to Texts</h3>
<p>We can also give the region (coordinates and ask for a caption):</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;REGION_TO_CATEGORY&gt;&quot;</span></span>
<span id="cb59-2"><a href="#cb59-2"></a>results <span class="op">=</span> run_example(</span>
<span id="cb59-3"><a href="#cb59-3"></a>    task_prompt,</span>
<span id="cb59-4"><a href="#cb59-4"></a>    text_input<span class="op">=</span>(<span class="st">&quot;&lt;loc_343&gt;&lt;loc_690&gt;&quot;</span> <span class="st">&quot;&lt;loc_531&gt;&lt;loc_874&gt;&quot;</span>),</span>
<span id="cb59-5"><a href="#cb59-5"></a>    image<span class="op">=</span>table,</span>
<span id="cb59-6"><a href="#cb59-6"></a>)</span>
<span id="cb59-7"><a href="#cb59-7"></a>results</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1"></a>[INFO] <span class="op">==&gt;</span> Florence<span class="op">-</span><span class="dv">2</span><span class="op">-</span>base (<span class="op">&lt;</span>REGION_TO_CATEGORY<span class="op">&gt;</span>), <span class="op">\</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>took <span class="fl">14.3</span> seconds to execute.</span>
<span id="cb60-3"><a href="#cb60-3"></a></span>
<span id="cb60-4"><a href="#cb60-4"></a>{{</span>
<span id="cb60-5"><a href="#cb60-5"></a>  <span class="st">&#39;&lt;REGION_TO_CATEGORY&gt;&#39;</span>:</span>
<span id="cb60-6"><a href="#cb60-6"></a>    <span class="st">&#39;orange&lt;loc_343&gt;&lt;loc_690&gt;&#39;</span></span>
<span id="cb60-7"><a href="#cb60-7"></a>    <span class="st">&#39;&lt;loc_531&gt;&lt;loc_874&gt;&#39;</span></span>
<span id="cb60-8"><a href="#cb60-8"></a>}</span></code></pre></div>
<p>The model identified an orange in that region. Let’s ask for a description:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;REGION_TO_DESCRIPTION&gt;&quot;</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>results <span class="op">=</span> run_example(</span>
<span id="cb61-3"><a href="#cb61-3"></a>    task_prompt,</span>
<span id="cb61-4"><a href="#cb61-4"></a>    text_input<span class="op">=</span>(<span class="st">&quot;&lt;loc_343&gt;&lt;loc_690&gt;&quot;</span> <span class="st">&quot;&lt;loc_531&gt;&lt;loc_874&gt;&quot;</span>),</span>
<span id="cb61-5"><a href="#cb61-5"></a>    image<span class="op">=</span>table,</span>
<span id="cb61-6"><a href="#cb61-6"></a>)</span>
<span id="cb61-7"><a href="#cb61-7"></a>results</span></code></pre></div>
<div class="sourceCode" id="cb62"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1"></a>[INFO] <span class="op">==&gt;</span> Florence<span class="op">-</span><span class="dv">2</span><span class="op">-</span>base (<span class="op">&lt;</span>REGION_TO_CATEGORY<span class="op">&gt;</span>), <span class="op">\</span></span>
<span id="cb62-2"><a href="#cb62-2"></a>took <span class="fl">14.6</span> seconds to execute.</span>
<span id="cb62-3"><a href="#cb62-3"></a></span>
<span id="cb62-4"><a href="#cb62-4"></a>{</span>
<span id="cb62-5"><a href="#cb62-5"></a>  <span class="st">&#39;&lt;REGION_TO_CATEGORY&gt;&#39;</span>:</span>
<span id="cb62-6"><a href="#cb62-6"></a>    <span class="st">&#39;orange&lt;loc_343&gt;&lt;loc_690&gt;&#39;</span></span>
<span id="cb62-7"><a href="#cb62-7"></a>    <span class="st">&#39;&lt;loc_531&gt;&lt;loc_874&gt;&#39;</span></span>
<span id="cb62-8"><a href="#cb62-8"></a>}</span></code></pre></div>
<p>In this case, the description did not provide more details, but it could. Try another example.</p>
</section>
<section id="sec-visionlanguage-models-vlm-ocr-708e" class="level3 unnumbered">
<h3 class="unnumbered">OCR</h3>
<p>With Florence-2, we can perform Optical Character Recognition (OCR) on an image, getting what is written on it (<code>task_prompt = '&lt;OCR&gt;'</code> and also get the bounding boxes (location) for the detected text (<code>ask_prompt = '&lt;OCR_WITH_REGION&gt;'</code>). Those tasks can help extract and locate textual information in images, such as reading signs, labels, or other forms of text in images.</p>
<p>Let’s upload a flyer from a talk in Brazil to Raspi. Let’s test works in another language, here Portuguese):</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1"></a>flayer <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">&quot;./images/embarcados.jpg&quot;</span>)</span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="co"># Display the image</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb63-4"><a href="#cb63-4"></a>plt.imshow(flayer)</span>
<span id="cb63-5"><a href="#cb63-5"></a>plt.axis(<span class="st">&quot;off&quot;</span>)</span>
<span id="cb63-6"><a href="#cb63-6"></a><span class="co"># plt.title(&quot;Image&quot;)</span></span>
<span id="cb63-7"><a href="#cb63-7"></a>plt.show()</span></code></pre></div>
<p> <img src="../media/file960.png" class="quarto-figure quarto-figure-center" style="width:80.0%" alt="" /></p>
<p>Let’s examine the image with <code>'&lt;MORE_DETAILED_CAPTION&gt;'</code> :</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>MORE_DETAILED_CAPTION<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> <span class="dt">\</span></span>
<span id="cb64-2"><a href="#cb64-2"></a>took 85.2 seconds to execute.</span>
<span id="cb64-3"><a href="#cb64-3"></a></span>
<span id="cb64-4"><a href="#cb64-4"></a><span class="ex">{</span><span class="st">&#39;&lt;MORE_DETAILED_CAPTION&gt;&#39;</span><span class="ex">:</span> <span class="st">&#39;The image is a promotional poster \</span></span>
<span id="cb64-5"><a href="#cb64-5"></a><span class="st">for an event called &quot;Machine Learning Embarcados&quot; hosted by \</span></span>
<span id="cb64-6"><a href="#cb64-6"></a><span class="st">Marcelo Roval. The poster has a black background with white \</span></span>
<span id="cb64-7"><a href="#cb64-7"></a><span class="st">text. On the left side of the poster, there is a logo of a \</span></span>
<span id="cb64-8"><a href="#cb64-8"></a><span class="st">coffee cup with the text &quot;Café Com Embarcados&quot; above it. \</span></span>
<span id="cb64-9"><a href="#cb64-9"></a><span class="st">Below the logo, it says &quot;25 de Setembro as 17th&quot; which \</span></span>
<span id="cb64-10"><a href="#cb64-10"></a><span class="st">translates to &quot;25th of September as 17&quot; in English. \n\nOn \</span></span>
<span id="cb64-11"><a href="#cb64-11"></a><span class="st">the right side, there are two smaller text boxes with the names \</span></span>
<span id="cb64-12"><a href="#cb64-12"></a><span class="st">of the participants and their names. The first text box reads \</span></span>
<span id="cb64-13"><a href="#cb64-13"></a><span class="st">&quot;Democratizando a Inteligência Artificial para Paises em \</span></span>
<span id="cb64-14"><a href="#cb64-14"></a><span class="st">Desenvolvimento&quot; and the second text box says &quot;Toda \</span></span>
<span id="cb64-15"><a href="#cb64-15"></a><span class="st">quarta-feira&quot; which is Portuguese for &quot;Transmissão via in \</span></span>
<span id="cb64-16"><a href="#cb64-16"></a><span class="st">Portuguese&quot;.\n\nIn the center of the image, there has a photo \</span></span>
<span id="cb64-17"><a href="#cb64-17"></a><span class="st">of Marcelo, a man with a beard and glasses, smiling at the \</span></span>
<span id="cb64-18"><a href="#cb64-18"></a><span class="st">camera. He is wearing a white hard hat and a white shirt. \</span></span>
<span id="cb64-19"><a href="#cb64-19"></a><span class="st">The text boxes are in orange and yellow colors.&#39;</span>}</span></code></pre></div>
<p>The description is very accurate. Let’s get to the more important words with the task OCR:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;OCR&gt;&quot;</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>run_example(task_prompt, image<span class="op">=</span>flayer)</span></code></pre></div>
<div class="sourceCode" id="cb66"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1"></a><span class="ex">[INFO]</span> ==<span class="op">&gt;</span> Florence-2-base <span class="er">(</span><span class="op">&lt;</span>OCR<span class="op">&gt;</span><span class="kw">)</span><span class="ex">,</span> took 37.7 seconds to execute.</span>
<span id="cb66-2"><a href="#cb66-2"></a></span>
<span id="cb66-3"><a href="#cb66-3"></a><span class="ex">{</span><span class="st">&#39;&lt;OCR&gt;&#39;</span><span class="ex">:</span></span>
<span id="cb66-4"><a href="#cb66-4"></a> <span class="st">&#39;Machine Learning Café com Embarcado Embarcados &#39;</span></span>
<span id="cb66-5"><a href="#cb66-5"></a> <span class="st">&#39;Democratizando a Inteligência Artificial para Paises em &#39;</span></span>
<span id="cb66-6"><a href="#cb66-6"></a> <span class="st">&#39;25 de Setembro às 17h Desenvolvimento Toda quarta-feira &#39;</span></span>
<span id="cb66-7"><a href="#cb66-7"></a> <span class="st">&#39;Marcelo Roval Professor na UNIFIEI e Transmissão via in &#39;</span></span>
<span id="cb66-8"><a href="#cb66-8"></a> <span class="st">&#39;Co-Director do TinyML4D&#39;</span><span class="ex">}</span></span></code></pre></div>
<p>Let’s locate the words in the flyer:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1"></a>task_prompt <span class="op">=</span> <span class="st">&quot;&lt;OCR_WITH_REGION&gt;&quot;</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>results <span class="op">=</span> run_example(task_prompt, image<span class="op">=</span>flayer)</span></code></pre></div>
<p>Let’s also create a function to draw bounding boxes around the detected words:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1"></a><span class="kw">def</span> draw_ocr_bboxes(image, prediction):</span>
<span id="cb68-2"><a href="#cb68-2"></a>    scale <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb68-3"><a href="#cb68-3"></a>    draw <span class="op">=</span> ImageDraw.Draw(image)</span>
<span id="cb68-4"><a href="#cb68-4"></a>    bboxes <span class="op">=</span> prediction[<span class="st">&quot;quad_boxes&quot;</span>]</span>
<span id="cb68-5"><a href="#cb68-5"></a>    labels <span class="op">=</span> prediction[<span class="st">&quot;labels&quot;</span>]</span>
<span id="cb68-6"><a href="#cb68-6"></a>    <span class="cf">for</span> box, label <span class="kw">in</span> <span class="bu">zip</span>(bboxes, labels):</span>
<span id="cb68-7"><a href="#cb68-7"></a>        color <span class="op">=</span> random.choice(colormap)</span>
<span id="cb68-8"><a href="#cb68-8"></a>        new_box <span class="op">=</span> (np.array(box) <span class="op">*</span> scale).tolist()</span>
<span id="cb68-9"><a href="#cb68-9"></a>        draw.polygon(new_box, width<span class="op">=</span><span class="dv">3</span>, outline<span class="op">=</span>color)</span>
<span id="cb68-10"><a href="#cb68-10"></a>        draw.text(</span>
<span id="cb68-11"><a href="#cb68-11"></a>            (new_box[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">8</span>, new_box[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">2</span>),</span>
<span id="cb68-12"><a href="#cb68-12"></a>            <span class="st">&quot;</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(label),</span>
<span id="cb68-13"><a href="#cb68-13"></a>            align<span class="op">=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb68-14"><a href="#cb68-14"></a>            fill<span class="op">=</span>color,</span>
<span id="cb68-15"><a href="#cb68-15"></a>        )</span>
<span id="cb68-16"><a href="#cb68-16"></a>    display(image)</span></code></pre></div>
<div class="sourceCode" id="cb69"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1"></a>output_image <span class="op">=</span> copy.deepcopy(flayer)</span>
<span id="cb69-2"><a href="#cb69-2"></a>draw_ocr_bboxes(output_image, results[<span class="st">&quot;&lt;OCR_WITH_REGION&gt;&quot;</span>])</span></code></pre></div>
<p> <img src="../media/file961.png" class="quarto-figure quarto-figure-center" style="width:80.0%" alt="" /></p>
<p>We can inspect the detected words:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1"></a>results[<span class="st">&quot;&lt;OCR_WITH_REGION&gt;&quot;</span>][<span class="st">&quot;labels&quot;</span>]</span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource bash number-lines"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1"></a><span class="st">&#39;&lt;/s&gt;Machine Learning&#39;</span><span class="ex">,</span></span>
<span id="cb71-2"><a href="#cb71-2"></a> <span class="st">&#39;Café&#39;</span><span class="ex">,</span></span>
<span id="cb71-3"><a href="#cb71-3"></a> <span class="st">&#39;com&#39;</span><span class="ex">,</span></span>
<span id="cb71-4"><a href="#cb71-4"></a> <span class="st">&#39;Embarcado&#39;</span><span class="ex">,</span></span>
<span id="cb71-5"><a href="#cb71-5"></a> <span class="st">&#39;Embarcados&#39;</span><span class="ex">,</span></span>
<span id="cb71-6"><a href="#cb71-6"></a> <span class="st">&#39;Democratizando a Inteligência&#39;</span><span class="ex">,</span></span>
<span id="cb71-7"><a href="#cb71-7"></a> <span class="st">&#39;Artificial para Paises em&#39;</span><span class="ex">,</span></span>
<span id="cb71-8"><a href="#cb71-8"></a> <span class="st">&#39;25 de Setembro ás 17h&#39;</span><span class="ex">,</span></span>
<span id="cb71-9"><a href="#cb71-9"></a> <span class="st">&#39;Desenvolvimento&#39;</span><span class="ex">,</span></span>
<span id="cb71-10"><a href="#cb71-10"></a> <span class="st">&#39;Toda quarta-feira&#39;</span><span class="ex">,</span></span>
<span id="cb71-11"><a href="#cb71-11"></a> <span class="st">&#39;Marcelo Roval&#39;</span><span class="ex">,</span></span>
<span id="cb71-12"><a href="#cb71-12"></a> <span class="st">&#39;Professor na UNIFIEI e&#39;</span><span class="ex">,</span></span>
<span id="cb71-13"><a href="#cb71-13"></a> <span class="st">&#39;Transmissão via&#39;</span><span class="ex">,</span></span>
<span id="cb71-14"><a href="#cb71-14"></a> <span class="st">&#39;in&#39;</span><span class="ex">,</span></span>
<span id="cb71-15"><a href="#cb71-15"></a> <span class="st">&#39;Co-Director do TinyML4D&#39;</span><span class="ex">]</span></span></code></pre></div>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-latency-summary-fec8" class="level2 unnumbered">
<h2 class="unnumbered">Latency Summary</h2>
<p>The latency observed for different tasks using Florence-2 on the Raspberry Pi (Raspi-5) varied depending on the complexity of the task:</p>
<ul>
<li><strong>Image Captioning</strong>: It took approximately 16-17 seconds to generate a caption for an image.</li>
<li><strong>Detailed Captioning</strong>: Increased latency to around 25-27 seconds, requiring generating more nuanced scene descriptions.</li>
<li><strong>More Detailed Captioning</strong>: It took about 32-50 seconds, and the latency increased as the description grew more complex.</li>
<li><strong>Object Detection</strong>: It took approximately 20-41 seconds, depending on the image’s complexity and the number of detected objects.</li>
<li><strong>Visual Grounding</strong>: Approximately 15-16 seconds to localize specific objects based on textual prompts.</li>
<li><strong>OCR (Optical Character Recognition)</strong>: Extracting text from an image took around 37-38 seconds.</li>
<li><strong>Segmentation and Region to Segmentation</strong>: Segmentation tasks took considerably longer, with a latency of around 83-207 seconds, depending on the complexity and the number of regions to be segmented.</li>
</ul>
<p>These latency times highlight the resource constraints of edge devices like the Raspberry Pi and emphasize the need to optimize the model and the environment to achieve real-time performance.</p>
<p> <img src="../media/file962.png" alt="" /></p>
<blockquote>
<p>Running complex tasks can use all 8 GB of the Raspi-5’s memory. For example, the above screenshot during the Florence OD task shows 4 CPUs at full speed and over 5 GB of memory in use. Consider increasing the SWAP memory to 2 GB.</p>
</blockquote>
<p>Checking the CPU temperature with <code>vcgencmd measure_temp</code> , showed that temperature can go up to +80oC.</p>
</section>
<section id="sec-visionlanguage-models-vlm-finetunning-80d7" class="level2 unnumbered">
<h2 class="unnumbered">Fine-Tuning</h2>
<p>As explored in this lab, Florence supports many tasks out of the box, including captioning, object detection, OCR, and more. However, like other pre-trained foundational models, Florence-2 may need domain-specific knowledge. For example, it may need to improve with medical or satellite imagery. In such cases, <strong>fine-tuning</strong> with a custom dataset is necessary. The Roboflow tutorial, <a href="https://blog.roboflow.com/fine-tune-florence-2-object-detection/">How to Fine-tune Florence-2 for Object Detection Tasks</a>, shows how to fine-tune Florence-2 on object detection datasets to improve model performance for our specific use case.</p>
<p>Based on the above tutorial, it is possible to fine-tune the Florence-2 model to detect boxes and wheels used in previous labs:</p>
<p> <img src="../media/file963.png" alt="" /></p>
<p>It is important to note that after fine-tuning, the model can still detect classes that don’t belong to our custom dataset, like cats, dogs, grapes, etc, as seen before).</p>
<p>The complete fine-tuning project using a previously annotated dataset in Roboflow and executed on CoLab can be found in the notebook:</p>
<ul>
<li><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/FLORENCE-2/notebooks/30-Finetune_florence_2_on_detection_dataset_box_vs_wheel.ipynb">30-Finetune_florence_2_on_detection_dataset_box_vs_wheel.ipynb</a></li>
</ul>
<p>In another example, in the post, <a href="https://huggingface.co/blog/finetune-florence2">Fine-tuning Florence-2 - Microsoft’s Cutting-edge Vision Language Models</a>, the authors show an example of fine-tuning Florence on <code>DocVQA</code>. The authors report that Florence 2 can perform visual question answering (VQA), but the released models don’t include VQA capability.</p>
</section>
<section id="sec-visionlanguage-models-vlm-summary-012c" class="level2 unnumbered">
<h2 class="unnumbered">Summary</h2>
<p>Florence-2 offers a versatile and powerful approach to vision-language tasks at the edge, providing performance that rivals larger, task-specific models, such as YOLO for object detection, BERT/RoBERTa for text analysis, and specialized OCR models.</p>
<p>Thanks to its multi-modal transformer architecture, Florence-2 is more flexible than YOLO in terms of the tasks it can handle. These include object detection, image captioning, and visual grounding.</p>
<p>Unlike <strong>BERT</strong>, which focuses purely on language, Florence-2 integrates vision and language, allowing it to excel in applications that require both modalities, such as image captioning and visual grounding.</p>
<p>Moreover, while traditional <strong>OCR models</strong> such as Tesseract and EasyOCR are designed solely for recognizing and extracting text from images, Florence-2’s OCR capabilities are part of a broader framework that includes contextual understanding and visual-text alignment. This makes it particularly useful for scenarios that require both reading text and interpreting its context within images.</p>
<p>Overall, Florence-2 stands out for its ability to seamlessly integrate various vision-language tasks into a unified model that is efficient enough to run on edge devices like the Raspberry Pi. This makes it a compelling choice for developers and researchers exploring AI applications at the edge.</p>
<section id="sec-visionlanguage-models-vlm-key-advantages-florence2-0a83" class="level3 unnumbered">
<h3 class="unnumbered">Key Advantages of Florence-2</h3>
<ol type="1">
<li><strong>Unified Architecture</strong>
<ul>
<li>Single model handles multiple vision tasks vs. specialized models (YOLO, BERT, Tesseract)</li>
<li>Eliminates the need for multiple model deployments and integrations</li>
<li>Consistent API and interface across tasks</li>
</ul></li>
<li><strong>Performance Comparison</strong>
<ul>
<li>Object Detection: Comparable to YOLOv8 (~37.5 mAP on COCO vs. YOLOv8’s ~39.7 mAP) despite being general-purpose</li>
<li>Text Recognition: Handles multiple languages effectively like specialized OCR models (Tesseract, EasyOCR)</li>
<li>Language Understanding: Integrates BERT-like capabilities for text processing while adding visual context</li>
</ul></li>
<li><strong>Resource Efficiency</strong>
<ul>
<li>The Base model (232M parameters) achieves strong results despite smaller size</li>
<li>Runs effectively on edge devices (Raspberry Pi)</li>
<li>Single model deployment vs. multiple specialized models</li>
</ul></li>
</ol>
</section>
<section id="sec-visionlanguage-models-vlm-tradeoffs-8964" class="level3 unnumbered">
<h3 class="unnumbered">Trade-offs</h3>
<ol type="1">
<li><strong>Performance vs. Specialized Models</strong>
<ul>
<li>YOLO series may offer faster inference for pure object detection</li>
<li>Specialized OCR models might handle complex document layouts better</li>
<li>BERT/RoBERTa provide deeper language understanding for text-only tasks</li>
</ul></li>
<li><strong>Resource Requirements</strong>
<ul>
<li>Higher latency on edge devices (15-200s depending on task)</li>
<li>Requires careful memory management on Raspberry Pi</li>
<li>It may need optimization for real-time applications</li>
</ul></li>
<li><strong>Deployment Considerations</strong>
<ul>
<li>Initial setup is more complex than single-purpose models</li>
<li>Requires understanding of multiple task types and prompts</li>
<li>The learning curve for optimal prompt engineering</li>
</ul></li>
</ol>
</section>
<section id="sec-visionlanguage-models-vlm-best-use-cases-e73b" class="level3 unnumbered">
<h3 class="unnumbered">Best Use Cases</h3>
<ol type="1">
<li><strong>Resource-Constrained Environments</strong>
<ul>
<li>Edge devices requiring multiple vision capabilities</li>
<li>Systems with limited storage/deployment capacity</li>
<li>Applications needing flexible vision processing</li>
</ul></li>
<li><strong>Multi-modal Applications</strong>
<ul>
<li>Content moderation systems</li>
<li>Accessibility tools</li>
<li>Document analysis workflows</li>
</ul></li>
<li><strong>Rapid Prototyping</strong>
<ul>
<li>Quick deployment of vision capabilities</li>
<li>Testing multiple vision tasks without separate models</li>
<li>Proof-of-concept development</li>
</ul></li>
</ol>
</section>
</section>
<section id="sec-visionlanguage-models-vlm-future-implications-2fe6" class="level2 unnumbered">
<h2 class="unnumbered">Future Implications</h2>
<p>Florence-2 represents a shift toward unified vision models that could eventually replace task-specific architectures in many applications. While specialized models maintain advantages in specific scenarios, the convenience and efficiency of unified models like Florence-2 make them increasingly attractive for real-world deployments.</p>
<p>The lab demonstrates Florence-2’s viability on edge devices, suggesting future IoT, mobile computing, and embedded systems applications where deploying multiple specialized models would be impractical.</p>
</section>
<section id="sec-visionlanguage-models-vlm-resources-fb6a" class="level2 unnumbered">
<h2 class="unnumbered">Resources</h2>
<ul>
<li><p><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/FLORENCE-2/notebooks/10-florence2_test.ipynb">10-florence2_test.ipynb</a></p></li>
<li><p><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/FLORENCE-2/notebooks/20-florence_2.ipynb">20-florence_2.ipynb</a></p></li>
<li><p><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/FLORENCE-2/notebooks/30-Finetune_florence_2_on_detection_dataset_box_vs_wheel.ipynb">30-Finetune_florence_2_on_detection_dataset_box_vs_wheel.ipynb</a></p></li>
</ul>
<div>

</div>
</section>
</section>
</body>
</html>
