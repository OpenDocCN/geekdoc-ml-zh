["```py\ndf = pd.read_csv(\"data/rent.csv\", parse_dates=['created'])\ndf_clean = df[(df.price>1_000) & (df.price<10_000)]\ndf_clean = df_clean[(df_clean.longitude!=0) | (df_clean.latitude!=0)]\ndf_clean = df_clean[(df_clean['latitude']>40.55) &\n                    (df_clean['latitude']<40.94) &\n                    (df_clean['longitude']>-74.1) &\n                    (df_clean['longitude']<-73.67)]\ndf = df_clean\n\n```", "```py\nnumfeatures = ['bathrooms', 'bedrooms', 'longitude', 'latitude']\nX, y = df[numfeatures], df['price']\nrf = RandomForestRegressor(n_estimators=100, n_jobs=-1, oob_score=True)\nrf.fit(X, y)\noob_baseline = rf.oob_score_\nprint(oob_baseline)\n```", "```py\nprint(f\"{rfnnodes(rf):,d} tree nodes and {np.median(rfmaxdepths(rf))} median tree height\")\n\n```", "```py\ndef showimp(rf, X, y):\n    features = list(X.columns)\n    features.remove('latitude')\n    features.remove('longitude')\n    features += [['latitude','longitude']]\n\n    I = importances(rf, X, y, features=features)\n    plot_importances(I, color='#4575b4')\n\nshowimp(rf, X, y)\n```", "```py\nprint(df['interest_level'].value_counts())\n```", "```py\ndf['interest_level'] = df['interest_level'].map({'low':1,'medium':2,'high':3})\nprint(df['interest_level'].value_counts())\n```", "```py\ndef test(X, y):\n    rf = RandomForestRegressor(n_estimators=100, n_jobs=-1, oob_score=True)\n    rf.fit(X, y)\n    oob = rf.oob_score_\n    n = rfnnodes(rf)\n    h = np.median(rfmaxdepths(rf))\n    print(f\"OOB R^2 {oob:.5f} using {n:,d} tree nodes with {h} median tree height\")\n    return rf, oob\n\nX, y = df[['interest_level']+numfeatures], df['price']\nrf, oob = test(X, y)\n\n```", "```py\nprint(len(df['manager_id'].unique()), len(df['building_id'].unique()), len(df['display_address'].unique()))\n```", "```py\ndf['display_address_cat'] = df['display_address'].astype('category').cat.as_ordered()\ndf['display_address_cat'] = df['display_address_cat'].cat.codes + 1\n\n```", "```py\nX, y = df[['display_address_cat']+numfeatures], df['price']\nrf, oob = test(X, y)\n\n```", "```py\nprint(df['manager_id'].value_counts().head(5))\n```", "```py\nmanagers_count = df['manager_id'].value_counts()\ndf['mgr_apt_count'] = df['manager_id'].map(managers_count)\n\n```", "```py\nX, y = df[['display_address_cat','mgr_apt_count']+numfeatures], df['price']\nrf, oob = test(X, y)\n\n```", "```py\ndf['description'] = df['description'].fillna('')\ndf['description'] = df['description'].str.lower() # normalize to lower case\ndf['features'] = df['features'].fillna('') # fill missing w/blanks\ndf['features'] = df['features'].str.lower() # normalize to lower case\n\n```", "```py\n# has apartment been renovated?\ndf['renov'] = df['description'].str.contains(\"renov\")\n\nfor w in ['doorman', 'parking', 'garage', 'laundry', \n          'Elevator', 'fitness center', 'dishwasher']:\n    df[w] = df['features'].str.contains(w)\ndf[['doorman', 'parking', 'garage', 'laundry']].head(5)\n```", "```py\ndf[\"num_desc_words\"] = df[\"description\"].apply(lambda x: len(x.split()))\ndf[\"num_features\"] = df[\"features\"].apply(lambda x: len(x.split(\",\")))\n\n```", "```py\ndf[\"num_photos\"] = df[\"photos\"].apply(lambda x: len(x.split(\",\")))\n\n```", "```py\ntextfeatures = [\n    'num_photos', 'num_desc_words', 'num_features',\n    'doorman', 'parking', 'garage', 'laundry', \n    'Elevator', 'fitness center', 'dishwasher',\n    'renov'\n]\nX, y = df[textfeatures+numfeatures], df['price']\nrf, oob = test(X, y)\n\n```", "```py\nshowimp(rf, X, y)\n```", "```py\ndf[\"beds_to_baths\"] = df[\"bedrooms\"]/(df[\"bathrooms\"]+1) # avoid div by 0\nX, y = df[['beds_to_baths']+numfeatures], df['price']\nrf, oob = test(X, y)\n\n```", "```py\ndf[\"beds_per_price\"] = df[\"bedrooms\"] / df[\"price\"]\nX, y = df[['beds_per_price']+numfeatures], df['price']\nrf, oob = test(X, y)\n\n```", "```py\nfrom sklearn.model_selection import train_test_split\ndf_train, df_test = train_test_split(df, test_size=0.20)\ndf_train = df_train.copy()\ndf_train['beds_per_price'] = df_train['bedrooms'] / df_train[\"price\"]\ndf_train[['beds_per_price','bedrooms']].head(5)\n```", "```py\nbpmap = dict(zip(df_train[\"bedrooms\"],df_train[\"beds_per_price\"]))\ndf_test = df_test.copy()\ndf_test[\"beds_per_price\"] = df_test[\"bedrooms\"].map(bpmap)\navg = np.mean(df_test['beds_per_price'])\ndf_test['beds_per_price'].fillna(avg, inplace=True)\nprint(df_test['beds_per_price'].head(5))\n```", "```py\nX_train, y_train = df_train[['beds_per_price']+numfeatures], df_train['price']\nX_test, y_test = df_test[['beds_per_price']+numfeatures], df_test['price']\n\nrf = RandomForestRegressor(n_estimators=100, n_jobs=-1)\nrf.fit(X_train, y_train)\noob_overfit = rf.score(X_test, y_test) # don't test training set\nprint(f\"OOB R^2 {oob_overfit:.5f}\")\nprint(f\"{rfnnodes(rf):,d} nodes, {np.median(rfmaxdepths(rf))} median height\")\n\n```", "```py\ndf.groupby('building_id').mean()[['price']].head(5)\n```", "```py\npip install category_encoders\n```", "```py\nfrom category_encoders.target_encoder import TargetEncoder\ndf = df.reset_index() # not sure why TargetEncoder needs this but it does\ntargetfeatures = ['building_id']\nencoder = TargetEncoder(cols=targetfeatures)\nencoder.fit(df, df['price'])\ndf_encoded = encoder.transform(df, df['price'])\n\nX, y = df_encoded[targetfeatures+numfeatures], df['price']\nrf, oob = test(X, y)\n\n```", "```py\ndf_train, df_test = train_test_split(df, test_size=0.20)\n\n# TargetEncoder needs the resets, not sure why\ndf_train = df_train.reset_index(drop=True)\ndf_test = df_test.reset_index(drop=True)\n\nX_train = df_train[numfeatures]\ny_train = df_train['price']\nX_test = df_test[numfeatures]\ny_test = df_test['price']\n\nrf = RandomForestRegressor(n_estimators=100, n_jobs=-1)\nrf.fit(X_train, y_train)\ns_validation = rf.score(X_test, y_test)\nprint(f\"{s_validation:4f} score {rfnnodes(rf):,d} tree nodes and {np.median(rfmaxdepths(rf))} median tree height\")\n\n```", "```py\nenc = TargetEncoder(cols=targetfeatures)\nenc.fit(df_train, df_train['price'])\ndf_train_encoded = enc.transform(df_train, df_train['price'])\ndf_test_encoded = enc.transform(df_test)\n\nX_train = df_train_encoded[targetfeatures+numfeatures]\ny_train = df_train_encoded['price']\nX_test = df_test_encoded[targetfeatures+numfeatures]\ny_test = df_test_encoded['price']\n\nrf = RandomForestRegressor(n_estimators=100, n_jobs=-1)\nrf.fit(X_train, y_train)\ns_tenc_validation = rf.score(X_test, y_test)\nprint(f\"{s_tenc_validation:.4f} score {rfnnodes(rf):,d} tree nodes and {np.median(rfmaxdepths(rf))} median tree height\")\n\n```", "```py\nhoods = {\n    \"hells\" : [40.7622, -73.9924],\n    \"astoria\" : [40.7796684, -73.9215888],\n    \"Evillage\" : [40.723163774, -73.984829394],\n    \"Wvillage\" : [40.73578, -74.00357],\n    \"LowerEast\" : [40.715033, -73.9842724],\n    \"UpperEast\" : [40.768163594, -73.959329496],\n    \"ParkSlope\" : [40.672404, -73.977063],\n    \"Prospect Park\" : [40.93704, -74.17431],\n    \"Crown Heights\" : [40.657830702, -73.940162906],\n    \"financial\" : [40.703830518, -74.005666644],\n    \"brooklynheights\" : [40.7022621909, -73.9871760513],\n    \"gowanus\" : [40.673, -73.997]\n}\n\n```", "```py\nfor hood,loc in hoods.items():\n    # compute manhattan distance\n    df[hood] = np.abs(df.latitude - loc[0]) + np.abs(df.longitude - loc[1])\n\n```", "```py\nhoodfeatures = list(hoods.keys())\nX, y = df[numfeatures+hoodfeatures], df['price']\nrf, oob_hood = test(X, y)\n\n```", "```py\nX = X.drop(['longitude','latitude'],axis=1)\nrf = RandomForestRegressor(n_estimators=100, n_jobs=-1, oob_score=True)\nrf.fit(X, y)\nprint(f\"{rf.oob_score_:.4f} score {rfnnodes(rf):,d} tree nodes and {np.median(rfmaxdepths(rf))} median tree height\")\n\n```", "```py\nX = df[['interest_level']+textfeatures+hoodfeatures+numfeatures]\nrf, oob_combined = test(X, y)\n\n```"]