- en: Spawning tasks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://rust-exercises.com/100-exercises/08_futures/02_spawn.html](https://rust-exercises.com/100-exercises/08_futures/02_spawn.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'Your solution to the previous exercise should look something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: This is not bad!
  prefs: []
  type: TYPE_NORMAL
- en: If a long time passes between two incoming connections, the `echo` function
    will be idle (since `TcpListener::accept` is an asynchronous function), thus allowing
    the executor to run other tasks in the meantime.
  prefs: []
  type: TYPE_NORMAL
- en: But how can we actually have multiple tasks running concurrently?
  prefs: []
  type: TYPE_NORMAL
- en: If we always run our asynchronous functions until completion (by using `.await`),
    we'll never have more than one task running at a time.
  prefs: []
  type: TYPE_NORMAL
- en: This is where the `tokio::spawn` function comes in.
  prefs: []
  type: TYPE_NORMAL
- en: '[`tokio::spawn`](#tokiospawn)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '`tokio::spawn` allows you to hand off a task to the executor, **without waiting
    for it to complete**.'
  prefs: []
  type: TYPE_NORMAL
- en: Whenever you invoke `tokio::spawn`, you're telling `tokio` to continue running
    the spawned task, in the background, **concurrently** with the task that spawned
    it.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here''s how you can use it to process multiple connections concurrently:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: '[Asynchronous blocks](#asynchronous-blocks)'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'In this example, we''ve passed an **asynchronous block** to `tokio::spawn`:
    `async move { /* */ }` Asynchronous blocks are a quick way to mark a region of
    code as asynchronous without having to define a separate async function.'
  prefs: []
  type: TYPE_NORMAL
- en: '[`JoinHandle`](#joinhandle)'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '`tokio::spawn` returns a `JoinHandle`.'
  prefs: []
  type: TYPE_NORMAL
- en: You can use `JoinHandle` to `.await` the background task, in the same way we
    used `join` for spawned threads.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: '[Panic boundary](#panic-boundary)'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If a task spawned with `tokio::spawn` panics, the panic will be caught by the
    executor.
  prefs: []
  type: TYPE_NORMAL
- en: If you don't `.await` the corresponding `JoinHandle`, the panic won't be propagated
    to the spawner. Even if you do `.await` the `JoinHandle`, the panic won't be propagated
    automatically. Awaiting a `JoinHandle` returns a `Result`, with [`JoinError`](https://docs.rs/tokio/latest/tokio/task/struct.JoinError.html)
    as its error type. You can then check if the task panicked by calling `JoinError::is_panic`
    and choose what to do with the panic—either log it, ignore it, or propagate it.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: '[`std::thread::spawn` vs `tokio::spawn`](#stdthreadspawn-vs-tokiospawn)'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You can think of `tokio::spawn` as the asynchronous sibling of `std::thread::spawn`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Notice a key difference: with `std::thread::spawn`, you''re delegating control
    to the OS scheduler. You''re not in control of how threads are scheduled.'
  prefs: []
  type: TYPE_NORMAL
- en: With `tokio::spawn`, you're delegating to an async executor that runs entirely
    in user space. The underlying OS scheduler is not involved in the decision of
    which task to run next. We're in charge of that decision now, via the executor
    we chose to use.
  prefs: []
  type: TYPE_NORMAL
- en: '[Exercise](#exercise)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The exercise for this section is located in [`08_futures/02_spawn`](https://github.com/mainmatter/100-exercises-to-learn-rust/tree/main/exercises/08_futures/02_spawn)
  prefs: []
  type: TYPE_NORMAL
