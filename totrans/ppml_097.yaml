- en: Cancellation
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://rust-exercises.com/100-exercises/08_futures/07_cancellation.html](https://rust-exercises.com/100-exercises/08_futures/07_cancellation.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: What happens when a pending future is dropped?
  prefs: []
  type: TYPE_NORMAL
- en: The runtime will no longer poll it, therefore it won't make any further progress.
    In other words, its execution has been **cancelled**.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the wild, this often happens when working with timeouts. For example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'When the timeout expires, the future returned by `http_call` will be cancelled.
    Let''s imagine that this is `http_call`''s body:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Each yield point becomes a **cancellation point**.
  prefs: []
  type: TYPE_NORMAL
- en: '`http_call` can''t be preempted by the runtime, so it can only be discarded
    after it has yielded control back to the executor via `.await`. This applies recursively—e.g.
    `stream.write_all(&request)` is likely to have multiple yield points in its implementation.
    It is perfectly possible to see `http_call` pushing a *partial* request before
    being cancelled, thus dropping the connection and never finishing transmitting
    the body.'
  prefs: []
  type: TYPE_NORMAL
- en: '[Clean up](#clean-up)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Rust's cancellation mechanism is quite powerful—it allows the caller to cancel
    an ongoing task without needing any form of cooperation from the task itself.
  prefs: []
  type: TYPE_NORMAL
- en: At the same time, this can be quite dangerous. It may be desirable to perform
    a **graceful cancellation**, to ensure that some clean-up tasks are performed
    before aborting the operation.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, consider this fictional API for a SQL transaction:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: On cancellation, it'd be ideal to explicitly abort the pending transaction rather
    than leaving it hanging. Rust, unfortunately, doesn't provide a bullet-proof mechanism
    for this kind of **asynchronous** clean up operations.
  prefs: []
  type: TYPE_NORMAL
- en: 'The most common strategy is to rely on the `Drop` trait to schedule the required
    clean-up work. This can be by:'
  prefs: []
  type: TYPE_NORMAL
- en: Spawning a new task on the runtime
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Enqueueing a message on a channel
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Spawning a background thread
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The optimal choice is contextual.
  prefs: []
  type: TYPE_NORMAL
- en: '[Cancelling spawned tasks](#cancelling-spawned-tasks)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: When you spawn a task using `tokio::spawn`, you can no longer drop it; it belongs
    to the runtime.
  prefs: []
  type: TYPE_NORMAL
- en: 'Nonetheless, you can use its `JoinHandle` to cancel it if needed:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: '[Further reading](#further-reading)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Be extremely careful when using `tokio`'s `select!` macro to "race" two different
    futures. Retrying the same task in a loop is dangerous unless you can ensure **cancellation
    safety**. Check out [`select!`'s documentation](https://tokio.rs/tokio/tutorial/select)
    for more details.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you need to interleave two asynchronous streams of data (e.g. a socket and
    a channel), prefer using [`StreamExt::merge`](https://docs.rs/tokio-stream/latest/tokio_stream/trait.StreamExt.html#method.merge)
    instead.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: A [`CancellationToken`](https://docs.rs/tokio-util/latest/tokio_util/sync/struct.CancellationToken.html)
    may be preferable to `JoinHandle::abort` in some cases.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Exercise](#exercise)'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The exercise for this section is located in [`08_futures/07_cancellation`](https://github.com/mainmatter/100-exercises-to-learn-rust/tree/main/exercises/08_futures/07_cancellation)
  prefs: []
  type: TYPE_NORMAL
